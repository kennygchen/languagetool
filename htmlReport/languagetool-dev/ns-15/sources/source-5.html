


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ConfigurationDialog</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.languagetool.gui</a>
</div>

<h1>Coverage Summary for Class: ConfigurationDialog (org.languagetool.gui)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ConfigurationDialog</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/75)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/414)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1360)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ConfigurationDialog$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$10</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$11</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$12</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$13</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$14</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$15</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$8</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$9</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationDialog$CategoryComparator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/131)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/548)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1586)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/* LanguageTool, a natural language style checker 
&nbsp; * Copyright (C) 2005 Daniel Naber (http://www.danielnaber.de)
&nbsp; * 
&nbsp; * This library is free software; you can redistribute it and/or
&nbsp; * modify it under the terms of the GNU Lesser General Public
&nbsp; * License as published by the Free Software Foundation; either
&nbsp; * version 2.1 of the License, or (at your option) any later version.
&nbsp; *
&nbsp; * This library is distributed in the hope that it will be useful,
&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
&nbsp; * Lesser General Public License for more details.
&nbsp; *
&nbsp; * You should have received a copy of the GNU Lesser General Public
&nbsp; * License along with this library; if not, write to the Free Software
&nbsp; * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301
&nbsp; * USA
&nbsp; */
&nbsp;package org.languagetool.gui;
&nbsp;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.jetbrains.annotations.NotNull;
&nbsp;import org.jetbrains.annotations.Nullable;
&nbsp;import org.languagetool.JLanguageTool;
&nbsp;import org.languagetool.Language;
&nbsp;import org.languagetool.Languages;
&nbsp;import org.languagetool.languagemodel.LuceneLanguageModel;
&nbsp;import org.languagetool.rules.Rule;
&nbsp;import org.languagetool.rules.RuleOption;
&nbsp;
&nbsp;import javax.swing.*;
&nbsp;import javax.swing.event.DocumentEvent;
&nbsp;import javax.swing.event.DocumentListener;
&nbsp;import javax.swing.event.TreeModelEvent;
&nbsp;import javax.swing.event.TreeModelListener;
&nbsp;import javax.swing.tree.DefaultMutableTreeNode;
&nbsp;import javax.swing.tree.DefaultTreeModel;
&nbsp;import javax.swing.tree.TreeNode;
&nbsp;import javax.swing.tree.TreePath;
&nbsp;import java.awt.*;
&nbsp;import java.awt.event.*;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.text.MessageFormat;
&nbsp;import java.util.*;
&nbsp;import java.util.List;
&nbsp;
&nbsp;/**
&nbsp; * Dialog that offers the available rules so they can be turned on/off
&nbsp; * individually.
&nbsp; * 
&nbsp; * @author Daniel Naber
&nbsp; */
&nbsp;public class ConfigurationDialog implements ActionListener {
&nbsp;
&nbsp;  private static final String NO_SELECTED_LANGUAGE = &quot;---&quot;;
&nbsp;  private static final String ACTION_COMMAND_OK = &quot;OK&quot;;
&nbsp;  private static final String ACTION_COMMAND_CANCEL = &quot;CANCEL&quot;;
&nbsp;  private static final int MAX_PORT = 65536;
&nbsp;
&nbsp;  private static final int SHIFT1 = 4;
&nbsp;  private static final int SHIFT2 = 20;
&nbsp;  private static final int SHIFT3 = 44;
&nbsp;
&nbsp;  private final ResourceBundle messages;
&nbsp;  private final Configuration original;
&nbsp;  private final Configuration config;
&nbsp;  private final Frame owner;
&nbsp;  private final boolean insideOffice;
&nbsp;  private final Image ltImage;
&nbsp;  private String dialogTitle;
<b class="nc">&nbsp;  private boolean configChanged = false;</b>
<b class="nc">&nbsp;  private boolean profileChanged = true;</b>
<b class="nc">&nbsp;  private boolean restartShow = false;</b>
<b class="nc">&nbsp;  private boolean firstSelection = true;</b>
&nbsp;
&nbsp;  private JDialog dialog;
&nbsp;  private JCheckBox serverCheckbox;
&nbsp;  private JTextField serverPortField;
&nbsp;  private JTree[] configTree;
&nbsp;  private DefaultMutableTreeNode[] rootNode;
&nbsp;  private JCheckBox serverSettingsCheckbox;
&nbsp;  private JPanel disabledRulesPanel;
&nbsp;  private JPanel enabledRulesPanel;
<b class="nc">&nbsp;  private final List&lt;JPanel&gt; extraPanels = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;  private final List&lt;Rule&gt; configurableRules = new ArrayList&lt;&gt;();</b>
&nbsp;  private String category;
&nbsp;  private Rule rule;
&nbsp;
&nbsp;  public ConfigurationDialog(Frame owner, boolean insideOffice, Configuration config) {
<b class="nc">&nbsp;    this(owner, insideOffice, null, null, config);</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  public ConfigurationDialog(Frame owner, boolean insideOffice, Image ltImage, String title, Configuration config) {</b>
<b class="nc">&nbsp;    this.owner = owner;</b>
<b class="nc">&nbsp;    this.insideOffice = insideOffice;</b>
<b class="nc">&nbsp;    this.original = config;</b>
<b class="nc">&nbsp;    this.config = original.copy(original);</b>
<b class="nc">&nbsp;    this.ltImage = ltImage;</b>
<b class="nc">&nbsp;    dialogTitle = title;</b>
<b class="nc">&nbsp;    messages = JLanguageTool.getMessageBundle();</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Add extra JPanel to this dialog.
&nbsp;   * 
&nbsp;   * If the panel implements {@see SavablePanel}, this dialog will call
&nbsp;   * {@link SavablePanel#save} after the user clicks OK.
&nbsp;   * 
&nbsp;   * @param panel the JPanel to be added to this dialog
&nbsp;   * @since 3.4
&nbsp;   */
&nbsp;  void addExtraPanel(JPanel panel) {
<b class="nc">&nbsp;    extraPanels.add(panel);</b>
&nbsp;  }
&nbsp;
&nbsp;  private DefaultMutableTreeNode createTree(List&lt;Rule&gt; rules, boolean isStyle, String tabName, DefaultMutableTreeNode root) {
<b class="nc">&nbsp;    if (root == null) {</b>
<b class="nc">&nbsp;      root = new DefaultMutableTreeNode(&quot;Rules&quot;);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      root.removeAllChildren();</b>
&nbsp;    }
<b class="nc">&nbsp;    String lastRuleId = null;</b>
<b class="nc">&nbsp;    Map&lt;String, DefaultMutableTreeNode&gt; parents = new TreeMap&lt;&gt;();</b>
<b class="nc">&nbsp;    for (Rule rule : rules) {</b>
<b class="nc">&nbsp;      if((tabName == null &amp;&amp; !config.isSpecialTabCategory(rule.getCategory().getName()) &amp;&amp;</b>
<b class="nc">&nbsp;          ((isStyle &amp;&amp; config.isStyleCategory(rule.getCategory().getName())) ||</b>
<b class="nc">&nbsp;         (!isStyle &amp;&amp; !config.isStyleCategory(rule.getCategory().getName())))) || </b>
<b class="nc">&nbsp;          (tabName != null &amp;&amp; config.isInSpecialTab(rule.getCategory().getName(), tabName))) {</b>
<b class="nc">&nbsp;        if (!parents.containsKey(rule.getCategory().getName())) {</b>
<b class="nc">&nbsp;          boolean enabled = true;</b>
<b class="nc">&nbsp;          if (config.getDisabledCategoryNames() != null &amp;&amp; config.getDisabledCategoryNames().contains(rule.getCategory().getName())) {</b>
<b class="nc">&nbsp;            enabled = false;</b>
&nbsp;          }
<b class="nc">&nbsp;          if(rule.getCategory().isDefaultOff() &amp;&amp; (config.getEnabledCategoryNames() == null </b>
<b class="nc">&nbsp;              || !config.getEnabledCategoryNames().contains(rule.getCategory().getName()))) {</b>
<b class="nc">&nbsp;            enabled = false;</b>
&nbsp;          }
<b class="nc">&nbsp;          DefaultMutableTreeNode categoryNode = new CategoryNode(rule.getCategory(), enabled);</b>
<b class="nc">&nbsp;          root.add(categoryNode);</b>
<b class="nc">&nbsp;          parents.put(rule.getCategory().getName(), categoryNode);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!rule.getId().equals(lastRuleId)) {</b>
<b class="nc">&nbsp;          RuleNode ruleNode = new RuleNode(rule, getEnabledState(rule));</b>
<b class="nc">&nbsp;          parents.get(rule.getCategory().getName()).add(ruleNode);</b>
&nbsp;        }
<b class="nc">&nbsp;        lastRuleId = rule.getId();</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return root;</b>
&nbsp;  }
&nbsp;
&nbsp;  private boolean getEnabledState(Rule rule) {
<b class="nc">&nbsp;    boolean ret = true;</b>
<b class="nc">&nbsp;    if (config.getDisabledRuleIds().contains(rule.getId())) {</b>
<b class="nc">&nbsp;      ret = false;</b>
&nbsp;    }
<b class="nc">&nbsp;    if (config.getDisabledCategoryNames().contains(rule.getCategory().getName())) {</b>
<b class="nc">&nbsp;      ret = false;</b>
&nbsp;    }
<b class="nc">&nbsp;    if ((rule.isDefaultOff() || rule.getCategory().isDefaultOff()) &amp;&amp; !config.getEnabledRuleIds().contains(rule.getId())) {</b>
<b class="nc">&nbsp;      ret = false;</b>
&nbsp;    }
<b class="nc">&nbsp;    if (insideOffice &amp;&amp; rule.isOfficeDefaultOff() &amp;&amp; !config.getEnabledRuleIds().contains(rule.getId())) {</b>
<b class="nc">&nbsp;      ret = false;</b>
&nbsp;    }
<b class="nc">&nbsp;    if (insideOffice &amp;&amp; rule.isOfficeDefaultOn() &amp;&amp; !config.getDisabledRuleIds().contains(rule.getId())) {</b>
<b class="nc">&nbsp;      ret = true;</b>
&nbsp;    }
<b class="nc">&nbsp;    if (rule.isDefaultOff() &amp;&amp; rule.getCategory().isDefaultOff()</b>
<b class="nc">&nbsp;            &amp;&amp; config.getEnabledRuleIds().contains(rule.getId())) {</b>
<b class="nc">&nbsp;      config.getDisabledCategoryNames().remove(rule.getCategory().getName());</b>
&nbsp;    }
<b class="nc">&nbsp;    return ret;</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean show(List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    restartShow = false;</b>
&nbsp;    do {
<b class="nc">&nbsp;      showPanel(rules);</b>
<b class="nc">&nbsp;    } while (restartShow);</b>
<b class="nc">&nbsp;    return configChanged;</b>
&nbsp;  }
&nbsp;    
&nbsp;  public void close() {
<b class="nc">&nbsp;    dialog.setVisible(false);</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean showPanel(List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    configChanged = false;</b>
<b class="nc">&nbsp;    if (original != null &amp;&amp; !restartShow) {</b>
<b class="nc">&nbsp;      config.restoreState(original);</b>
&nbsp;    }
<b class="nc">&nbsp;    restartShow = false;</b>
<b class="nc">&nbsp;    dialog = new JDialog(owner, true);</b>
<b class="nc">&nbsp;    if (dialogTitle == null) {</b>
<b class="nc">&nbsp;      dialogTitle = messages.getString(&quot;guiConfigWindowTitle&quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    dialog.setTitle(dialogTitle);</b>
<b class="nc">&nbsp;    if (ltImage != null) {</b>
<b class="nc">&nbsp;      ((Frame) dialog.getOwner()).setIconImage(ltImage);</b>
&nbsp;    }
&nbsp;    // close dialog when user presses Escape key:
<b class="nc">&nbsp;    KeyStroke stroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</b>
<b class="nc">&nbsp;    ActionListener actionListener = actionEvent -&gt; dialog.setVisible(false);</b>
<b class="nc">&nbsp;    JRootPane rootPane = dialog.getRootPane();</b>
<b class="nc">&nbsp;    rootPane.registerKeyboardAction(actionListener, stroke,</b>
&nbsp;        JComponent.WHEN_IN_FOCUSED_WINDOW);
&nbsp;
<b class="nc">&nbsp;    configurableRules.clear();</b>
&nbsp;
<b class="nc">&nbsp;    Language lang = config.getLanguage();</b>
<b class="nc">&nbsp;    if (lang == null) {</b>
<b class="nc">&nbsp;      lang = Languages.getLanguageForLocale(Locale.getDefault());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    String[] specialTabNames = config.getSpecialTabNames();</b>
<b class="nc">&nbsp;    int numConfigTrees = 2 + specialTabNames.length;</b>
<b class="nc">&nbsp;    configTree = new JTree[numConfigTrees];</b>
<b class="nc">&nbsp;    rootNode = new DefaultMutableTreeNode[numConfigTrees];</b>
<b class="nc">&nbsp;    JPanel[] checkBoxPanel = new JPanel[numConfigTrees];</b>
&nbsp;    GridBagConstraints cons;
&nbsp;
<b class="nc">&nbsp;    for (int i = 0; i &lt; numConfigTrees; i++) {</b>
<b class="nc">&nbsp;      checkBoxPanel[i] = new JPanel();</b>
<b class="nc">&nbsp;      cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;      checkBoxPanel[i].setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;      cons.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;      cons.gridx = 0;</b>
<b class="nc">&nbsp;      cons.weightx = 1.0;</b>
<b class="nc">&nbsp;      cons.weighty = 1.0;</b>
<b class="nc">&nbsp;      cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;      Collections.sort(rules, new CategoryComparator());</b>
<b class="nc">&nbsp;      if(i == 0) {</b>
<b class="nc">&nbsp;        rootNode[i] = createTree(rules, false, null, null);   //  grammar options</b>
<b class="nc">&nbsp;      } else if(i == 1) {</b>
<b class="nc">&nbsp;        rootNode[i] = createTree(rules, true, null, null);    //  Style options</b>
&nbsp;      } else {
<b class="nc">&nbsp;        rootNode[i] = createTree(rules, true, specialTabNames[i - 2], null);    //  Special tab options</b>
&nbsp;      }
<b class="nc">&nbsp;      configTree[i] = new JTree(getTreeModel(rootNode[i], rules));</b>
&nbsp;      
<b class="nc">&nbsp;      configTree[i].applyComponentOrientation(ComponentOrientation.getOrientation(lang.getLocale()));</b>
&nbsp;  
<b class="nc">&nbsp;      configTree[i].setRootVisible(false);</b>
<b class="nc">&nbsp;      configTree[i].setEditable(false);</b>
<b class="nc">&nbsp;      configTree[i].setCellRenderer(new CheckBoxTreeCellRenderer());</b>
<b class="nc">&nbsp;      TreeListener.install(configTree[i]);</b>
<b class="nc">&nbsp;      checkBoxPanel[i].add(configTree[i], cons);</b>
<b class="nc">&nbsp;      configTree[i].addMouseListener(getMouseAdapter());</b>
&nbsp;    }
&nbsp;    
&nbsp;
<b class="nc">&nbsp;    JPanel portPanel = new JPanel();</b>
<b class="nc">&nbsp;    portPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT1, 0, 0);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    if (!insideOffice) {</b>
<b class="nc">&nbsp;      createNonOfficeElements(cons, portPanel);</b>
&nbsp;    }
&nbsp;    else {
<b class="nc">&nbsp;      createOfficeElements(cons, portPanel);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    JPanel buttonPanel = new JPanel();</b>
<b class="nc">&nbsp;    buttonPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    JButton okButton = new JButton(Tools.getLabel(messages.getString(&quot;guiOKButton&quot;)));</b>
<b class="nc">&nbsp;    okButton.setMnemonic(Tools.getMnemonic(messages.getString(&quot;guiOKButton&quot;)));</b>
<b class="nc">&nbsp;    okButton.setActionCommand(ACTION_COMMAND_OK);</b>
<b class="nc">&nbsp;    okButton.addActionListener(this);</b>
<b class="nc">&nbsp;    JButton cancelButton = new JButton(Tools.getLabel(messages.getString(&quot;guiCancelButton&quot;)));</b>
<b class="nc">&nbsp;    cancelButton.setMnemonic(Tools.getMnemonic(messages.getString(&quot;guiCancelButton&quot;)));</b>
<b class="nc">&nbsp;    cancelButton.setActionCommand(ACTION_COMMAND_CANCEL);</b>
<b class="nc">&nbsp;    cancelButton.addActionListener(this);</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT1, 0, 0);</b>
<b class="nc">&nbsp;    buttonPanel.add(okButton, cons);</b>
<b class="nc">&nbsp;    buttonPanel.add(cancelButton, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JTabbedPane tabpane = new JTabbedPane();</b>
&nbsp;
&nbsp;//  Profile tab    
<b class="nc">&nbsp;    JPanel jProfilePane = new JPanel();</b>
<b class="nc">&nbsp;    jProfilePane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 4, 4, 4);</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 10.0f;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;    
<b class="nc">&nbsp;    jProfilePane.add(new JScrollPane(getProfilePanel(rules)), cons);</b>
&nbsp;    
&nbsp;    //  Disabled default rules
<b class="nc">&nbsp;    cons.weighty = 1.0f;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.insets = new Insets(16, 4, 0, 8);</b>
<b class="nc">&nbsp;    jProfilePane.add(new JLabel(addColonToMessageString(&quot;guiDisabledDefaultRules&quot;)), cons);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(8, 4, 0, 8);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.weighty = 3.0f;</b>
<b class="nc">&nbsp;    disabledRulesPanel = getChangedRulesPanel(rules, false, null);</b>
<b class="nc">&nbsp;    jProfilePane.add(new JScrollPane(disabledRulesPanel), cons);</b>
&nbsp;    
&nbsp;    //  Enabled optional rules
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.insets = new Insets(16, 4, 0, 8);</b>
<b class="nc">&nbsp;    cons.weighty = 1.0f;</b>
<b class="nc">&nbsp;    jProfilePane.add(new JLabel(addColonToMessageString(&quot;guiEnabledOptionalRules&quot;)), cons);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(8, 4, 0, 8);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.weighty = 5.0f;</b>
<b class="nc">&nbsp;    enabledRulesPanel = getChangedRulesPanel(rules, true, null);</b>
<b class="nc">&nbsp;    jProfilePane.add(new JScrollPane(enabledRulesPanel), cons);</b>
<b class="nc">&nbsp;    jProfilePane.setName(messages.getString(&quot;guiProfiles&quot;));</b>
&nbsp;    
&nbsp;//  General tab
<b class="nc">&nbsp;    JPanel jPane = new JPanel();</b>
<b class="nc">&nbsp;    jPane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 4, 4, 4);</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 0.0f;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;
<b class="nc">&nbsp;    if(!insideOffice) {</b>
<b class="nc">&nbsp;      cons.gridy++;</b>
<b class="nc">&nbsp;      cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;      jPane.add(getMotherTonguePanel(cons), cons);</b>
<b class="nc">&nbsp;      cons.gridx = 0;</b>
<b class="nc">&nbsp;      cons.gridy++;</b>
<b class="nc">&nbsp;      jPane.add(getNgramPanel(), cons);</b>
&nbsp;    }
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    jPane.add(portPanel, cons);</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    for(JPanel extra : extraPanels) {</b>
&nbsp;      //in case it wasn&#39;t in a containment hierarchy when user changed L&amp;F
<b class="nc">&nbsp;      SwingUtilities.updateComponentTreeUI(extra);</b>
<b class="nc">&nbsp;      cons.gridy++;</b>
<b class="nc">&nbsp;      jPane.add(extra, cons);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    cons.weighty = 1.0f;</b>
<b class="nc">&nbsp;    jPane.add(new JPanel(), cons);</b>
<b class="nc">&nbsp;    tabpane.addTab(messages.getString(&quot;guiGeneral&quot;), new JScrollPane(jPane));</b>
&nbsp;
&nbsp;//  Grammar rules tab    
<b class="nc">&nbsp;    jPane = new JPanel();</b>
<b class="nc">&nbsp;    jPane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 10.0f;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    jPane.add(new JScrollPane(checkBoxPanel[0]), cons);</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 0.0f;</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.LINE_END;</b>
<b class="nc">&nbsp;    jPane.add(getTreeButtonPanel(0), cons);</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    jPane.add(getRuleOptionsPanel(0), cons);</b>
&nbsp;
<b class="nc">&nbsp;    tabpane.addTab(messages.getString(&quot;guiGrammarRules&quot;), jPane);</b>
&nbsp;    
&nbsp;//  Style rules tab    
<b class="nc">&nbsp;    jPane = new JPanel();</b>
<b class="nc">&nbsp;    jPane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 10.0f;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    jPane.add(new JScrollPane(checkBoxPanel[1]), cons);</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 0.0f;</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.LINE_END;</b>
<b class="nc">&nbsp;    jPane.add(getTreeButtonPanel(1), cons);</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    jPane.add(getRuleOptionsPanel(1), cons);</b>
&nbsp;
<b class="nc">&nbsp;    tabpane.addTab(messages.getString(&quot;guiStyleRules&quot;), jPane);</b>
&nbsp;
&nbsp;//  Style special tabs (optional)
<b class="nc">&nbsp;    for (int i = 0; i &lt; specialTabNames.length; i++) {</b>
<b class="nc">&nbsp;      jPane = new JPanel();</b>
<b class="nc">&nbsp;      jPane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;      cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;      cons.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;      cons.gridx = 0;</b>
<b class="nc">&nbsp;      cons.gridy = 0;</b>
<b class="nc">&nbsp;      cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;      cons.weighty = 10.0f;</b>
<b class="nc">&nbsp;      cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;      jPane.add(new JScrollPane(checkBoxPanel[i + 2]), cons);</b>
<b class="nc">&nbsp;      cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;      cons.weighty = 0.0f;</b>
&nbsp;  
<b class="nc">&nbsp;      cons.gridx = 0;</b>
<b class="nc">&nbsp;      cons.gridy++;</b>
<b class="nc">&nbsp;      cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;      cons.anchor = GridBagConstraints.LINE_END;</b>
<b class="nc">&nbsp;      jPane.add(getTreeButtonPanel(i + 2), cons);</b>
&nbsp;  
<b class="nc">&nbsp;      cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;      cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;      cons.gridx = 0;</b>
<b class="nc">&nbsp;      cons.gridy++;</b>
<b class="nc">&nbsp;      jPane.add(getRuleOptionsPanel(i + 2), cons);</b>
&nbsp;
<b class="nc">&nbsp;      tabpane.addTab(specialTabNames[i], jPane);</b>
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    if(insideOffice) {</b>
&nbsp;      //    technical options tab (only office)
<b class="nc">&nbsp;      String label = messages.getString(&quot;guiTechnicalSettings&quot;);</b>
<b class="nc">&nbsp;      if (label.endsWith(&quot;:&quot;)) {</b>
<b class="nc">&nbsp;        label = label.substring(0, label.length() - 1);</b>
&nbsp;      }
<b class="nc">&nbsp;      tabpane.add(label, new JScrollPane(getOfficeTechnicalElements()));</b>
&nbsp;      
&nbsp;      //    AI options tab (only office)
<b class="nc">&nbsp;      label = messages.getString(&quot;guiAiSupportSettings&quot;);</b>
<b class="nc">&nbsp;      tabpane.add(label, new JScrollPane(getOfficeAiElements()));</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Container contentPane = dialog.getContentPane();</b>
<b class="nc">&nbsp;    contentPane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 10.0f;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;    contentPane.add(tabpane, cons);</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 0.0f;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.EAST;</b>
<b class="nc">&nbsp;    contentPane.add(buttonPanel, cons);</b>
&nbsp;
<b class="nc">&nbsp;    dialog.pack();</b>
&nbsp;    // center on screen:
<b class="nc">&nbsp;    Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</b>
<b class="nc">&nbsp;    Dimension frameSize = dialog.getSize();</b>
<b class="nc">&nbsp;    dialog.setLocation(screenSize.width / 2 - frameSize.width / 2,</b>
&nbsp;        screenSize.height / 2 - frameSize.height / 2);
<b class="nc">&nbsp;    dialog.setLocationByPlatform(true);</b>
&nbsp;    //  add Profile tab after dimension was set
<b class="nc">&nbsp;    tabpane.add(jProfilePane, 0);</b>
<b class="nc">&nbsp;    tabpane.setSelectedIndex(0);</b>
<b class="nc">&nbsp;    for(JPanel extra : this.extraPanels) {</b>
<b class="nc">&nbsp;      if(extra instanceof SavablePanel) {</b>
<b class="nc">&nbsp;        ((SavablePanel) extra).componentShowing();</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    dialog.setAutoRequestFocus(true);</b>
&nbsp;    
<b class="nc">&nbsp;    if(insideOffice) {</b>
<b class="nc">&nbsp;      dialog.setAlwaysOnTop(true);</b>
&nbsp;    }
<b class="nc">&nbsp;    dialog.setVisible(true);</b>
<b class="nc">&nbsp;    dialog.toFront();</b>
<b class="nc">&nbsp;    return configChanged;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void createNonOfficeElements(GridBagConstraints cons, JPanel portPanel) {
<b class="nc">&nbsp;    serverCheckbox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiRunOnPort&quot;)));</b>
<b class="nc">&nbsp;    serverCheckbox.setMnemonic(Tools.getMnemonic(messages.getString(&quot;guiRunOnPort&quot;)));</b>
<b class="nc">&nbsp;    serverCheckbox.setSelected(config.getRunServer());</b>
<b class="nc">&nbsp;    portPanel.add(serverCheckbox, cons);</b>
<b class="nc">&nbsp;    serverCheckbox.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      serverPortField.setEnabled(serverCheckbox.isSelected());</b>
<b class="nc">&nbsp;      serverSettingsCheckbox.setEnabled(serverCheckbox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    serverCheckbox.addItemListener(e -&gt; config.setRunServer(serverCheckbox.isSelected()));</b>
&nbsp;
<b class="nc">&nbsp;    serverPortField = new JTextField(Integer.toString(config.getServerPort()));</b>
<b class="nc">&nbsp;    serverPortField.setEnabled(serverCheckbox.isSelected());</b>
<b class="nc">&nbsp;    serverSettingsCheckbox = new JCheckBox(Tools.getLabel(messages.getString(&quot;useGUIConfig&quot;)));</b>
<b class="nc">&nbsp;    serverPortField.setMinimumSize(new Dimension(100, 25));  // without this the box is just a few pixels small, but why?</b>
<b class="nc">&nbsp;    cons.gridx = 1;</b>
<b class="nc">&nbsp;    portPanel.add(serverPortField, cons);</b>
<b class="nc">&nbsp;    serverPortField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
&nbsp;        try {
<b class="nc">&nbsp;          int serverPort = Integer.parseInt(serverPortField.getText());</b>
<b class="nc">&nbsp;          if (serverPort &gt; -1 &amp;&amp; serverPort &lt; MAX_PORT) {</b>
<b class="nc">&nbsp;            serverPortField.setForeground(null);</b>
<b class="nc">&nbsp;            config.setServerPort(serverPort);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            serverPortField.setForeground(Color.RED);</b>
&nbsp;          }
&nbsp;        } catch (NumberFormatException ex) {
<b class="nc">&nbsp;          serverPortField.setForeground(Color.RED);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 10;</b>
<b class="nc">&nbsp;    serverSettingsCheckbox.setMnemonic(Tools.getMnemonic(messages.getString(&quot;useGUIConfig&quot;)));</b>
<b class="nc">&nbsp;    serverSettingsCheckbox.setSelected(config.getUseGUIConfig());</b>
<b class="nc">&nbsp;    serverSettingsCheckbox.setEnabled(config.getRunServer());</b>
<b class="nc">&nbsp;    serverSettingsCheckbox.addItemListener(e -&gt; config.setUseGUIConfig(serverSettingsCheckbox.isSelected()));</b>
<b class="nc">&nbsp;    portPanel.add(serverSettingsCheckbox, cons);</b>
&nbsp;  }
&nbsp;  
&nbsp;  private void addOfficeLanguageElements(GridBagConstraints cons, JPanel portPanel) {
<b class="nc">&nbsp;    JPanel languagePanel = new JPanel();</b>
<b class="nc">&nbsp;    languagePanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, 0, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    JRadioButton[] radioButtons = new JRadioButton[2];</b>
<b class="nc">&nbsp;    ButtonGroup numParaGroup = new ButtonGroup();</b>
<b class="nc">&nbsp;    radioButtons[0] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiUseDocumentLanguage&quot;)));</b>
<b class="nc">&nbsp;    radioButtons[0].setActionCommand(&quot;DocLang&quot;);</b>
<b class="nc">&nbsp;    radioButtons[0].setSelected(true);</b>
&nbsp;
<b class="nc">&nbsp;    radioButtons[1] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiSetLanguageTo&quot;)));</b>
<b class="nc">&nbsp;    radioButtons[1].setActionCommand(&quot;SelectLang&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    JComboBox&lt;String&gt; fixedLanguageBox = new JComboBox&lt;&gt;(getPossibleLanguages(false));</b>
<b class="nc">&nbsp;    if (config.getFixedLanguage() != null) {</b>
<b class="nc">&nbsp;      fixedLanguageBox.setSelectedItem(config.getFixedLanguage().getTranslatedName(messages));</b>
&nbsp;    }
<b class="nc">&nbsp;    fixedLanguageBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      if (e.getStateChange() == ItemEvent.SELECTED) {</b>
&nbsp;        Language fixedLanguage;
<b class="nc">&nbsp;        if (fixedLanguageBox.getSelectedItem() instanceof String) {</b>
<b class="nc">&nbsp;          fixedLanguage = getLanguageForLocalizedName(fixedLanguageBox.getSelectedItem().toString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;          fixedLanguage = (Language) fixedLanguageBox.getSelectedItem();</b>
&nbsp;        }
<b class="nc">&nbsp;        config.setFixedLanguage(fixedLanguage);</b>
<b class="nc">&nbsp;        config.setUseDocLanguage(false);</b>
<b class="nc">&nbsp;        radioButtons[1].setSelected(true);</b>
&nbsp;      }
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    for (int i = 0; i &lt; 2; i++) {</b>
<b class="nc">&nbsp;      numParaGroup.add(radioButtons[i]);</b>
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    if (config.getUseDocLanguage()) {</b>
<b class="nc">&nbsp;      radioButtons[0].setSelected(true);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      radioButtons[1].setSelected(true);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    radioButtons[0].addActionListener(e -&gt; config.setUseDocLanguage(true));</b>
&nbsp;    
<b class="nc">&nbsp;    radioButtons[1].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setUseDocLanguage(false);</b>
&nbsp;      Language fixedLanguage;
<b class="nc">&nbsp;      if (fixedLanguageBox.getSelectedItem() instanceof String) {</b>
<b class="nc">&nbsp;        fixedLanguage = getLanguageForLocalizedName(fixedLanguageBox.getSelectedItem().toString());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        fixedLanguage = (Language) fixedLanguageBox.getSelectedItem();</b>
&nbsp;      }
<b class="nc">&nbsp;      config.setFixedLanguage(fixedLanguage);</b>
&nbsp;    });
<b class="nc">&nbsp;    languagePanel.add(radioButtons[0], cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    languagePanel.add(radioButtons[1], cons1);</b>
<b class="nc">&nbsp;    cons1.gridx = 1;</b>
<b class="nc">&nbsp;    languagePanel.add(fixedLanguageBox, cons1);</b>
&nbsp;
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT1, 0, 0);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(languagePanel, cons);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void addOfficeTextruleElements(GridBagConstraints cons, JPanel portPanel) {
<b class="nc">&nbsp;    int numParaCheck = config.getNumParasToCheck();</b>
<b class="nc">&nbsp;    boolean useTextLevelQueue = config.useTextLevelQueue();</b>
<b class="nc">&nbsp;    JRadioButton[] radioButtons = new JRadioButton[3];</b>
<b class="nc">&nbsp;    ButtonGroup numParaGroup = new ButtonGroup();</b>
<b class="nc">&nbsp;    radioButtons[0] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiTextCheckMode&quot;)));</b>
<b class="nc">&nbsp;    radioButtons[0].setActionCommand(&quot;FullTextCheck&quot;);</b>
&nbsp;    
<b class="nc">&nbsp;    radioButtons[1] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiParagraphCheckMode&quot;)));</b>
<b class="nc">&nbsp;    radioButtons[1].setActionCommand(&quot;ParagraphCheck&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    radioButtons[2] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiDeveloperModeCheck&quot;)));</b>
<b class="nc">&nbsp;    radioButtons[2].setActionCommand(&quot;NParagraphCheck&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    JTextField numParaField = new JTextField(Integer.toString(5), 2);</b>
<b class="nc">&nbsp;    numParaField.setEnabled(radioButtons[2].isSelected());</b>
<b class="nc">&nbsp;    numParaField.setMinimumSize(new Dimension(30, 25));</b>
&nbsp;    
<b class="nc">&nbsp;    for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;      numParaGroup.add(radioButtons[i]);</b>
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    if (numParaCheck == 0 || config.onlySingleParagraphMode()) {</b>
<b class="nc">&nbsp;      radioButtons[1].setSelected(true);</b>
<b class="nc">&nbsp;      numParaField.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setUseTextLevelQueue(false);</b>
<b class="nc">&nbsp;      if (config.onlySingleParagraphMode()) {</b>
<b class="nc">&nbsp;        radioButtons[0].setEnabled(false);</b>
<b class="nc">&nbsp;        radioButtons[2].setEnabled(false);</b>
&nbsp;      }
<b class="nc">&nbsp;    } else if (useTextLevelQueue) {</b>
<b class="nc">&nbsp;      radioButtons[0].setSelected(true);</b>
<b class="nc">&nbsp;      numParaField.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setNumParasToCheck(-2);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      radioButtons[2].setSelected(true);</b>
<b class="nc">&nbsp;      numParaField.setText(Integer.toString(numParaCheck));</b>
<b class="nc">&nbsp;      numParaField.setEnabled(true);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    radioButtons[0].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      numParaField.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setNumParasToCheck(-2);</b>
<b class="nc">&nbsp;      config.setUseTextLevelQueue(true);</b>
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    radioButtons[1].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      numParaField.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setNumParasToCheck(0);</b>
<b class="nc">&nbsp;      config.setUseTextLevelQueue(false);</b>
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    radioButtons[2].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      int numParaCheck1 = Integer.parseInt(numParaField.getText());</b>
<b class="nc">&nbsp;      if (numParaCheck1 &lt; -2) numParaCheck1 = -2;</b>
<b class="nc">&nbsp;      else if (numParaCheck1 &gt; 99) numParaCheck1 = 99;</b>
<b class="nc">&nbsp;      config.setNumParasToCheck(numParaCheck1);</b>
<b class="nc">&nbsp;      numParaField.setForeground(Color.BLACK);</b>
<b class="nc">&nbsp;      numParaField.setText(Integer.toString(numParaCheck1));</b>
<b class="nc">&nbsp;      numParaField.setEnabled(true);</b>
<b class="nc">&nbsp;      config.setUseTextLevelQueue(false);</b>
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    numParaField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
&nbsp;        try {
<b class="nc">&nbsp;          int numParaCheck = Integer.parseInt(numParaField.getText());</b>
<b class="nc">&nbsp;          if (numParaCheck &gt; -3 &amp;&amp; numParaCheck &lt; 99) {</b>
<b class="nc">&nbsp;            numParaField.setForeground(Color.BLACK);</b>
<b class="nc">&nbsp;            config.setNumParasToCheck(numParaCheck);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            numParaField.setForeground(Color.RED);</b>
&nbsp;          }
&nbsp;        } catch (NumberFormatException ex) {
<b class="nc">&nbsp;          numParaField.setForeground(Color.RED);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JLabel textChangedLabel = new JLabel(Tools.getLabel(messages.getString(&quot;guiSentenceExceedingRules&quot;)));</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(textChangedLabel, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JPanel radioPanel = new JPanel();</b>
<b class="nc">&nbsp;    radioPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, 0, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;      radioPanel.add(radioButtons[i], cons1);</b>
<b class="nc">&nbsp;      if (i &lt; 2) cons1.gridy++;</b>
&nbsp;    }
<b class="nc">&nbsp;    cons1.gridx = 1;</b>
<b class="nc">&nbsp;    radioPanel.add(numParaField, cons1);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(radioPanel, cons);</b>
&nbsp;  }
&nbsp;  
&nbsp;  private JPanel getOfficeTechnicalElements() {
&nbsp;    // technical settings
<b class="nc">&nbsp;    JPanel portPanel = new JPanel();</b>
<b class="nc">&nbsp;    portPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT1, 0, 0);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    JCheckBox saveCacheBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiSaveCacheToFile&quot;)));</b>
<b class="nc">&nbsp;    JTextField otherServerNameField = new JTextField(config.getServerUrl() ==  null ? &quot;&quot; : config.getServerUrl(), 25);</b>
<b class="nc">&nbsp;    otherServerNameField.setMinimumSize(new Dimension(100, 25));</b>
<b class="nc">&nbsp;    otherServerNameField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        String serverName = otherServerNameField.getText();</b>
<b class="nc">&nbsp;        serverName = serverName.trim();</b>
<b class="nc">&nbsp;        if(serverName.isEmpty()) {</b>
<b class="nc">&nbsp;          serverName = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (config.isValidServerUrl(serverName)) {</b>
<b class="nc">&nbsp;          otherServerNameField.setForeground(Color.BLACK);</b>
<b class="nc">&nbsp;          config.setOtherServerUrl(serverName);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          otherServerNameField.setForeground(Color.RED);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JCheckBox useServerBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiUseServer&quot;)) + &quot; &quot;);</b>
<b class="nc">&nbsp;    useServerBox.setSelected(config.useOtherServer());</b>
<b class="nc">&nbsp;    useServerBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      int select = JOptionPane.OK_OPTION;</b>
<b class="nc">&nbsp;      boolean selected = useServerBox.isSelected();</b>
<b class="nc">&nbsp;      if(selected &amp;&amp; firstSelection) {</b>
<b class="nc">&nbsp;        select = showRemoteServerHint(useServerBox, true);</b>
<b class="nc">&nbsp;        firstSelection = false;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        firstSelection = true;</b>
&nbsp;      }
<b class="nc">&nbsp;      if(select == JOptionPane.OK_OPTION) {</b>
<b class="nc">&nbsp;        useServerBox.setSelected(selected);</b>
<b class="nc">&nbsp;        config.setUseOtherServer(useServerBox.isSelected());</b>
<b class="nc">&nbsp;        otherServerNameField.setEnabled(useServerBox.isSelected());</b>
&nbsp;      } else {
<b class="nc">&nbsp;        useServerBox.setSelected(false);</b>
<b class="nc">&nbsp;        firstSelection = true;</b>
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JLabel usernameLabel = new JLabel(Tools.getLabel(messages.getString(&quot;guiPremiumUsername&quot;)));</b>
&nbsp;
<b class="nc">&nbsp;    JTextField usernameField = new JTextField(config.getRemoteUsername() ==  null ? &quot;&quot; : config.getRemoteUsername(), 25);</b>
<b class="nc">&nbsp;    usernameField.setMinimumSize(new Dimension(100, 25));</b>
<b class="nc">&nbsp;    usernameField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        String username = usernameField.getText();</b>
<b class="nc">&nbsp;        username = username.trim();</b>
<b class="nc">&nbsp;        if(username.isEmpty()) {</b>
<b class="nc">&nbsp;          username = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (username != null) {</b>
<b class="nc">&nbsp;          config.setRemoteUsername(username);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JLabel apiKeyLabel = new JLabel(Tools.getLabel(messages.getString(&quot;guiPremiumApiKey&quot;)));</b>
&nbsp;
<b class="nc">&nbsp;    JTextField apiKeyField = new JTextField(config.getRemoteApiKey() ==  null ? &quot;&quot; : config.getRemoteApiKey(), 25);</b>
<b class="nc">&nbsp;    apiKeyField.setMinimumSize(new Dimension(100, 25));</b>
<b class="nc">&nbsp;    apiKeyField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        String apiKey = apiKeyField.getText();</b>
<b class="nc">&nbsp;        apiKey = apiKey.trim();</b>
<b class="nc">&nbsp;        if(apiKey.isEmpty()) {</b>
<b class="nc">&nbsp;          apiKey = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (apiKey != null) {</b>
<b class="nc">&nbsp;          config.setRemoteApiKey(apiKey);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JCheckBox isPremiumBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiUsePremiumAccount&quot;)) + &quot; &quot;);</b>
<b class="nc">&nbsp;    isPremiumBox.setSelected(config.isPremium());</b>
<b class="nc">&nbsp;    isPremiumBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      boolean selected = isPremiumBox.isSelected();</b>
<b class="nc">&nbsp;      config.setPremium(selected);</b>
<b class="nc">&nbsp;      usernameLabel.setEnabled(selected);</b>
<b class="nc">&nbsp;      usernameField.setEnabled(selected);</b>
<b class="nc">&nbsp;      apiKeyLabel.setEnabled(selected);</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(selected);</b>
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    JRadioButton[] typeOfCheckButtons = new JRadioButton[3];</b>
<b class="nc">&nbsp;    ButtonGroup typeOfCheckGroup = new ButtonGroup();</b>
<b class="nc">&nbsp;    typeOfCheckButtons[0] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiOneThread&quot;)));</b>
<b class="nc">&nbsp;    typeOfCheckButtons[0].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      otherServerNameField.setEnabled(false);</b>
<b class="nc">&nbsp;      useServerBox.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameField.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(false);</b>
<b class="nc">&nbsp;      isPremiumBox.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setMultiThreadLO(false);</b>
<b class="nc">&nbsp;      config.setRemoteCheck(false);</b>
&nbsp;    });
<b class="nc">&nbsp;    typeOfCheckButtons[1] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiIsMultiThread&quot;)));</b>
<b class="nc">&nbsp;    typeOfCheckButtons[1].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      otherServerNameField.setEnabled(false);</b>
<b class="nc">&nbsp;      useServerBox.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameField.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(false);</b>
<b class="nc">&nbsp;      isPremiumBox.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setMultiThreadLO(true);</b>
<b class="nc">&nbsp;      config.setRemoteCheck(false);</b>
&nbsp;    });
<b class="nc">&nbsp;    typeOfCheckButtons[2] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiUseRemoteServer&quot;)));</b>
<b class="nc">&nbsp;    typeOfCheckButtons[2].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      int select = JOptionPane.OK_OPTION;</b>
<b class="nc">&nbsp;      boolean selected = typeOfCheckButtons[2].isSelected();</b>
<b class="nc">&nbsp;      if(selected &amp;&amp; firstSelection) {</b>
<b class="nc">&nbsp;        select = showRemoteServerHint(typeOfCheckButtons[2], false);</b>
<b class="nc">&nbsp;        firstSelection = false;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        firstSelection = true;</b>
&nbsp;      }
<b class="nc">&nbsp;      if(select == JOptionPane.OK_OPTION) {</b>
&nbsp;//        typeOfCheckButtons[2].setSelected(selected);
<b class="nc">&nbsp;        otherServerNameField.setEnabled(useServerBox.isSelected());</b>
<b class="nc">&nbsp;        useServerBox.setEnabled(true);</b>
<b class="nc">&nbsp;        usernameLabel.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;        usernameField.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;        apiKeyLabel.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;        apiKeyField.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;        isPremiumBox.setEnabled(true);</b>
<b class="nc">&nbsp;        config.setMultiThreadLO(false);</b>
<b class="nc">&nbsp;        config.setRemoteCheck(true);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        if (config.isMultiThread()) {</b>
<b class="nc">&nbsp;          typeOfCheckButtons[1].setSelected(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          typeOfCheckButtons[0].setSelected(true);</b>
&nbsp;        }
<b class="nc">&nbsp;        firstSelection = true;</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;      typeOfCheckGroup.add(typeOfCheckButtons[i]);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (config.doRemoteCheck()) {</b>
<b class="nc">&nbsp;      typeOfCheckButtons[2].setSelected(true);</b>
<b class="nc">&nbsp;      otherServerNameField.setEnabled(useServerBox.isSelected());</b>
<b class="nc">&nbsp;      useServerBox.setEnabled(true);</b>
<b class="nc">&nbsp;      usernameLabel.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;      usernameField.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;      apiKeyLabel.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(isPremiumBox.isSelected());</b>
<b class="nc">&nbsp;      isPremiumBox.setEnabled(true);</b>
<b class="nc">&nbsp;      config.setMultiThreadLO(false);</b>
<b class="nc">&nbsp;      config.setRemoteCheck(true);</b>
<b class="nc">&nbsp;    } else if (config.isMultiThread()) {</b>
<b class="nc">&nbsp;      typeOfCheckButtons[1].setSelected(true);</b>
<b class="nc">&nbsp;      otherServerNameField.setEnabled(false);</b>
<b class="nc">&nbsp;      useServerBox.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameField.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(false);</b>
<b class="nc">&nbsp;      isPremiumBox.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setMultiThreadLO(true);</b>
<b class="nc">&nbsp;      config.setRemoteCheck(false);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      typeOfCheckButtons[0].setSelected(true);</b>
<b class="nc">&nbsp;      otherServerNameField.setEnabled(false);</b>
<b class="nc">&nbsp;      useServerBox.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      usernameField.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyLabel.setEnabled(false);</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(false);</b>
<b class="nc">&nbsp;      isPremiumBox.setEnabled(false);</b>
<b class="nc">&nbsp;      config.setMultiThreadLO(false);</b>
<b class="nc">&nbsp;      config.setRemoteCheck(false);</b>
&nbsp;    }
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;      portPanel.add(typeOfCheckButtons[i], cons);</b>
<b class="nc">&nbsp;      if (i &lt; 3) cons.gridy++;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    JPanel serverPanel = new JPanel();</b>
<b class="nc">&nbsp;    serverPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    serverPanel.add(useServerBox, cons1);</b>
<b class="nc">&nbsp;    cons1.gridx++;</b>
<b class="nc">&nbsp;    serverPanel.add(otherServerNameField, cons1);</b>
<b class="nc">&nbsp;    JLabel serverExampleLabel = new JLabel(&quot; &quot; + Tools.getLabel(messages.getString(&quot;guiUseServerExample&quot;)));</b>
<b class="nc">&nbsp;    serverExampleLabel.setEnabled(false);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    serverPanel.add(serverExampleLabel, cons1);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(serverPanel, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JPanel premiumPanel = new JPanel();</b>
<b class="nc">&nbsp;    premiumPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    premiumPanel.add(isPremiumBox, cons1);</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, SHIFT3, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    premiumPanel.add(usernameLabel, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    premiumPanel.add(usernameField, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    premiumPanel.add(apiKeyLabel, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    premiumPanel.add(apiKeyField, cons1);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(premiumPanel, cons);</b>
<b class="nc">&nbsp;    saveCacheBox.setSelected(config.saveLoCache());</b>
<b class="nc">&nbsp;    saveCacheBox.addItemListener(e1 -&gt; {</b>
<b class="nc">&nbsp;      config.setSaveLoCache(saveCacheBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(saveCacheBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(getNgramPanel(), cons);</b>
<b class="nc">&nbsp;    return portPanel;</b>
&nbsp;  }
&nbsp;  
&nbsp;  private void createOfficeElements(GridBagConstraints cons, JPanel portPanel) {
&nbsp;
<b class="nc">&nbsp;    addOfficeLanguageElements(cons, portPanel);</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(new JLabel(&quot; &quot;), cons);</b>
&nbsp;    
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(getMotherTonguePanel(cons), cons);</b>
&nbsp;    
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(new JLabel(&quot; &quot;), cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JCheckBox useLtSpellCheckerBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiUseLtSpellChecker&quot;)));</b>
<b class="nc">&nbsp;    useLtSpellCheckerBox.setSelected(config.useLtSpellChecker());</b>
<b class="nc">&nbsp;    useLtSpellCheckerBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setUseLtSpellChecker(useLtSpellCheckerBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(useLtSpellCheckerBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox markSingleCharBold = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiMarkSingleCharBold&quot;)));</b>
<b class="nc">&nbsp;    markSingleCharBold.setSelected(config.markSingleCharBold());</b>
<b class="nc">&nbsp;    markSingleCharBold.addItemListener(e -&gt; config.setMarkSingleCharBold(markSingleCharBold.isSelected()));</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(markSingleCharBold, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox noSynonymsAsSuggestionsBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiNoSynonymsAsSuggestions&quot;)));</b>
<b class="nc">&nbsp;    noSynonymsAsSuggestionsBox.setSelected(config.noSynonymsAsSuggestions());</b>
<b class="nc">&nbsp;    noSynonymsAsSuggestionsBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setNoSynonymsAsSuggestions(noSynonymsAsSuggestionsBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(noSynonymsAsSuggestionsBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox includeTrackedChangesBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiIncludeTrackedChanges&quot;)));</b>
<b class="nc">&nbsp;    includeTrackedChangesBox.setSelected(config.includeTrackedChanges());</b>
<b class="nc">&nbsp;    includeTrackedChangesBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setIncludeTrackedChanges(includeTrackedChangesBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(includeTrackedChangesBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox enableTmpOffRulesBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiActivateTempOffRules&quot;)));</b>
<b class="nc">&nbsp;    enableTmpOffRulesBox.setSelected(config.enableTmpOffRules());</b>
<b class="nc">&nbsp;    enableTmpOffRulesBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setEnableTmpOffRules(enableTmpOffRulesBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(enableTmpOffRulesBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox enableGoalSpecificRulesBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiEnableGoalSpecificRules&quot;)));</b>
<b class="nc">&nbsp;    enableGoalSpecificRulesBox.setSelected(config.enableGoalSpecificRules());</b>
<b class="nc">&nbsp;    enableGoalSpecificRulesBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setEnableGoalSpecificRules(enableGoalSpecificRulesBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(enableGoalSpecificRulesBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox filterOverlappingMatchesBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiFilterOverlappingMatches&quot;)));</b>
<b class="nc">&nbsp;    filterOverlappingMatchesBox.setSelected(config.filterOverlappingMatches());</b>
<b class="nc">&nbsp;    filterOverlappingMatchesBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setFilterOverlappingMatches(filterOverlappingMatchesBox.isSelected());</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(filterOverlappingMatchesBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox noBackgroundCheckBox = new JCheckBox(Tools.getLabel(messages.getString(&quot;guiNoBackgroundCheck&quot;)));</b>
<b class="nc">&nbsp;    noBackgroundCheckBox.setSelected(config.noBackgroundCheck());</b>
<b class="nc">&nbsp;    noBackgroundCheckBox.addItemListener(e -&gt; config.setNoBackgroundCheck(noBackgroundCheckBox.isSelected()));</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(noBackgroundCheckBox, cons);</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(new JLabel(&quot; &quot;), cons);</b>
&nbsp;    
<b class="nc">&nbsp;    addOfficeTextruleElements(cons, portPanel);</b>
&nbsp;    
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT1, 0, 0);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    portPanel.add(new JLabel(&quot; &quot;), cons);</b>
&nbsp;    
&nbsp;//    addOfficeTechnicalElements(cons, portPanel);
&nbsp;  }
&nbsp;  
&nbsp;  private int showRemoteServerHint(Component component, boolean otherServer) {
<b class="nc">&nbsp;    if(config.useOtherServer() || otherServer) {</b>
<b class="nc">&nbsp;        return JOptionPane.showConfirmDialog(component, </b>
<b class="nc">&nbsp;            MessageFormat.format(messages.getString(&quot;loRemoteInfoOtherServer&quot;), config.getServerUrl()), </b>
<b class="nc">&nbsp;          messages.getString(&quot;loMenuRemoteInfo&quot;), JOptionPane.OK_CANCEL_OPTION);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      return JOptionPane.showConfirmDialog(component, messages.getString(&quot;loRemoteInfoDefaultServer&quot;), </b>
<b class="nc">&nbsp;          messages.getString(&quot;loMenuRemoteInfo&quot;), JOptionPane.OK_CANCEL_OPTION);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  @NotNull
&nbsp;  private DefaultTreeModel getTreeModel(DefaultMutableTreeNode rootNode, List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    DefaultTreeModel treeModel = new DefaultTreeModel(rootNode);</b>
<b class="nc">&nbsp;    treeModel.addTreeModelListener(new TreeModelListener() {</b>
&nbsp;      @Override
&nbsp;      public void treeNodesChanged(TreeModelEvent e) {
<b class="nc">&nbsp;        DefaultMutableTreeNode node = (DefaultMutableTreeNode) e.getTreePath().getLastPathComponent();</b>
<b class="nc">&nbsp;        int index = e.getChildIndices()[0];</b>
<b class="nc">&nbsp;        node = (DefaultMutableTreeNode) node.getChildAt(index);</b>
<b class="nc">&nbsp;        if (node instanceof RuleNode) {</b>
<b class="nc">&nbsp;          RuleNode o = (RuleNode) node;</b>
<b class="nc">&nbsp;          if (o.getRule().isDefaultOff() || o.getRule().getCategory().isDefaultOff()) {</b>
<b class="nc">&nbsp;            if (o.isEnabled()) {</b>
<b class="nc">&nbsp;              config.getEnabledRuleIds().add(o.getRule().getId());</b>
<b class="nc">&nbsp;              config.getDisabledRuleIds().remove(o.getRule().getId());</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.getEnabledRuleIds().remove(o.getRule().getId());</b>
<b class="nc">&nbsp;              config.getDisabledRuleIds().add(o.getRule().getId());</b>
&nbsp;            }
&nbsp;          } else {
<b class="nc">&nbsp;            if (o.isEnabled()) {</b>
<b class="nc">&nbsp;              config.getDisabledRuleIds().remove(o.getRule().getId());</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.getDisabledRuleIds().add(o.getRule().getId());</b>
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;          updateProfileRules(rules);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (node instanceof CategoryNode) {</b>
<b class="nc">&nbsp;          CategoryNode o = (CategoryNode) node;</b>
<b class="nc">&nbsp;          if (o.getCategory().isDefaultOff()) {</b>
<b class="nc">&nbsp;            if (o.isEnabled()) {</b>
<b class="nc">&nbsp;              config.getDisabledCategoryNames().remove(o.getCategory().getName());</b>
<b class="nc">&nbsp;              config.getEnabledCategoryNames().add(o.getCategory().getName());</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.getDisabledCategoryNames().add(o.getCategory().getName());</b>
<b class="nc">&nbsp;              config.getEnabledCategoryNames().remove(o.getCategory().getName());</b>
&nbsp;            }
&nbsp;          } else {
<b class="nc">&nbsp;            if (o.isEnabled()) {</b>
<b class="nc">&nbsp;              config.getDisabledCategoryNames().remove(o.getCategory().getName());</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.getDisabledCategoryNames().add(o.getCategory().getName());</b>
&nbsp;            }
&nbsp;          }
&nbsp;        }
&nbsp;      }
&nbsp;      @Override
<b class="nc">&nbsp;      public void treeNodesInserted(TreeModelEvent e) {}</b>
&nbsp;      @Override
<b class="nc">&nbsp;      public void treeNodesRemoved(TreeModelEvent e) {}</b>
&nbsp;      @Override
<b class="nc">&nbsp;      public void treeStructureChanged(TreeModelEvent e) {}</b>
&nbsp;    });
<b class="nc">&nbsp;    return treeModel;</b>
&nbsp;  }
&nbsp;
&nbsp;  @NotNull
&nbsp;  private MouseAdapter getMouseAdapter() {
<b class="nc">&nbsp;    return new MouseAdapter() {</b>
&nbsp;        private void handlePopupEvent(MouseEvent e) {
<b class="nc">&nbsp;          JTree tree = (JTree) e.getSource();</b>
<b class="nc">&nbsp;          TreePath path = tree.getPathForLocation(e.getX(), e.getY());</b>
<b class="nc">&nbsp;          if (path == null) {</b>
&nbsp;            return;
&nbsp;          }
<b class="nc">&nbsp;          DefaultMutableTreeNode node</b>
<b class="nc">&nbsp;                  = (DefaultMutableTreeNode) path.getLastPathComponent();</b>
<b class="nc">&nbsp;          TreePath[] paths = tree.getSelectionPaths();</b>
<b class="nc">&nbsp;          boolean isSelected = false;</b>
<b class="nc">&nbsp;          if (paths != null) {</b>
<b class="nc">&nbsp;            for (TreePath selectionPath : paths) {</b>
<b class="nc">&nbsp;              if (selectionPath.equals(path)) {</b>
<b class="nc">&nbsp;                isSelected = true;</b>
&nbsp;              }
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;          if (!isSelected) {</b>
<b class="nc">&nbsp;            tree.setSelectionPath(path);</b>
&nbsp;          }
<b class="nc">&nbsp;          if (node.isLeaf()) {</b>
<b class="nc">&nbsp;            JPopupMenu popup = new JPopupMenu();</b>
<b class="nc">&nbsp;            JMenuItem aboutRuleMenuItem = new JMenuItem(messages.getString(&quot;guiAboutRuleMenu&quot;));</b>
<b class="nc">&nbsp;            aboutRuleMenuItem.addActionListener(actionEvent -&gt; {</b>
<b class="nc">&nbsp;              RuleNode node1 = (RuleNode) tree.getSelectionPath().getLastPathComponent();</b>
<b class="nc">&nbsp;              Rule rule = node1.getRule();</b>
<b class="nc">&nbsp;              Language lang = config.getLanguage();</b>
<b class="nc">&nbsp;              if(lang == null) {</b>
<b class="nc">&nbsp;                lang = Languages.getLanguageForLocale(Locale.getDefault());</b>
&nbsp;              }
<b class="nc">&nbsp;              Tools.showRuleInfoDialog(tree, messages.getString(&quot;guiAboutRuleTitle&quot;),</b>
<b class="nc">&nbsp;                      rule.getDescription(), rule, rule.getUrl(), messages,</b>
<b class="nc">&nbsp;                      lang.getShortCodeWithCountryAndVariant());</b>
&nbsp;            });
<b class="nc">&nbsp;            popup.add(aboutRuleMenuItem);</b>
<b class="nc">&nbsp;            popup.show(tree, e.getX(), e.getY());</b>
&nbsp;          }
&nbsp;        }
&nbsp;  
&nbsp;        @Override
&nbsp;        public void mousePressed(MouseEvent e) {
<b class="nc">&nbsp;          if (e.isPopupTrigger()) {</b>
<b class="nc">&nbsp;            handlePopupEvent(e);</b>
&nbsp;          }
&nbsp;        }
&nbsp;  
&nbsp;        @Override
&nbsp;        public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;          if (e.isPopupTrigger()) {</b>
<b class="nc">&nbsp;            handlePopupEvent(e);</b>
&nbsp;          }
&nbsp;        }
&nbsp;      };
&nbsp;  }
&nbsp;
&nbsp;  @NotNull
&nbsp;  private JPanel getTreeButtonPanel(int num) {
&nbsp;    GridBagConstraints cons;
<b class="nc">&nbsp;    JPanel treeButtonPanel = new JPanel();</b>
<b class="nc">&nbsp;    cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    JButton expandAllButton = new JButton(messages.getString(&quot;guiExpandAll&quot;));</b>
<b class="nc">&nbsp;    treeButtonPanel.add(expandAllButton, cons);</b>
<b class="nc">&nbsp;    expandAllButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      TreeNode root = (TreeNode) configTree[num].getModel().getRoot();</b>
<b class="nc">&nbsp;      TreePath parent = new TreePath(root);</b>
<b class="nc">&nbsp;      for (Enumeration&lt;?&gt; cat = root.children(); cat.hasMoreElements();) {</b>
<b class="nc">&nbsp;        TreeNode n = (TreeNode) cat.nextElement();</b>
<b class="nc">&nbsp;        TreePath child = parent.pathByAddingChild(n);</b>
<b class="nc">&nbsp;        configTree[num].expandPath(child);</b>
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 1;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    JButton collapseAllButton = new JButton(messages.getString(&quot;guiCollapseAll&quot;));</b>
<b class="nc">&nbsp;    treeButtonPanel.add(collapseAllButton, cons);</b>
<b class="nc">&nbsp;    collapseAllButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      TreeNode root = (TreeNode) configTree[num].getModel().getRoot();</b>
<b class="nc">&nbsp;      TreePath parent = new TreePath(root);</b>
<b class="nc">&nbsp;      for (Enumeration&lt;?&gt; categ = root.children(); categ.hasMoreElements();) {</b>
<b class="nc">&nbsp;        TreeNode n = (TreeNode) categ.nextElement();</b>
<b class="nc">&nbsp;        TreePath child = parent.pathByAddingChild(n);</b>
<b class="nc">&nbsp;        configTree[num].collapsePath(child);</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    return treeButtonPanel;</b>
&nbsp;  }
&nbsp;  
&nbsp;  @NotNull
&nbsp;  private JPanel getProfilePanel(List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    profileChanged = true;</b>
<b class="nc">&nbsp;    JPanel profilePanel = new JPanel();</b>
<b class="nc">&nbsp;    profilePanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 4, 0, 8);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 1.0f;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    List&lt;String&gt; profiles = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    String defaultOptions = messages.getString(&quot;guiDefaultOptions&quot;);</b>
<b class="nc">&nbsp;    String userOptions = messages.getString(&quot;guiUserProfile&quot;);</b>
<b class="nc">&nbsp;    profiles.addAll(config.getDefinedProfiles());</b>
<b class="nc">&nbsp;    profiles.sort(null);</b>
<b class="nc">&nbsp;    profiles.add(0, userOptions);</b>
<b class="nc">&nbsp;    String currentProfile = config.getCurrentProfile();</b>
<b class="nc">&nbsp;    JComboBox&lt;String&gt; profileBox = new JComboBox&lt;&gt;(profiles.toArray(new String[0]));</b>
<b class="nc">&nbsp;    if(currentProfile == null || currentProfile.isEmpty()) {</b>
<b class="nc">&nbsp;      profileBox.setSelectedItem(userOptions);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      profileBox.setSelectedItem(currentProfile);</b>
&nbsp;    }
<b class="nc">&nbsp;    profileBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;        if(profileChanged) {</b>
&nbsp;          try {
&nbsp;            //  The configuration has to be saved first to save previous changes
<b class="nc">&nbsp;            config.saveConfiguration(null);</b>
<b class="nc">&nbsp;            List&lt;String&gt; saveProfiles = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            saveProfiles.addAll(config.getDefinedProfiles());</b>
<b class="nc">&nbsp;            if(e.getItem().equals(userOptions)) {</b>
<b class="nc">&nbsp;              config.initOptions();</b>
<b class="nc">&nbsp;              config.loadConfiguration(&quot;&quot;);</b>
<b class="nc">&nbsp;              config.setCurrentProfile(null);</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.initOptions();</b>
<b class="nc">&nbsp;              config.loadConfiguration((String) e.getItem());</b>
<b class="nc">&nbsp;              config.setCurrentProfile((String) e.getItem());</b>
&nbsp;            }
<b class="nc">&nbsp;            config.addProfiles(saveProfiles);</b>
<b class="nc">&nbsp;            restartShow = true;</b>
<b class="nc">&nbsp;            dialog.setVisible(false);</b>
&nbsp;          } catch (IOException e1) {
&nbsp;          }
&nbsp;        } else {
<b class="nc">&nbsp;          profileChanged = true;</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;      
<b class="nc">&nbsp;    profilePanel.add(new JLabel(addColonToMessageString(&quot;guiCurrentProfile&quot;)), cons);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(6, 16, 0, 8);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    profilePanel.add(profileBox, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JButton renameButton = new JButton(messages.getString(&quot;guiRenameProfile&quot;) + &quot;...&quot;);</b>
<b class="nc">&nbsp;    renameButton.setEnabled(!profileBox.getSelectedItem().equals(defaultOptions) </b>
<b class="nc">&nbsp;        &amp;&amp; !profileBox.getSelectedItem().equals(userOptions));</b>
<b class="nc">&nbsp;    renameButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      boolean noName = true;</b>
<b class="nc">&nbsp;      String profileName = (String) profileBox.getSelectedItem();</b>
<b class="nc">&nbsp;      while (noName) {</b>
<b class="nc">&nbsp;        profileName = JOptionPane.showInputDialog(dialog, messages.getString(&quot;guiRenameProfile&quot;) + &quot;:&quot;, profileName);</b>
<b class="nc">&nbsp;        if (profileName == null || profileName.equals(&quot;&quot;)) {</b>
&nbsp;          break;
&nbsp;        }
<b class="nc">&nbsp;        profileName = profileName.replaceAll(&quot;[ \t=]&quot;, &quot;_&quot;);</b>
<b class="nc">&nbsp;        noName = false;</b>
<b class="nc">&nbsp;        while(config.getDefinedProfiles().contains(profileName) || userOptions.equals(profileName)) {</b>
<b class="nc">&nbsp;          profileName += &quot;_new&quot;;</b>
<b class="nc">&nbsp;          noName = true;</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      if (profileName != null &amp;&amp; !profileName.equals(&quot;&quot;)) {</b>
<b class="nc">&nbsp;        config.removeProfile(config.getCurrentProfile());</b>
<b class="nc">&nbsp;        config.addProfile(profileName);</b>
<b class="nc">&nbsp;        config.setCurrentProfile(profileName);</b>
<b class="nc">&nbsp;        restartShow = true;</b>
<b class="nc">&nbsp;        dialog.setVisible(false);</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    profilePanel.add(renameButton, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JButton exportButton = new JButton(messages.getString(&quot;guiExportProfile&quot;) + &quot;...&quot;);</b>
<b class="nc">&nbsp;    exportButton.setEnabled(!profileBox.getSelectedItem().equals(defaultOptions) </b>
<b class="nc">&nbsp;        &amp;&amp; !profileBox.getSelectedItem().equals(userOptions));</b>
<b class="nc">&nbsp;    exportButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      JFileChooser fileChooser = new JFileChooser();</b>
<b class="nc">&nbsp;      int choose = fileChooser.showSaveDialog(dialog);</b>
<b class="nc">&nbsp;      if (choose == JFileChooser.APPROVE_OPTION) {</b>
&nbsp;        try {
<b class="nc">&nbsp;          config.exportProfile((String) profileBox.getSelectedItem(), fileChooser.getSelectedFile());</b>
&nbsp;        } catch (IOException e1) {
&nbsp;        }
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    cons.gridx++;</b>
<b class="nc">&nbsp;    profilePanel.add(exportButton, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JButton defaultButton = new JButton(defaultOptions);</b>
<b class="nc">&nbsp;    defaultButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      List&lt;String&gt; saveProfiles = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;      saveProfiles.addAll(config.getDefinedProfiles());</b>
<b class="nc">&nbsp;      String saveCurrent = config.getCurrentProfile() == null ? null : config.getCurrentProfile();</b>
<b class="nc">&nbsp;      config.initOptions();</b>
<b class="nc">&nbsp;      config.addProfiles(saveProfiles);</b>
<b class="nc">&nbsp;      config.setCurrentProfile(saveCurrent);</b>
<b class="nc">&nbsp;      restartShow = true;</b>
<b class="nc">&nbsp;      dialog.setVisible(false);</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    profilePanel.add(defaultButton, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JButton deleteButton = new JButton(messages.getString(&quot;guiDeleteProfile&quot;));</b>
<b class="nc">&nbsp;    deleteButton.setEnabled(!profileBox.getSelectedItem().equals(defaultOptions) </b>
<b class="nc">&nbsp;        &amp;&amp; !profileBox.getSelectedItem().equals(userOptions));</b>
<b class="nc">&nbsp;    deleteButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      List&lt;String&gt; saveProfiles = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;      saveProfiles.addAll(config.getDefinedProfiles());</b>
<b class="nc">&nbsp;      config.initOptions();</b>
&nbsp;      try {
<b class="nc">&nbsp;        config.loadConfiguration(&quot;&quot;);</b>
&nbsp;      } catch (IOException e1) {
&nbsp;      }
<b class="nc">&nbsp;      config.setCurrentProfile(null);</b>
<b class="nc">&nbsp;      config.addProfiles(saveProfiles);</b>
<b class="nc">&nbsp;      config.removeProfile((String)profileBox.getSelectedItem());</b>
<b class="nc">&nbsp;      restartShow = true;</b>
<b class="nc">&nbsp;      dialog.setVisible(false);</b>
&nbsp;    });
<b class="nc">&nbsp;    cons.gridx++;</b>
<b class="nc">&nbsp;    profilePanel.add(deleteButton, cons);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(16, 4, 0, 8);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    profilePanel.add(new JLabel(addColonToMessageString(&quot;guiAddNewProfile&quot;)), cons);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(6, 16, 0, 8);</b>
&nbsp;    
&nbsp;    
<b class="nc">&nbsp;    JButton addButton = new JButton(messages.getString(&quot;guiAddProfile&quot;) + &quot;...&quot;);</b>
<b class="nc">&nbsp;    addButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      boolean noName = true;</b>
<b class="nc">&nbsp;      String profileName = &quot;&quot;;</b>
<b class="nc">&nbsp;      while (noName) {</b>
<b class="nc">&nbsp;        profileName = JOptionPane.showInputDialog(dialog, messages.getString(&quot;guiAddNewProfile&quot;), profileName);</b>
<b class="nc">&nbsp;        if (profileName == null || profileName.equals(&quot;&quot;)) {</b>
&nbsp;          break;
&nbsp;        }
<b class="nc">&nbsp;        profileName = profileName.replaceAll(&quot;[ \t=]&quot;, &quot;_&quot;);</b>
<b class="nc">&nbsp;        noName = false;</b>
<b class="nc">&nbsp;        while(config.getDefinedProfiles().contains(profileName) || userOptions.equals(profileName)) {</b>
<b class="nc">&nbsp;          profileName += &quot;_new&quot;;</b>
<b class="nc">&nbsp;          noName = true;</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      if (profileName != null &amp;&amp; !profileName.equals(&quot;&quot;)) {</b>
&nbsp;        //  The configuration has to be saved and reloaded first to save previous changes
&nbsp;        try {
<b class="nc">&nbsp;          config.saveConfiguration(null);</b>
<b class="nc">&nbsp;          config.initOptions();</b>
<b class="nc">&nbsp;          config.loadConfiguration(config.getCurrentProfile());</b>
&nbsp;        } catch (IOException e1) {
&nbsp;        }
<b class="nc">&nbsp;        config.addProfile(profileName);</b>
<b class="nc">&nbsp;        config.setCurrentProfile(profileName);</b>
<b class="nc">&nbsp;        profileChanged = false;</b>
<b class="nc">&nbsp;        profileBox.addItem(profileName);</b>
<b class="nc">&nbsp;        profileBox.setSelectedItem(profileName);</b>
<b class="nc">&nbsp;        deleteButton.setEnabled(true);</b>
<b class="nc">&nbsp;        renameButton.setEnabled(true);</b>
<b class="nc">&nbsp;        exportButton.setEnabled(true);</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    profilePanel.add(addButton, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    JButton importButton = new JButton(messages.getString(&quot;guiImportProfile&quot;) + &quot;...&quot;);</b>
<b class="nc">&nbsp;    importButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      JFileChooser fileChooser = new JFileChooser();</b>
<b class="nc">&nbsp;      int choose = fileChooser.showOpenDialog(dialog);</b>
<b class="nc">&nbsp;      if (choose == JFileChooser.APPROVE_OPTION) {</b>
&nbsp;        try {
&nbsp;          //  The configuration has to be saved and reloaded first to save previous changes
<b class="nc">&nbsp;          config.saveConfiguration(null);</b>
<b class="nc">&nbsp;          config.initOptions();</b>
<b class="nc">&nbsp;          config.loadConfiguration(config.getCurrentProfile());</b>
<b class="nc">&nbsp;          List&lt;String&gt; saveProfiles = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;          saveProfiles.addAll(config.getDefinedProfiles());</b>
<b class="nc">&nbsp;          Configuration saveConfig = config.copy(config);</b>
<b class="nc">&nbsp;          config.initOptions();</b>
<b class="nc">&nbsp;          config.importProfile(fileChooser.getSelectedFile());</b>
<b class="nc">&nbsp;          String profileName = config.getCurrentProfile();</b>
<b class="nc">&nbsp;          if (profileName != null) {</b>
<b class="nc">&nbsp;            config.addProfiles(saveProfiles);</b>
<b class="nc">&nbsp;            profileName = profileName.replaceAll(&quot;[ \t=]&quot;, &quot;_&quot;);</b>
<b class="nc">&nbsp;            while(config.getDefinedProfiles().contains(profileName) || userOptions.equals(profileName)) {</b>
<b class="nc">&nbsp;              profileName += &quot;_new&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            config.setCurrentProfile(profileName);</b>
<b class="nc">&nbsp;            config.addProfile(profileName);</b>
<b class="nc">&nbsp;            config.saveConfiguration(null);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            config.restoreState(saveConfig);;</b>
&nbsp;          }
<b class="nc">&nbsp;          restartShow = true;</b>
<b class="nc">&nbsp;          dialog.setVisible(false);</b>
&nbsp;        } catch (IOException e1) {
&nbsp;        }
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    cons.gridx++;</b>
<b class="nc">&nbsp;    profilePanel.add(importButton, cons);</b>
<b class="nc">&nbsp;    return profilePanel;</b>
&nbsp;  }
&nbsp;  
&nbsp;  private String addColonToMessageString(String message) {
<b class="nc">&nbsp;    String str = messages.getString(message);</b>
<b class="nc">&nbsp;    if (!str.endsWith(&quot;:&quot;)) {</b>
<b class="nc">&nbsp;      return str + &quot;:&quot;;</b>
&nbsp;    }
<b class="nc">&nbsp;    return str;</b>
&nbsp;  }
&nbsp;
&nbsp;  @NotNull
&nbsp;  private JPanel getMotherTonguePanel(GridBagConstraints cons) {
<b class="nc">&nbsp;    JPanel motherTonguePanel = new JPanel();</b>
<b class="nc">&nbsp;    motherTonguePanel.add(new JLabel(messages.getString(&quot;guiMotherTongue&quot;)), cons);</b>
<b class="nc">&nbsp;    JComboBox&lt;String&gt; motherTongueBox = new JComboBox&lt;&gt;(getPossibleLanguages(true));</b>
<b class="nc">&nbsp;    if (config.getMotherTongue() != null) {</b>
<b class="nc">&nbsp;      motherTongueBox.setSelectedItem(config.getMotherTongue().getTranslatedName(messages));</b>
&nbsp;    }
<b class="nc">&nbsp;    motherTongueBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      if (e.getStateChange() == ItemEvent.SELECTED) {</b>
&nbsp;        Language motherTongue;
<b class="nc">&nbsp;        if (motherTongueBox.getSelectedItem() instanceof String) {</b>
<b class="nc">&nbsp;          motherTongue = getLanguageForLocalizedName(motherTongueBox.getSelectedItem().toString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;          motherTongue = (Language) motherTongueBox.getSelectedItem();</b>
&nbsp;        }
<b class="nc">&nbsp;        config.setMotherTongue(motherTongue);</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    motherTonguePanel.add(motherTongueBox, cons);</b>
<b class="nc">&nbsp;    return motherTonguePanel;</b>
&nbsp;  }
&nbsp;
&nbsp;  private JPanel getNgramPanel() {
<b class="nc">&nbsp;    JPanel panel = new JPanel();</b>
<b class="nc">&nbsp;    panel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, 0, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    addNgramPanel(cons1, panel);</b>
<b class="nc">&nbsp;    return panel;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void addNgramPanel(GridBagConstraints cons, JPanel panel) {
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    panel.add(new JLabel((messages.getString(&quot;guiNgramDir&quot;)) + &quot;  &quot;), cons);</b>
<b class="nc">&nbsp;    File dir = config.getNgramDirectory();</b>
<b class="nc">&nbsp;    int maxDirDisplayLength = 45;</b>
<b class="nc">&nbsp;    String buttonText = dir != null ? StringUtils.abbreviate(dir.getAbsolutePath(), maxDirDisplayLength) : messages.getString(&quot;guiNgramDirSelect&quot;);</b>
<b class="nc">&nbsp;    JButton ngramDirButton = new JButton(buttonText);</b>
<b class="nc">&nbsp;    ngramDirButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      File newDir = Tools.openDirectoryDialog(owner, dir);</b>
<b class="nc">&nbsp;      if (newDir != null) {</b>
&nbsp;        try {
<b class="nc">&nbsp;          if (config.getLanguage() != null) {  // may happen in office context</b>
<b class="nc">&nbsp;            File checkDir = new File(newDir, config.getLanguage().getShortCode());</b>
<b class="nc">&nbsp;            LuceneLanguageModel.validateDirectory(checkDir);</b>
&nbsp;          }
<b class="nc">&nbsp;          config.setNgramDirectory(newDir);</b>
<b class="nc">&nbsp;          ngramDirButton.setText(StringUtils.abbreviate(newDir.getAbsolutePath(), maxDirDisplayLength));</b>
&nbsp;        } catch (Exception ex) {
<b class="nc">&nbsp;          Tools.showErrorMessage(ex);</b>
&nbsp;        }
&nbsp;      } else {
&nbsp;        // not the best UI, but this way user can turn off ngram feature without another checkbox
<b class="nc">&nbsp;        config.setNgramDirectory(null);</b>
<b class="nc">&nbsp;        ngramDirButton.setText(StringUtils.abbreviate(messages.getString(&quot;guiNgramDirSelect&quot;), maxDirDisplayLength));</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    cons.gridx++;</b>
<b class="nc">&nbsp;    panel.add(ngramDirButton, cons);</b>
<b class="nc">&nbsp;    JButton helpButton = new JButton(messages.getString(&quot;guiNgramHelp&quot;));</b>
<b class="nc">&nbsp;    helpButton.addActionListener(e -&gt; Tools.openURL(&quot;https://dev.languagetool.org/finding-errors-using-n-gram-data&quot;));</b>
<b class="nc">&nbsp;    cons.gridx++;</b>
<b class="nc">&nbsp;    panel.add(helpButton, cons);</b>
&nbsp;  }
&nbsp;
&nbsp;  private String[] getPossibleLanguages(boolean addNoSeletion) {
<b class="nc">&nbsp;    List&lt;String&gt; languages = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    if(addNoSeletion) {</b>
<b class="nc">&nbsp;      languages.add(NO_SELECTED_LANGUAGE);</b>
&nbsp;    }
<b class="nc">&nbsp;    for (Language lang : Languages.get()) {</b>
<b class="nc">&nbsp;      languages.add(lang.getTranslatedName(messages));</b>
<b class="nc">&nbsp;      languages.sort(null);</b>
&nbsp;    }
<b class="nc">&nbsp;    return languages.toArray(new String[0]);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;    if (ACTION_COMMAND_OK.equals(e.getActionCommand())) {</b>
<b class="nc">&nbsp;      if (original != null) {</b>
<b class="nc">&nbsp;        original.restoreState(config);</b>
&nbsp;      }
<b class="nc">&nbsp;      for(JPanel extra : extraPanels) {</b>
<b class="nc">&nbsp;        if(extra instanceof SavablePanel) {</b>
<b class="nc">&nbsp;          ((SavablePanel) extra).save();</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      if(insideOffice &amp;&amp; config.doRemoteCheck() &amp;&amp; config.useOtherServer()) {</b>
<b class="nc">&nbsp;        String serverName = config.getServerUrl();</b>
<b class="nc">&nbsp;        if(serverName == null || (!serverName.startsWith(&quot;http://&quot;) &amp;&amp; !serverName.startsWith(&quot;https://&quot;))</b>
<b class="nc">&nbsp;            || serverName.endsWith(&quot;/&quot;) || serverName.endsWith(&quot;/v2&quot;)) {</b>
<b class="nc">&nbsp;          JOptionPane.showMessageDialog(dialog, Tools.getLabel(messages.getString(&quot;guiUseServerWarning1&quot;)) + &quot;\n&quot; + Tools.getLabel(messages.getString(&quot;guiUseServerWarning2&quot;)));</b>
<b class="nc">&nbsp;          if(serverName.endsWith(&quot;/&quot;)) {</b>
<b class="nc">&nbsp;            serverName = serverName.substring(0, serverName.length() - 1);</b>
<b class="nc">&nbsp;            config.setOtherServerUrl(serverName);</b>
&nbsp;          }
<b class="nc">&nbsp;          if(serverName.endsWith(&quot;/v2&quot;)) {</b>
<b class="nc">&nbsp;            serverName = serverName.substring(0, serverName.length() - 3);</b>
<b class="nc">&nbsp;            config.setOtherServerUrl(serverName);</b>
&nbsp;          }
<b class="nc">&nbsp;          restartShow = true;</b>
<b class="nc">&nbsp;          dialog.setVisible(false);</b>
&nbsp;          return;
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      configChanged = true;</b>
<b class="nc">&nbsp;      dialog.setVisible(false);</b>
<b class="nc">&nbsp;    } else if (ACTION_COMMAND_CANCEL.equals(e.getActionCommand())) {</b>
<b class="nc">&nbsp;      dialog.setVisible(false);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Get the Language object for the given localized language name.
&nbsp;   * 
&nbsp;   * @param languageName e.g. &lt;code&gt;English&lt;/code&gt; or &lt;code&gt;German&lt;/code&gt; (case is significant)
&nbsp;   * @return a Language object or &lt;code&gt;null&lt;/code&gt; if the language could not be found
&nbsp;   */
&nbsp;  @Nullable
&nbsp;  private Language getLanguageForLocalizedName(String languageName) {
<b class="nc">&nbsp;    for (Language element : Languages.get()) {</b>
<b class="nc">&nbsp;      if (languageName.equals(element.getTranslatedName(messages))) {</b>
<b class="nc">&nbsp;        return element;</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return null;</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  static class CategoryComparator implements Comparator&lt;Rule&gt; {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public int compare(Rule r1, Rule r2) {
<b class="nc">&nbsp;      boolean hasCat = r1.getCategory() != null &amp;&amp; r2.getCategory() != null;</b>
<b class="nc">&nbsp;      if (hasCat) {</b>
<b class="nc">&nbsp;        int res = r1.getCategory().getName().compareTo(r2.getCategory().getName());</b>
<b class="nc">&nbsp;        if (res == 0) {</b>
<b class="nc">&nbsp;          return r1.getDescription() != null &amp;&amp; r2.getDescription() != null ? r1.getDescription().compareToIgnoreCase(r2.getDescription()) : 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        return res;</b>
&nbsp;      }
<b class="nc">&nbsp;      return r1.getDescription() != null &amp;&amp; r2.getDescription() != null ? r1.getDescription().compareToIgnoreCase(r2.getDescription()) : 0;</b>
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Update display of rules tree
&nbsp;   */
&nbsp;  private void updateRulesTrees(List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    String[] specialTabNames = config.getSpecialTabNames();</b>
<b class="nc">&nbsp;    int numConfigTrees = 2 + specialTabNames.length;</b>
<b class="nc">&nbsp;    for (int i = 0; i &lt; numConfigTrees; i++) {</b>
<b class="nc">&nbsp;      if(i == 0) {</b>
<b class="nc">&nbsp;        rootNode[i] = createTree(rules, false, null, rootNode[i]);   //  grammar options</b>
<b class="nc">&nbsp;      } else if(i == 1) {</b>
<b class="nc">&nbsp;        rootNode[i] = createTree(rules, true, null, rootNode[i]);    //  Style options</b>
&nbsp;      } else {
<b class="nc">&nbsp;        rootNode[i] = createTree(rules, true, specialTabNames[i - 2], rootNode[i]);    //  Special tab options</b>
&nbsp;      }
<b class="nc">&nbsp;      configTree[i].setModel(getTreeModel(rootNode[i], rules));</b>
&nbsp;    }
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Update display of profile rules
&nbsp;   */
&nbsp;  private void updateProfileRules(List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    getChangedRulesPanel(rules, false, disabledRulesPanel);</b>
<b class="nc">&nbsp;    getChangedRulesPanel(rules, true , enabledRulesPanel);</b>
&nbsp;  }
&nbsp;
&nbsp;  
&nbsp;  /** Panel to select disabled default rules
&nbsp;   * @since 5.4
&nbsp;   */
&nbsp;  private JPanel getChangedRulesPanel(List&lt;Rule&gt; rules, boolean enabledRules, JPanel panel) {
<b class="nc">&nbsp;    if (panel == null) {</b>
<b class="nc">&nbsp;      panel = new JPanel();</b>
&nbsp;    } else {
<b class="nc">&nbsp;      panel.removeAll();</b>
&nbsp;    }
<b class="nc">&nbsp;    panel.setBackground(new Color(169,169,169));</b>
<b class="nc">&nbsp;    panel.setBorder(BorderFactory.createLineBorder(Color.black));</b>
<b class="nc">&nbsp;    panel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 1.0f;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 3, 0, 4);</b>
&nbsp;    
&nbsp;    List&lt;String&gt; changedRuleIds;
<b class="nc">&nbsp;    if (enabledRules) {</b>
<b class="nc">&nbsp;      changedRuleIds = new ArrayList&lt;String&gt;(config.getEnabledRuleIds());</b>
&nbsp;    } else {
<b class="nc">&nbsp;      changedRuleIds = new ArrayList&lt;String&gt;(config.getDisabledRuleIds());</b>
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    if (changedRuleIds != null) {</b>
<b class="nc">&nbsp;      List&lt;JCheckBox&gt; ruleCheckboxes = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;      for (int i = changedRuleIds.size() - 1; i &gt;= 0; i--) {</b>
<b class="nc">&nbsp;        String ruleId = changedRuleIds.get(i);</b>
<b class="nc">&nbsp;        String ruleDescription = null;</b>
<b class="nc">&nbsp;        for (Rule rule : rules) {</b>
<b class="nc">&nbsp;          if (rule.getId().equals(ruleId)) {</b>
<b class="nc">&nbsp;            if ((enabledRules &amp;&amp; (rule.getCategory().isDefaultOff() || (rule.isDefaultOff() &amp;&amp; !rule.isOfficeDefaultOn()))) ||</b>
<b class="nc">&nbsp;                (!enabledRules &amp;&amp; !rule.getCategory().isDefaultOff() &amp;&amp; (!rule.isDefaultOff() || rule.isOfficeDefaultOn()))) {</b>
<b class="nc">&nbsp;              ruleDescription = rule.getDescription();</b>
&nbsp;            } else {
<b class="nc">&nbsp;              if (enabledRules) {</b>
<b class="nc">&nbsp;                config.removeEnabledRuleId(ruleId);</b>
&nbsp;              } else {
<b class="nc">&nbsp;                config.removeDisabledRuleId(ruleId);</b>
&nbsp;              }
&nbsp;            }
&nbsp;            
&nbsp;            break;
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        if (ruleDescription != null) {</b>
<b class="nc">&nbsp;          JCheckBox ruleCheckbox = new JCheckBox(ruleDescription);</b>
<b class="nc">&nbsp;          ruleCheckbox.setName(ruleId);</b>
<b class="nc">&nbsp;          ruleCheckboxes.add(ruleCheckbox);</b>
<b class="nc">&nbsp;          ruleCheckbox.setSelected(enabledRules);</b>
<b class="nc">&nbsp;          panel.add(ruleCheckbox, cons);</b>
<b class="nc">&nbsp;          ruleCheckbox.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;            if (ruleCheckbox.isSelected()) {</b>
<b class="nc">&nbsp;              config.getEnabledRuleIds().add(ruleCheckbox.getName());</b>
<b class="nc">&nbsp;              config.getDisabledRuleIds().remove(ruleCheckbox.getName());</b>
<b class="nc">&nbsp;              updateRulesTrees(rules);</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.getEnabledRuleIds().remove(ruleCheckbox.getName());</b>
<b class="nc">&nbsp;              config.getDisabledRuleIds().add(ruleCheckbox.getName());</b>
<b class="nc">&nbsp;              updateRulesTrees(rules);</b>
&nbsp;            }
&nbsp;          });
<b class="nc">&nbsp;          cons.gridx = 0;</b>
<b class="nc">&nbsp;          cons.gridy++;</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return panel;</b>
&nbsp;  }
&nbsp;  
&nbsp;  private String[] getUnderlineTypes() {
<b class="nc">&nbsp;    String[] types = {</b>
<b class="nc">&nbsp;      messages.getString(&quot;guiUTypeWave&quot;),</b>
<b class="nc">&nbsp;      messages.getString(&quot;guiUTypeBoldWave&quot;),</b>
<b class="nc">&nbsp;      messages.getString(&quot;guiUTypeBold&quot;),</b>
<b class="nc">&nbsp;      messages.getString(&quot;guiUTypeDash&quot;)};</b>
<b class="nc">&nbsp;    return types;</b>
&nbsp;  }
&nbsp;
&nbsp;  private int getUnderlineType(String category, String ruleId) {
<b class="nc">&nbsp;    short nType = config.getUnderlineType(category, ruleId);</b>
<b class="nc">&nbsp;    if (nType == Configuration.UNDERLINE_BOLDWAVE) {</b>
<b class="nc">&nbsp;      return 1;</b>
<b class="nc">&nbsp;    } else if (nType == Configuration.UNDERLINE_BOLD) {</b>
<b class="nc">&nbsp;      return 2;</b>
<b class="nc">&nbsp;    } else if (nType == Configuration.UNDERLINE_DASH) {</b>
<b class="nc">&nbsp;      return 3;</b>
&nbsp;    } else {
<b class="nc">&nbsp;      return 0;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void setUnderlineType(int index, String category, String ruleId) {
<b class="nc">&nbsp;    if (ruleId == null) {</b>
<b class="nc">&nbsp;      if (index == 1) {</b>
<b class="nc">&nbsp;        config.setUnderlineType(category, Configuration.UNDERLINE_BOLDWAVE);</b>
<b class="nc">&nbsp;      } else if (index == 2) {</b>
<b class="nc">&nbsp;        config.setUnderlineType(category, Configuration.UNDERLINE_BOLD);</b>
<b class="nc">&nbsp;      } else if (index == 3) {</b>
<b class="nc">&nbsp;        config.setUnderlineType(category, Configuration.UNDERLINE_DASH);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        config.setDefaultUnderlineType(category);</b>
&nbsp;      }
&nbsp;    } else {
<b class="nc">&nbsp;      if (index == 1) {</b>
<b class="nc">&nbsp;        config.setUnderlineRuleType(ruleId, Configuration.UNDERLINE_BOLDWAVE);</b>
<b class="nc">&nbsp;      } else if (index == 2) {</b>
<b class="nc">&nbsp;        config.setUnderlineRuleType(ruleId, Configuration.UNDERLINE_BOLD);</b>
<b class="nc">&nbsp;      } else if (index == 3) {</b>
<b class="nc">&nbsp;        config.setUnderlineRuleType(ruleId, Configuration.UNDERLINE_DASH);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        config.setDefaultUnderlineRuleType(ruleId);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**  Panel to choose underline Colors
&nbsp;   *   @since 4.2
&nbsp;   */
&nbsp;  JPanel getUnderlineColorPanel(List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    JPanel panel = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;    panel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;
<b class="nc">&nbsp;    List&lt;String&gt; categories = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (Rule rule : rules) {</b>
<b class="nc">&nbsp;      String category = rule.getCategory().getName();</b>
<b class="nc">&nbsp;      boolean contain = false;</b>
<b class="nc">&nbsp;      for(String c : categories) {</b>
<b class="nc">&nbsp;        if (c.equals(category)) {</b>
<b class="nc">&nbsp;          contain = true;</b>
&nbsp;          break;
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      if (!contain) {</b>
<b class="nc">&nbsp;        categories.add(category);</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    List&lt;JLabel&gt; categoryLabel = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;JLabel&gt; underlineLabel = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;JButton&gt; changeButton = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;JButton&gt; defaultButton = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;JComboBox&lt;String&gt;&gt; underlineType  = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for(int nCat = 0; nCat &lt; categories.size(); nCat++) {</b>
<b class="nc">&nbsp;      categoryLabel.add(new JLabel(categories.get(nCat) + &quot; &quot;));</b>
<b class="nc">&nbsp;      underlineLabel.add(new JLabel(&quot; \u2588\u2588\u2588 &quot;));  // \u2587 is smaller</b>
<b class="nc">&nbsp;      underlineLabel.get(nCat).setForeground(config.getUnderlineColor(categories.get(nCat), null));</b>
<b class="nc">&nbsp;      underlineLabel.get(nCat).setBackground(config.getUnderlineColor(categories.get(nCat), null));</b>
<b class="nc">&nbsp;      JLabel uLabel = underlineLabel.get(nCat);</b>
<b class="nc">&nbsp;      String cLabel = categories.get(nCat);</b>
<b class="nc">&nbsp;      panel.add(categoryLabel.get(nCat), cons);</b>
&nbsp;
<b class="nc">&nbsp;      underlineType.add(new JComboBox&lt;&gt;(getUnderlineTypes()));</b>
<b class="nc">&nbsp;      JComboBox&lt;String&gt; uLineType = underlineType.get(nCat);</b>
<b class="nc">&nbsp;      if(insideOffice) {</b>
<b class="nc">&nbsp;        uLineType.setSelectedIndex(getUnderlineType(cLabel, null));</b>
<b class="nc">&nbsp;        uLineType.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;          if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;            setUnderlineType(uLineType.getSelectedIndex(), cLabel, null);</b>
&nbsp;          }
&nbsp;        });
<b class="nc">&nbsp;        cons.gridx++;</b>
<b class="nc">&nbsp;        panel.add(uLineType, cons);</b>
&nbsp;      }
<b class="nc">&nbsp;      cons.gridx++;</b>
<b class="nc">&nbsp;      panel.add(underlineLabel.get(nCat), cons);</b>
&nbsp;
<b class="nc">&nbsp;      changeButton.add(new JButton(messages.getString(&quot;guiUColorChange&quot;)));</b>
<b class="nc">&nbsp;      changeButton.get(nCat).addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;        Color oldColor = uLabel.getForeground();</b>
<b class="nc">&nbsp;        if(insideOffice) {</b>
<b class="nc">&nbsp;          dialog.setAlwaysOnTop(false);</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        JColorChooser colorChooser = new JColorChooser(oldColor);</b>
<b class="nc">&nbsp;        ActionListener okActionListener = new ActionListener() {</b>
&nbsp;          public void actionPerformed(ActionEvent actionEvent) {
<b class="nc">&nbsp;            Color newColor = colorChooser.getColor();</b>
<b class="nc">&nbsp;            if(newColor != null &amp;&amp; newColor != oldColor) {</b>
<b class="nc">&nbsp;              uLabel.setForeground(newColor);</b>
<b class="nc">&nbsp;              config.setUnderlineColor(cLabel, newColor);</b>
&nbsp;            }
<b class="nc">&nbsp;            if(insideOffice) {</b>
<b class="nc">&nbsp;              dialog.setAlwaysOnTop(true);</b>
&nbsp;            }
&nbsp;          }
&nbsp;        };
&nbsp;        // For cancel selection, change button background to red
<b class="nc">&nbsp;        ActionListener cancelActionListener = new ActionListener() {</b>
&nbsp;          public void actionPerformed(ActionEvent actionEvent) {
<b class="nc">&nbsp;            if(insideOffice) {</b>
<b class="nc">&nbsp;              dialog.setAlwaysOnTop(true);</b>
&nbsp;            }
&nbsp;          }
&nbsp;        };
<b class="nc">&nbsp;        JDialog colorDialog = JColorChooser.createDialog(dialog, messages.getString(&quot;guiUColorDialogHeader&quot;), true,</b>
&nbsp;            colorChooser, okActionListener, cancelActionListener);
<b class="nc">&nbsp;        if(insideOffice) {</b>
<b class="nc">&nbsp;          colorDialog.setAlwaysOnTop(true);</b>
&nbsp;        }
<b class="nc">&nbsp;        colorDialog.toFront();</b>
<b class="nc">&nbsp;        colorDialog.setVisible(true);</b>
&nbsp;/*
&nbsp;        Color newColor = JColorChooser.showDialog(null, messages.getString(&quot;guiUColorDialogHeader&quot;), oldColor);
&nbsp;        if(newColor != null &amp;&amp; newColor != oldColor) {
&nbsp;          uLabel.setForeground(newColor);
&nbsp;          config.setUnderlineColor(cLabel, newColor);
&nbsp;        }
&nbsp;        if(insideOffice) {
&nbsp;          dialog.setAlwaysOnTop(true);
&nbsp;        }
&nbsp;*/
&nbsp;      });
<b class="nc">&nbsp;      cons.gridx++;</b>
<b class="nc">&nbsp;      panel.add(changeButton.get(nCat), cons);</b>
&nbsp;  
<b class="nc">&nbsp;      defaultButton.add(new JButton(messages.getString(&quot;guiUColorDefault&quot;)));</b>
<b class="nc">&nbsp;      defaultButton.get(nCat).addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;        config.setDefaultUnderlineColor(cLabel);</b>
<b class="nc">&nbsp;        uLabel.setForeground(config.getUnderlineColor(cLabel, null));</b>
<b class="nc">&nbsp;        if(insideOffice) {</b>
<b class="nc">&nbsp;          config.setDefaultUnderlineType(cLabel);</b>
<b class="nc">&nbsp;          uLineType.setSelectedIndex(getUnderlineType(cLabel, null));</b>
&nbsp;        }
&nbsp;      });
<b class="nc">&nbsp;      cons.gridx++;</b>
<b class="nc">&nbsp;      panel.add(defaultButton.get(nCat), cons);</b>
<b class="nc">&nbsp;      cons.gridx = 0;</b>
<b class="nc">&nbsp;      cons.gridy++;</b>
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    return panel;</b>
&nbsp;  }
&nbsp;
&nbsp;  /**  Panel to choose underline Colors
&nbsp;   *   and rule options (if exists)
&nbsp;   *   @since 5.3
&nbsp;   */
&nbsp;  @NotNull
&nbsp;  private JPanel getRuleOptionsPanel(int num) {
<b class="nc">&nbsp;    category = &quot;&quot;;</b>
<b class="nc">&nbsp;    rule = null;</b>
<b class="nc">&nbsp;    JPanel ruleOptionsPanel = new JPanel();</b>
<b class="nc">&nbsp;    ruleOptionsPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons0 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons0.gridx = 0;</b>
<b class="nc">&nbsp;    cons0.gridy = 0;</b>
<b class="nc">&nbsp;    cons0.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons0.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;    cons0.weightx = 2.0f;</b>
<b class="nc">&nbsp;    cons0.weighty = 0.0f;</b>
<b class="nc">&nbsp;    cons0.insets = new Insets(3, 8, 3, 0);</b>
<b class="nc">&nbsp;    ruleOptionsPanel.setBorder(BorderFactory.createLineBorder(Color.black));</b>
&nbsp;    
&nbsp;    //  Color Panel
<b class="nc">&nbsp;    JPanel colorPanel = new JPanel();</b>
<b class="nc">&nbsp;    colorPanel.setLayout(null);</b>
<b class="nc">&nbsp;    colorPanel.setBounds(0, 0, 120, 10);</b>
&nbsp;
<b class="nc">&nbsp;    colorPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, 0, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;
<b class="nc">&nbsp;    JLabel underlineStyle = new JLabel(messages.getString(&quot;guiUColorStyleLabel&quot;) + &quot; &quot;);</b>
<b class="nc">&nbsp;    colorPanel.add(underlineStyle);</b>
&nbsp;
<b class="nc">&nbsp;    JLabel underlineLabel = new JLabel(&quot; \u2588\u2588\u2588 &quot;);  // \u2587 is smaller</b>
&nbsp;
<b class="nc">&nbsp;    JComboBox&lt;String&gt; underlineType = new JComboBox&lt;&gt;(getUnderlineTypes());</b>
<b class="nc">&nbsp;    if(insideOffice) {</b>
<b class="nc">&nbsp;      underlineType.setSelectedIndex(getUnderlineType(category, (rule == null ? null : rule.getId())));</b>
<b class="nc">&nbsp;      underlineType.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;        if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;          setUnderlineType(underlineType.getSelectedIndex(), category, (rule == null ? null : rule.getId()));</b>
&nbsp;        }
&nbsp;      });
<b class="nc">&nbsp;      cons1.gridx++;</b>
<b class="nc">&nbsp;      colorPanel.add(underlineType);</b>
&nbsp;    }
<b class="nc">&nbsp;    cons1.gridx++;</b>
<b class="nc">&nbsp;    colorPanel.add(underlineLabel);</b>
&nbsp;
<b class="nc">&nbsp;    JButton changeButton = new JButton(messages.getString(&quot;guiUColorChange&quot;));</b>
<b class="nc">&nbsp;    changeButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      Color oldColor = underlineLabel.getForeground();</b>
<b class="nc">&nbsp;      if(insideOffice) {</b>
<b class="nc">&nbsp;        dialog.setAlwaysOnTop(false);</b>
&nbsp;      }
<b class="nc">&nbsp;      JColorChooser colorChooser = new JColorChooser(oldColor);</b>
<b class="nc">&nbsp;      ActionListener okActionListener = new ActionListener() {</b>
&nbsp;        public void actionPerformed(ActionEvent actionEvent) {
<b class="nc">&nbsp;          Color newColor = colorChooser.getColor();</b>
<b class="nc">&nbsp;          if(newColor != null &amp;&amp; newColor != oldColor) {</b>
<b class="nc">&nbsp;            underlineLabel.setForeground(newColor);</b>
<b class="nc">&nbsp;            if (rule == null) {</b>
<b class="nc">&nbsp;              config.setUnderlineColor(category, newColor);</b>
&nbsp;            } else {
<b class="nc">&nbsp;              config.setUnderlineRuleColor(rule.getId(), newColor);</b>
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;          if(insideOffice) {</b>
<b class="nc">&nbsp;            dialog.setAlwaysOnTop(true);</b>
&nbsp;          }
&nbsp;        }
&nbsp;      };
&nbsp;      // For cancel selection, change button background to red
<b class="nc">&nbsp;      ActionListener cancelActionListener = new ActionListener() {</b>
&nbsp;        public void actionPerformed(ActionEvent actionEvent) {
<b class="nc">&nbsp;          if(insideOffice) {</b>
<b class="nc">&nbsp;            dialog.setAlwaysOnTop(true);</b>
&nbsp;          }
&nbsp;        }
&nbsp;      };
<b class="nc">&nbsp;      JDialog colorDialog = JColorChooser.createDialog(dialog, messages.getString(&quot;guiUColorDialogHeader&quot;), true,</b>
&nbsp;          colorChooser, okActionListener, cancelActionListener);
<b class="nc">&nbsp;      if(insideOffice) {</b>
<b class="nc">&nbsp;        colorDialog.setAlwaysOnTop(true);</b>
&nbsp;      }
<b class="nc">&nbsp;      colorDialog.toFront();</b>
<b class="nc">&nbsp;      colorDialog.setVisible(true);</b>
&nbsp;/*      
&nbsp;      Color newColor = JColorChooser.showDialog( null, messages.getString(&quot;guiUColorDialogHeader&quot;), oldColor);
&nbsp;      if(newColor != null &amp;&amp; newColor != oldColor) {
&nbsp;        underlineLabel.setForeground(newColor);
&nbsp;        if (rule == null) {
&nbsp;          config.setUnderlineColor(category, newColor);
&nbsp;        } else {
&nbsp;          config.setUnderlineRuleColor(rule.getId(), newColor);
&nbsp;        }
&nbsp;      }
&nbsp;      if(insideOffice) {
&nbsp;        dialog.setAlwaysOnTop(true);
&nbsp;      }
&nbsp;*/
&nbsp;    });
<b class="nc">&nbsp;    cons1.gridx++;</b>
<b class="nc">&nbsp;    colorPanel.add(changeButton);</b>
&nbsp;  
<b class="nc">&nbsp;    JButton defaultButton = new JButton(messages.getString(&quot;guiUColorDefault&quot;));</b>
<b class="nc">&nbsp;    defaultButton.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;      String ruleId = (rule == null ? null : rule.getId());</b>
<b class="nc">&nbsp;      if (rule == null) {</b>
<b class="nc">&nbsp;        config.setDefaultUnderlineColor(category);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        config.setDefaultUnderlineRuleColor(ruleId);</b>
&nbsp;      }
<b class="nc">&nbsp;      underlineLabel.setForeground(config.getUnderlineColor(category, ruleId));</b>
<b class="nc">&nbsp;      if(insideOffice) {</b>
<b class="nc">&nbsp;        if ( rule == null) {</b>
<b class="nc">&nbsp;          config.setDefaultUnderlineType(category);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          config.setDefaultUnderlineRuleType(ruleId);</b>
&nbsp;        }
<b class="nc">&nbsp;        underlineType.setSelectedIndex(getUnderlineType(category, ruleId));</b>
&nbsp;      }
<b class="nc">&nbsp;      config.removeConfigurableValue(ruleId);</b>
&nbsp;    });
<b class="nc">&nbsp;    cons1.gridx++;</b>
<b class="nc">&nbsp;    colorPanel.add(defaultButton);</b>
<b class="nc">&nbsp;    colorPanel.setVisible(false);</b>
&nbsp;    // End of Color Panel
&nbsp;    
<b class="nc">&nbsp;    List&lt;JPanel&gt; specialOptionPanels = new ArrayList&lt;&gt;();</b>
&nbsp;    
<b class="nc">&nbsp;    ruleOptionsPanel.add(colorPanel, cons0);</b>
<b class="nc">&nbsp;    cons0.gridx = 0;</b>
<b class="nc">&nbsp;    cons0.gridy = 1;</b>
&nbsp;    
<b class="nc">&nbsp;    configTree[num].addTreeSelectionListener(e -&gt; {</b>
<b class="nc">&nbsp;      DefaultMutableTreeNode node = (DefaultMutableTreeNode)</b>
<b class="nc">&nbsp;          configTree[num].getLastSelectedPathComponent();</b>
<b class="nc">&nbsp;      if (node != null) {</b>
<b class="nc">&nbsp;        if (specialOptionPanels.size() &gt; 0) {</b>
<b class="nc">&nbsp;          for (JPanel optionPanel : specialOptionPanels) {</b>
<b class="nc">&nbsp;            optionPanel.setVisible(false);</b>
<b class="nc">&nbsp;            ruleOptionsPanel.remove(optionPanel);</b>
&nbsp;          }
<b class="nc">&nbsp;          specialOptionPanels.clear();</b>
&nbsp;        }
<b class="nc">&nbsp;        ruleOptionsPanel.setVisible(false);</b>
<b class="nc">&nbsp;        if (node instanceof RuleNode) {</b>
<b class="nc">&nbsp;          RuleNode o = (RuleNode) node;</b>
<b class="nc">&nbsp;          rule = o.getRule();</b>
<b class="nc">&nbsp;          category = rule.getCategory().getName();</b>
<b class="nc">&nbsp;          String ruleId = rule.getId();</b>
<b class="nc">&nbsp;          underlineLabel.setForeground(config.getUnderlineColor(category, ruleId));</b>
<b class="nc">&nbsp;          underlineLabel.setBackground(config.getUnderlineColor(category, ruleId));</b>
<b class="nc">&nbsp;          if(insideOffice) {</b>
<b class="nc">&nbsp;            underlineType.setSelectedIndex(getUnderlineType(category, ruleId));</b>
&nbsp;          }
<b class="nc">&nbsp;          colorPanel.setVisible(true);</b>
<b class="nc">&nbsp;          RuleOption[] ruleOptions = rule.getRuleOptions();</b>
<b class="nc">&nbsp;          if (ruleOptions != null &amp;&amp; ruleOptions.length &gt; 0) {</b>
<b class="nc">&nbsp;            Object[] obj = new Object[ruleOptions.length];</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; ruleOptions.length; i++) {</b>
&nbsp;              // Start of special option panel
<b class="nc">&nbsp;              JPanel specialOptionPanel = new JPanel();</b>
<b class="nc">&nbsp;              specialOptionPanels.add(specialOptionPanel);</b>
<b class="nc">&nbsp;              specialOptionPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;              GridBagConstraints cons2 = new GridBagConstraints();</b>
<b class="nc">&nbsp;              cons2.gridx = 0;</b>
<b class="nc">&nbsp;              cons2.gridy = 0;</b>
<b class="nc">&nbsp;              cons2.weightx = 2.0f;</b>
<b class="nc">&nbsp;              cons2.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;              RuleOption ruleOption = ruleOptions[i];</b>
<b class="nc">&nbsp;              int n = i;</b>
&nbsp;
<b class="nc">&nbsp;              Object defValue = ruleOption.getDefaultValue();</b>
&nbsp;              
<b class="nc">&nbsp;              if (defValue instanceof Boolean) {</b>
<b class="nc">&nbsp;                JCheckBox isTrueBox = new JCheckBox(ruleOption.getConfigureText());</b>
<b class="nc">&nbsp;                boolean value = config.getConfigValueByID(rule.getId(), i, Boolean.class, (Boolean) defValue);</b>
<b class="nc">&nbsp;                isTrueBox.setSelected(value);</b>
<b class="nc">&nbsp;                obj[n] = value;</b>
<b class="nc">&nbsp;                isTrueBox.addItemListener(e1 -&gt; {</b>
<b class="nc">&nbsp;                  obj[n] = isTrueBox.isSelected();</b>
<b class="nc">&nbsp;                  config.setConfigurableValue(rule.getId(), obj);</b>
&nbsp;                });
<b class="nc">&nbsp;                specialOptionPanel.add(isTrueBox, cons2);</b>
&nbsp;              } else {
<b class="nc">&nbsp;                JLabel ruleLabel = new JLabel(ruleOption.getConfigureText() + &quot; &quot;);</b>
<b class="nc">&nbsp;                specialOptionPanel.add(ruleLabel, cons2);</b>
&nbsp;    
<b class="nc">&nbsp;                cons2.gridx++;</b>
<b class="nc">&nbsp;                JTextField ruleValueField = new JTextField(&quot;   &quot;, 3);</b>
<b class="nc">&nbsp;                ruleValueField.setMinimumSize(new Dimension(50, 28));  // without this the box is just a few pixels small, but why?</b>
&nbsp;                String fieldValue;
<b class="nc">&nbsp;                if (defValue instanceof Integer) {</b>
<b class="nc">&nbsp;                  obj[n] = (int) config.getConfigValueByID(rule.getId(), i, Integer.class, (Integer) defValue);</b>
<b class="nc">&nbsp;                  fieldValue = Integer.toString((int) obj[n]);</b>
<b class="nc">&nbsp;                } else if (defValue instanceof Character) {</b>
<b class="nc">&nbsp;                  obj[n] = (char) config.getConfigValueByID(rule.getId(), i, Character.class, (Character) defValue);</b>
<b class="nc">&nbsp;                  fieldValue = Character.toString((char) obj[n]);</b>
<b class="nc">&nbsp;                } else if (defValue instanceof Double) {</b>
<b class="nc">&nbsp;                  obj[n] = (double) config.getConfigValueByID(rule.getId(), i, Double.class, (Double) defValue);</b>
<b class="nc">&nbsp;                  fieldValue = Double.toString((double) obj[n]);</b>
<b class="nc">&nbsp;                } else if (defValue instanceof Float) {</b>
<b class="nc">&nbsp;                  obj[n] = (float) config.getConfigValueByID(rule.getId(), i, Float.class, (Float) defValue);</b>
<b class="nc">&nbsp;                  fieldValue = Float.toString((float) obj[n]);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                  obj[n] = (String) config.getConfigValueByID(rule.getId(), i, String.class, (String) defValue);</b>
<b class="nc">&nbsp;                  fieldValue = (String) obj[n];</b>
&nbsp;                }
<b class="nc">&nbsp;                ruleValueField.setText(fieldValue);</b>
<b class="nc">&nbsp;                specialOptionPanel.add(ruleValueField, cons2);</b>
&nbsp;    
<b class="nc">&nbsp;                ruleValueField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;                  @Override
&nbsp;                  public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;                    changedUpdate(e);</b>
&nbsp;                  }
&nbsp;    
&nbsp;                  @Override
&nbsp;                  public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;                    changedUpdate(e);</b>
&nbsp;                  }
&nbsp;    
&nbsp;                  @Override
&nbsp;                  public void changedUpdate(DocumentEvent e) {
&nbsp;                    try {
<b class="nc">&nbsp;                      if (rule != null) {</b>
<b class="nc">&nbsp;                        RuleOption[] ruleOptions = rule.getRuleOptions();</b>
<b class="nc">&nbsp;                        if (ruleOptions != null &amp;&amp; ruleOptions.length &gt; 0) {</b>
<b class="nc">&nbsp;                          boolean isCorrect = false;</b>
<b class="nc">&nbsp;                          if (defValue instanceof Integer) {</b>
<b class="nc">&nbsp;                            int num = Integer.parseInt(ruleValueField.getText());</b>
<b class="nc">&nbsp;                            if (num &lt; (int) ruleOption.getMinConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (int) ruleOption.getMinConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
<b class="nc">&nbsp;                            } else if (num &gt; (int) ruleOption.getMaxConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (int) ruleOption.getMaxConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                              ruleValueField.setForeground(null);</b>
<b class="nc">&nbsp;                              isCorrect = true;</b>
<b class="nc">&nbsp;                              obj[n] = num;</b>
&nbsp;                            }
<b class="nc">&nbsp;                          } else if (defValue instanceof Character) {</b>
<b class="nc">&nbsp;                            char num = ruleValueField.getText().charAt(0);</b>
<b class="nc">&nbsp;                            if (num &lt; (char) ruleOption.getMinConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (char) ruleOption.getMinConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
<b class="nc">&nbsp;                            } else if (num &gt; (char) ruleOption.getMaxConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (char) ruleOption.getMaxConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                              ruleValueField.setForeground(null);</b>
<b class="nc">&nbsp;                              isCorrect = true;</b>
<b class="nc">&nbsp;                              obj[n] = num;</b>
&nbsp;                            }
<b class="nc">&nbsp;                          } else if (defValue instanceof Double) {</b>
<b class="nc">&nbsp;                            double num = Double.parseDouble(ruleValueField.getText());</b>
<b class="nc">&nbsp;                            if (num &lt; (double) ruleOption.getMinConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (double) ruleOption.getMinConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
<b class="nc">&nbsp;                            } else if (num &gt; (double) ruleOption.getMaxConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (double) ruleOption.getMaxConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                              ruleValueField.setForeground(null);</b>
<b class="nc">&nbsp;                              isCorrect = true;</b>
<b class="nc">&nbsp;                              obj[n] = num;</b>
&nbsp;                            }
<b class="nc">&nbsp;                          } else if (defValue instanceof Float) {</b>
<b class="nc">&nbsp;                            float num = Float.parseFloat(ruleValueField.getText());</b>
<b class="nc">&nbsp;                            if (num &lt; (float) ruleOption.getMinConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (float) ruleOption.getMinConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
<b class="nc">&nbsp;                            } else if (num &gt; (float) ruleOption.getMaxConfigurableValue()) {</b>
<b class="nc">&nbsp;                              num = (float) ruleOption.getMaxConfigurableValue();</b>
<b class="nc">&nbsp;                              ruleValueField.setForeground(Color.RED);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                              ruleValueField.setForeground(null);</b>
<b class="nc">&nbsp;                              isCorrect = true;</b>
<b class="nc">&nbsp;                              obj[n] = num;</b>
&nbsp;                            }
&nbsp;                          } else {
<b class="nc">&nbsp;                            String num = ruleValueField.getText();</b>
<b class="nc">&nbsp;                            ruleValueField.setForeground(null);</b>
<b class="nc">&nbsp;                            isCorrect = true;</b>
<b class="nc">&nbsp;                            obj[n] = num;</b>
&nbsp;                          }
<b class="nc">&nbsp;                          if (isCorrect) {</b>
<b class="nc">&nbsp;                            config.setConfigurableValue(rule.getId(), obj);</b>
&nbsp;                          }
&nbsp;                        }
&nbsp;                      }
&nbsp;                    } catch (Exception ex) {
<b class="nc">&nbsp;                      ruleValueField.setForeground(Color.RED);</b>
&nbsp;                    }
&nbsp;                  }
&nbsp;                });
&nbsp;              }
<b class="nc">&nbsp;              ruleOptionsPanel.add(specialOptionPanel, cons0);</b>
<b class="nc">&nbsp;              ruleOptionsPanel.setBorder(BorderFactory.createLineBorder(Color.black));</b>
<b class="nc">&nbsp;              ruleOptionsPanel.setVisible(true);</b>
<b class="nc">&nbsp;              cons0.gridy++;</b>
&nbsp;              // End of special option panel
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;        } else if (node instanceof CategoryNode) {</b>
<b class="nc">&nbsp;          CategoryNode o = (CategoryNode) node;</b>
<b class="nc">&nbsp;          category = o.getCategory().getName();</b>
<b class="nc">&nbsp;          underlineLabel.setForeground(config.getUnderlineColor(category, null));</b>
<b class="nc">&nbsp;          underlineLabel.setBackground(config.getUnderlineColor(category, null));</b>
<b class="nc">&nbsp;          if(insideOffice) {</b>
<b class="nc">&nbsp;            underlineType.setSelectedIndex(getUnderlineType(category, null));</b>
&nbsp;          }
<b class="nc">&nbsp;          colorPanel.setVisible(true);</b>
<b class="nc">&nbsp;          rule = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        ruleOptionsPanel.setVisible(true);</b>
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    return ruleOptionsPanel;</b>
&nbsp;  }
&nbsp;  
&nbsp;  private JPanel getOfficeAiElements() {
<b class="nc">&nbsp;    JPanel aiOptionPanel = new JPanel();</b>
<b class="nc">&nbsp;    aiOptionPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons.insets = new Insets(6, 6, 6, 6);</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 0;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    cons.weightx = 0.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 0.0f;</b>
&nbsp;    
<b class="nc">&nbsp;    JLabel otherUrlLabel = new JLabel(messages.getString(&quot;guiAiUrl&quot;) + &quot;:&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    JTextField aiUrlField = new JTextField(config.aiUrl() ==  null ? &quot;&quot; : config.aiUrl(), 25);</b>
<b class="nc">&nbsp;    aiUrlField.setMinimumSize(new Dimension(100, 25));</b>
<b class="nc">&nbsp;    aiUrlField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        String serverName = aiUrlField.getText();</b>
<b class="nc">&nbsp;        serverName = serverName.trim();</b>
<b class="nc">&nbsp;        if(serverName.isEmpty()) {</b>
<b class="nc">&nbsp;          serverName = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (config.isValidAiServerUrl(serverName)) {</b>
<b class="nc">&nbsp;          aiUrlField.setForeground(Color.BLACK);</b>
<b class="nc">&nbsp;          config.setAiUrl(serverName);;</b>
&nbsp;        } else {
<b class="nc">&nbsp;          aiUrlField.setForeground(Color.RED);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JLabel modelLabel = new JLabel(messages.getString(&quot;guiAiModel&quot;) + &quot;:&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    JTextField modelField = new JTextField(config.aiModel() ==  null ? &quot;&quot; : config.aiModel(), 25);</b>
<b class="nc">&nbsp;    modelField.setMinimumSize(new Dimension(100, 25));</b>
<b class="nc">&nbsp;    modelField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        String model = modelField.getText();</b>
<b class="nc">&nbsp;        model = model.trim();</b>
<b class="nc">&nbsp;        if(model.isEmpty()) {</b>
<b class="nc">&nbsp;          model = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (model != null) {</b>
<b class="nc">&nbsp;          config.setAiModel(model);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JLabel apiKeyLabel = new JLabel(messages.getString(&quot;guiAiApiKey&quot;) + &quot;:&quot;);</b>
&nbsp;
<b class="nc">&nbsp;    JTextField apiKeyField = new JTextField(config.aiApiKey() ==  null ? &quot;&quot; : config.aiApiKey(), 25);</b>
<b class="nc">&nbsp;    apiKeyField.setMinimumSize(new Dimension(100, 25));</b>
<b class="nc">&nbsp;    apiKeyField.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        changedUpdate(e);</b>
&nbsp;      }
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        String apiKey = apiKeyField.getText();</b>
<b class="nc">&nbsp;        apiKey = apiKey.trim();</b>
<b class="nc">&nbsp;        if(apiKey.isEmpty()) {</b>
<b class="nc">&nbsp;          apiKey = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (apiKey != null) {</b>
<b class="nc">&nbsp;          config.setAiApiKey(apiKey);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    JCheckBox showStylisticChangesBox = new JCheckBox(messages.getString(&quot;guiAiShowStylisticChanges&quot;));</b>
<b class="nc">&nbsp;    showStylisticChangesBox.setSelected(config.aiShowStylisticChanges());</b>
<b class="nc">&nbsp;    showStylisticChangesBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setAiShowStylisticChanges(showStylisticChangesBox.isSelected());</b>
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JCheckBox autoCorrectBox = new JCheckBox(messages.getString(&quot;guiAiAutoCorrect&quot;));</b>
<b class="nc">&nbsp;    autoCorrectBox.setSelected(config.aiAutoCorrect());</b>
<b class="nc">&nbsp;    autoCorrectBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setAiAutoCorrect(autoCorrectBox.isSelected());</b>
<b class="nc">&nbsp;      showStylisticChangesBox.setEnabled(autoCorrectBox.isSelected());</b>
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    JCheckBox useAiSupportBox = new JCheckBox(messages.getString(&quot;guiUseAiSupport&quot;));</b>
<b class="nc">&nbsp;    useAiSupportBox.setSelected(config.useAiSupport());</b>
<b class="nc">&nbsp;    useAiSupportBox.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;      config.setUseAiSupport(useAiSupportBox.isSelected());</b>
<b class="nc">&nbsp;      aiUrlField.setEnabled(useAiSupportBox.isSelected());</b>
<b class="nc">&nbsp;      modelField.setEnabled(useAiSupportBox.isSelected());</b>
<b class="nc">&nbsp;      apiKeyField.setEnabled(useAiSupportBox.isSelected());</b>
<b class="nc">&nbsp;      autoCorrectBox.setEnabled(useAiSupportBox.isSelected());</b>
<b class="nc">&nbsp;      showStylisticChangesBox.setEnabled(useAiSupportBox.isSelected() &amp;&amp; autoCorrectBox.isSelected());</b>
&nbsp;    });
&nbsp;    
<b class="nc">&nbsp;    aiUrlField.setEnabled(config.useAiSupport());</b>
<b class="nc">&nbsp;    modelField.setEnabled(config.useAiSupport());</b>
<b class="nc">&nbsp;    apiKeyField.setEnabled(config.useAiSupport());</b>
<b class="nc">&nbsp;    autoCorrectBox.setEnabled(config.useAiSupport());</b>
<b class="nc">&nbsp;    showStylisticChangesBox.setEnabled(config.useAiSupport() &amp;&amp; config.aiAutoCorrect());</b>
&nbsp;
<b class="nc">&nbsp;    JLabel experimentalHint = new JLabel(messages.getString(&quot;guiAiExperimentalHint&quot;));</b>
<b class="nc">&nbsp;    experimentalHint.setForeground(Color.red);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    aiOptionPanel.add(experimentalHint, cons);</b>
<b class="nc">&nbsp;    JLabel qualityHint = new JLabel(messages.getString(&quot;guiAiQualityHint&quot;));</b>
<b class="nc">&nbsp;    qualityHint.setForeground(Color.blue);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    aiOptionPanel.add(qualityHint, cons);</b>
<b class="nc">&nbsp;    JLabel tmp = new JLabel(&quot; &quot;);</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    aiOptionPanel.add(tmp, cons);</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    aiOptionPanel.add(useAiSupportBox, cons);</b>
<b class="nc">&nbsp;    JPanel serverPanel = new JPanel();</b>
<b class="nc">&nbsp;    serverPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;    GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;    cons1.insets = new Insets(0, SHIFT2, 0, 0);</b>
<b class="nc">&nbsp;    cons1.gridx = 0;</b>
<b class="nc">&nbsp;    cons1.gridy = 0;</b>
<b class="nc">&nbsp;    cons1.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;    cons1.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;    cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;    serverPanel.add(otherUrlLabel, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    serverPanel.add(aiUrlField, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    serverPanel.add(modelLabel, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    serverPanel.add(modelField, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    serverPanel.add(apiKeyLabel, cons1);</b>
<b class="nc">&nbsp;    cons1.gridy++;</b>
<b class="nc">&nbsp;    serverPanel.add(apiKeyField, cons1);</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    aiOptionPanel.add(serverPanel, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    aiOptionPanel.add(autoCorrectBox, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    cons.gridy++;</b>
<b class="nc">&nbsp;    cons.insets = new Insets(0, SHIFT3, 0, 0);</b>
<b class="nc">&nbsp;    aiOptionPanel.add(showStylisticChangesBox, cons);</b>
&nbsp;    
<b class="nc">&nbsp;    return aiOptionPanel;</b>
&nbsp;  }
&nbsp;  
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-02-17 23:51</div>
</div>
</body>
</html>
