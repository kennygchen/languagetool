


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Main</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.languagetool.gui</a>
</div>

<h1>Coverage Summary for Class: Main (org.languagetool.gui)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Main</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/180)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/580)
  </span>
</td>
</tr>
  <tr>
    <td class="name">Main$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/49)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$AboutAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$AddRulesAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$AutoCheckAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$CheckAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$CheckClipboardAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$ClearTextAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$CloseListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$ControlReturnTextCheckingListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$HideAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$OpenAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$OptionsAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$PlainTextFileFilter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$QuitAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$RecentFileAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$SaveAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$SaveAsAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$SelectAllAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$SelectFontAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$SelectLFAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$ShowResultAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$TagTextAction</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$TextLineNumber</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/91)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$TextLineNumber$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$TrayActionItemListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$TrayActionListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Main$TrayActionRMBListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/135)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/252)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/936)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/* LanguageTool, a natural language style checker 
&nbsp; * Copyright (C) 2005 Daniel Naber (http://www.danielnaber.de)
&nbsp; * 
&nbsp; * This library is free software; you can redistribute it and/or
&nbsp; * modify it under the terms of the GNU Lesser General Public
&nbsp; * License as published by the Free Software Foundation; either
&nbsp; * version 2.1 of the License, or (at your option) any later version.
&nbsp; *
&nbsp; * This library is distributed in the hope that it will be useful,
&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
&nbsp; * Lesser General Public License for more details.
&nbsp; *
&nbsp; * You should have received a copy of the GNU Lesser General Public
&nbsp; * License along with this library; if not, write to the Free Software
&nbsp; * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301
&nbsp; * USA
&nbsp; */
&nbsp;package org.languagetool.gui;
&nbsp;
&nbsp;import java.awt.AWTException;
&nbsp;import java.awt.CheckboxMenuItem;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.Component;
&nbsp;import java.awt.ComponentOrientation;
&nbsp;import java.awt.Container;
&nbsp;import java.awt.Cursor;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.Font;
&nbsp;import java.awt.FontMetrics;
&nbsp;import java.awt.Graphics;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.GridLayout;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Insets;
&nbsp;import java.awt.MenuItem;
&nbsp;import java.awt.Point;
&nbsp;import java.awt.PopupMenu;
&nbsp;import java.awt.Rectangle;
&nbsp;import java.awt.SystemTray;
&nbsp;import java.awt.Toolkit;
&nbsp;import java.awt.TrayIcon;
&nbsp;import java.awt.datatransfer.Clipboard;
&nbsp;import java.awt.datatransfer.DataFlavor;
&nbsp;import java.awt.datatransfer.Transferable;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.ComponentEvent;
&nbsp;import java.awt.event.ComponentListener;
&nbsp;import java.awt.event.ItemEvent;
&nbsp;import java.awt.event.ItemListener;
&nbsp;import java.awt.event.KeyAdapter;
&nbsp;import java.awt.event.KeyEvent;
&nbsp;import java.awt.event.MouseAdapter;
&nbsp;import java.awt.event.MouseEvent;
&nbsp;import java.awt.event.WindowAdapter;
&nbsp;import java.awt.event.WindowEvent;
&nbsp;import java.beans.PropertyChangeEvent;
&nbsp;import java.beans.PropertyChangeListener;
&nbsp;import java.io.File;
&nbsp;import java.io.FileInputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.Reader;
&nbsp;import java.net.URL;
&nbsp;import java.nio.charset.Charset;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.List;
&nbsp;import java.util.Locale;
&nbsp;import java.util.Map;
&nbsp;import java.util.ResourceBundle;
&nbsp;
&nbsp;import javax.swing.AbstractAction;
&nbsp;import javax.swing.Action;
&nbsp;import javax.swing.ButtonGroup;
&nbsp;import javax.swing.ImageIcon;
&nbsp;import javax.swing.JButton;
&nbsp;import javax.swing.JCheckBox;
&nbsp;import javax.swing.JCheckBoxMenuItem;
&nbsp;import javax.swing.JComponent;
&nbsp;import javax.swing.JDialog;
&nbsp;import javax.swing.JFileChooser;
&nbsp;import javax.swing.JFrame;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JMenu;
&nbsp;import javax.swing.JMenuBar;
&nbsp;import javax.swing.JOptionPane;
&nbsp;import javax.swing.JPanel;
&nbsp;import javax.swing.JRadioButtonMenuItem;
&nbsp;import javax.swing.JScrollPane;
&nbsp;import javax.swing.JSplitPane;
&nbsp;import javax.swing.JTextArea;
&nbsp;import javax.swing.JTextPane;
&nbsp;import javax.swing.JToggleButton;
&nbsp;import javax.swing.JToolBar;
&nbsp;import javax.swing.KeyStroke;
&nbsp;import javax.swing.SwingConstants;
&nbsp;import javax.swing.SwingUtilities;
&nbsp;import javax.swing.UIManager;
&nbsp;import javax.swing.UnsupportedLookAndFeelException;
&nbsp;import javax.swing.WindowConstants;
&nbsp;import javax.swing.border.Border;
&nbsp;import javax.swing.border.CompoundBorder;
&nbsp;import javax.swing.border.EmptyBorder;
&nbsp;import javax.swing.border.MatteBorder;
&nbsp;import javax.swing.event.CaretEvent;
&nbsp;import javax.swing.event.CaretListener;
&nbsp;import javax.swing.event.DocumentEvent;
&nbsp;import javax.swing.event.DocumentListener;
&nbsp;import javax.swing.filechooser.FileFilter;
&nbsp;import javax.swing.text.BadLocationException;
&nbsp;import javax.swing.text.DefaultEditorKit;
&nbsp;import javax.swing.text.Element;
&nbsp;import javax.swing.text.JTextComponent;
&nbsp;import javax.swing.text.TextAction;
&nbsp;import javax.swing.text.Utilities;
&nbsp;
&nbsp;import org.apache.commons.collections4.queue.CircularFifoQueue;
&nbsp;import org.apache.commons.io.ByteOrderMark;
&nbsp;import org.apache.commons.io.FileUtils;
&nbsp;import org.apache.commons.io.input.BOMInputStream;
&nbsp;import org.apache.commons.lang3.ArrayUtils;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.languagetool.*;
&nbsp;import org.languagetool.rules.Rule;
&nbsp;import org.languagetool.server.HTTPServer;
&nbsp;import org.languagetool.server.HTTPServerConfig;
&nbsp;import org.languagetool.server.PortBindingException;
&nbsp;import org.languagetool.tools.JnaTools;
&nbsp;import org.languagetool.tools.StringTools;
&nbsp;
&nbsp;
&nbsp;/**
&nbsp; * A simple GUI to check texts with.
&nbsp; *
&nbsp; * @author Daniel Naber
&nbsp; */
&nbsp;public final class Main {
&nbsp;
&nbsp;  static final String EXTERNAL_LANGUAGE_SUFFIX = &quot; (ext.)&quot;;
&nbsp;  
&nbsp;  private static final String HTML_FONT_START = &quot;&lt;font face=&#39;Arial,Helvetica&#39;&gt;&quot;;
&nbsp;  private static final String HTML_FONT_END = &quot;&lt;/font&gt;&quot;;
&nbsp;
&nbsp;  private static final String TRAY_ICON = &quot;/TrayIcon.png&quot;;
&nbsp;  private static final String TRAY_SERVER_ICON = &quot;/TrayIconWithServer.png&quot;;
&nbsp;  private static final String TRAY_SMALL_ICON = &quot;/TrayIconSmall.png&quot;;
&nbsp;  private static final String TRAY_SMALL_SERVER_ICON = &quot;/TrayIconSmallWithServer.png&quot;;
&nbsp;  private static final String TRAY_TOOLTIP = &quot;LanguageTool&quot;;
&nbsp;  private static final String TAG_COLOR = &quot;#888888&quot;;
&nbsp;  private static final String GUI_STATE = &quot;gui.state&quot;;
&nbsp;
&nbsp;  private static final int WINDOW_WIDTH = 600;
&nbsp;  private static final int WINDOW_HEIGHT = 550;
&nbsp;  private static final int MAX_RECENT_FILES = 8;
&nbsp;
&nbsp;  private final ResourceBundle messages;
<b class="nc">&nbsp;  private final List&lt;Language&gt; externalLanguages = new ArrayList&lt;&gt;();</b>
&nbsp;
&nbsp;  private JFrame frame;
&nbsp;  private JDialog taggerDialog;
&nbsp;  private JTextPane taggerArea;
&nbsp;  private JTextArea textArea;
&nbsp;  private TextLineNumber textLineNumber;
&nbsp;  private JScrollPane numberedTextAreaPane;
&nbsp;  private JTextPane resultArea;
&nbsp;  private LanguageComboBox languageBox;
&nbsp;  private CheckboxMenuItem enableHttpServerItem;
&nbsp;  private HTTPServer httpServer;
&nbsp;
&nbsp;  private TrayIcon trayIcon;
&nbsp;  private boolean closeHidesToTray;
&nbsp;  private boolean isInTray;
<b class="nc">&nbsp;  private boolean taggerShowsDisambigLog = false;</b>
&nbsp;
&nbsp;  private LanguageToolSupport ltSupport;
&nbsp;  private OpenAction openAction;
&nbsp;  private SaveAction saveAction;
&nbsp;  private SaveAsAction saveAsAction;
&nbsp;  private AutoCheckAction autoCheckAction;
&nbsp;  private ShowResultAction showResultAction;
&nbsp;
&nbsp;  private CheckAction checkAction;
&nbsp;  private File currentFile;
&nbsp;  private ByteOrderMark bom;
&nbsp;  private UndoRedoSupport undoRedo;
<b class="nc">&nbsp;  private final JLabel statusLabel = new JLabel(&quot; &quot;, null, SwingConstants.RIGHT);</b>
&nbsp;  private FontChooser fontChooserDialog;
<b class="nc">&nbsp;  private final CircularFifoQueue&lt;String&gt; recentFiles = new CircularFifoQueue&lt;&gt;(MAX_RECENT_FILES);</b>
&nbsp;  private JMenu recentFilesMenu;
&nbsp;  private final LocalStorage localStorage;
<b class="nc">&nbsp;  private final Map&lt;Language, ConfigurationDialog&gt; configDialogs = new HashMap&lt;&gt;();</b>
&nbsp;  private JSplitPane splitPane;
<b class="nc">&nbsp;  private final JPanel mainPanel = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;  private Main(LocalStorage localStorage) {</b>
<b class="nc">&nbsp;    this.localStorage = localStorage;</b>
<b class="nc">&nbsp;    messages = JLanguageTool.getMessageBundle();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void loadFile() {
<b class="nc">&nbsp;    File file = Tools.openFileDialog(frame, new PlainTextFileFilter());</b>
<b class="nc">&nbsp;    if (file == null) {  // user clicked cancel</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    loadFile(file);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void loadFile(File file) {
<b class="nc">&nbsp;    try (FileInputStream inputStream = new FileInputStream(file)) {</b>
<b class="nc">&nbsp;      BOMInputStream bomIn = new BOMInputStream(inputStream, false,</b>
&nbsp;              ByteOrderMark.UTF_8, ByteOrderMark.UTF_16BE, ByteOrderMark.UTF_16LE,
&nbsp;              ByteOrderMark.UTF_32BE, ByteOrderMark.UTF_32LE);
&nbsp;      String charsetName;
<b class="nc">&nbsp;      if (bomIn.hasBOM()) {</b>
<b class="nc">&nbsp;        bom = bomIn.getBOM();</b>
<b class="nc">&nbsp;        charsetName = bom.getCharsetName();</b>
&nbsp;      } else {
&nbsp;        // No BOM found
<b class="nc">&nbsp;        bom = null;</b>
<b class="nc">&nbsp;        charsetName = null;</b>
&nbsp;      }
<b class="nc">&nbsp;      String fileContents = StringTools.readStream(bomIn, charsetName);</b>
<b class="nc">&nbsp;      textArea.setText(fileContents);</b>
<b class="nc">&nbsp;      currentFile = file;</b>
<b class="nc">&nbsp;      updateTitle();</b>
<b class="nc">&nbsp;      recentFiles.remove(file.getAbsolutePath());</b>
<b class="nc">&nbsp;      recentFiles.add(file.getAbsolutePath());</b>
<b class="nc">&nbsp;      localStorage.saveProperty(&quot;recentFiles&quot;, recentFiles);</b>
<b class="nc">&nbsp;      updateRecentFilesMenu();</b>
&nbsp;    } catch (IOException e) {
<b class="nc">&nbsp;      Tools.showError(e);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void saveFile(boolean newFile) {
<b class="nc">&nbsp;    if (currentFile == null || newFile) {</b>
<b class="nc">&nbsp;      JFileChooser jfc = new JFileChooser();</b>
<b class="nc">&nbsp;      jfc.setFileFilter(new PlainTextFileFilter());</b>
<b class="nc">&nbsp;      jfc.showSaveDialog(frame);</b>
&nbsp;
<b class="nc">&nbsp;      File file = jfc.getSelectedFile();</b>
<b class="nc">&nbsp;      if (file == null) {  // user clicked cancel</b>
&nbsp;        return;
&nbsp;      }
<b class="nc">&nbsp;      currentFile = file;</b>
<b class="nc">&nbsp;      bom = null;</b>
<b class="nc">&nbsp;      updateTitle();</b>
&nbsp;    }
&nbsp;    try {
<b class="nc">&nbsp;      if(bom != null) {</b>
<b class="nc">&nbsp;        FileUtils.writeByteArrayToFile(currentFile, bom.getBytes());</b>
<b class="nc">&nbsp;        FileUtils.write(currentFile, textArea.getText(), bom.getCharsetName(), true);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        FileUtils.write(currentFile, textArea.getText(), Charset.defaultCharset());</b>
&nbsp;      }
&nbsp;    } catch (IOException ex) {
<b class="nc">&nbsp;      Tools.showError(ex);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void addLanguage() throws InstantiationException, IllegalAccessException {
<b class="nc">&nbsp;    LanguageManagerDialog dialog = new LanguageManagerDialog(frame, externalLanguages);</b>
<b class="nc">&nbsp;    dialog.show();</b>
<b class="nc">&nbsp;    List&lt;Language&gt; newExtLanguages = dialog.getLanguages();</b>
<b class="nc">&nbsp;    externalLanguages.clear();</b>
<b class="nc">&nbsp;    externalLanguages.addAll(newExtLanguages);</b>
<b class="nc">&nbsp;    languageBox.setModel(LanguageComboBoxModel.create(messages,</b>
&nbsp;            EXTERNAL_LANGUAGE_SUFFIX, false, externalLanguages, null));
<b class="nc">&nbsp;    languageBox.selectLanguage(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;    ltSupport.setLanguage(languageBox.getSelectedLanguage());</b>
<b class="nc">&nbsp;    checkTextAndDisplayResults();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void showOptions() {
<b class="nc">&nbsp;    JLanguageTool lt = ltSupport.getLanguageTool();</b>
<b class="nc">&nbsp;    List&lt;Rule&gt; rules = lt.getAllRules();</b>
<b class="nc">&nbsp;    ConfigurationDialog configDialog = getCurrentConfigDialog();</b>
<b class="nc">&nbsp;    boolean configChanged = configDialog.show(rules); // this blocks until OK/Cancel is clicked in the dialog</b>
<b class="nc">&nbsp;    if(configChanged) {</b>
<b class="nc">&nbsp;      Configuration config = ltSupport.getConfig();</b>
&nbsp;      try { //save config - needed for the server
<b class="nc">&nbsp;        config.saveConfiguration(lt.getLanguage());</b>
&nbsp;      } catch (IOException e) {
<b class="nc">&nbsp;        Tools.showError(e);</b>
&nbsp;      }
<b class="nc">&nbsp;      ltSupport.reloadConfig();</b>
&nbsp;      // Stop server, start new server if requested:
<b class="nc">&nbsp;      stopServer();</b>
<b class="nc">&nbsp;      maybeStartServer();</b>
<b class="nc">&nbsp;      checkTextAndDisplayResults();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void showSelectFontDialog() {
<b class="nc">&nbsp;    Configuration config = ltSupport.getConfig();</b>
<b class="nc">&nbsp;    if (fontChooserDialog == null) {</b>
<b class="nc">&nbsp;      fontChooserDialog = new FontChooser(frame, true);</b>
<b class="nc">&nbsp;      Tools.centerDialog(fontChooserDialog);</b>
<b class="nc">&nbsp;      fontChooserDialog.addPropertyChangeListener(textLineNumber);</b>
&nbsp;    }
<b class="nc">&nbsp;    fontChooserDialog.setSelectedFont(this.textArea.getFont());</b>
<b class="nc">&nbsp;    fontChooserDialog.setVisible(true);</b>
<b class="nc">&nbsp;    if (fontChooserDialog.getSelectedFont() != null) {</b>
<b class="nc">&nbsp;      this.textArea.setFont(fontChooserDialog.getSelectedFont());</b>
<b class="nc">&nbsp;      config.setFontName(fontChooserDialog.getSelectedFont().getFamily());</b>
<b class="nc">&nbsp;      config.setFontStyle(fontChooserDialog.getSelectedFont().getStyle());</b>
<b class="nc">&nbsp;      config.setFontSize(fontChooserDialog.getSelectedFont().getSize());</b>
&nbsp;      try {
<b class="nc">&nbsp;        config.saveConfiguration(ltSupport.getLanguage());</b>
&nbsp;      } catch (IOException e) {
<b class="nc">&nbsp;        Tools.showError(e);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private Component getFrame() {
<b class="nc">&nbsp;    return frame;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void updateTitle() {
<b class="nc">&nbsp;    StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;    if(currentFile != null) {</b>
<b class="nc">&nbsp;      sb.append(currentFile.getName());</b>
<b class="nc">&nbsp;      if(bom != null) {</b>
<b class="nc">&nbsp;        sb.append(&quot; (&quot;).append(bom.getCharsetName()).append(&#39;)&#39;);</b>
&nbsp;      }
<b class="nc">&nbsp;      sb.append(&quot; - &quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    sb.append(&quot;LanguageTool &quot;).append(JLanguageTool.VERSION);</b>
<b class="nc">&nbsp;    frame.setTitle(sb.toString());</b>
&nbsp;  }
&nbsp;
&nbsp;  private void createGUI() {
<b class="nc">&nbsp;    loadRecentFiles();</b>
<b class="nc">&nbsp;    frame = new JFrame(&quot;LanguageTool &quot; + JLanguageTool.VERSION);</b>
&nbsp;
<b class="nc">&nbsp;    setLookAndFeel();</b>
<b class="nc">&nbsp;    openAction = new OpenAction();</b>
<b class="nc">&nbsp;    saveAction = new SaveAction();</b>
<b class="nc">&nbsp;    saveAsAction = new SaveAsAction();</b>
<b class="nc">&nbsp;    checkAction = new CheckAction();</b>
<b class="nc">&nbsp;    autoCheckAction = new AutoCheckAction(true);</b>
<b class="nc">&nbsp;    showResultAction = new ShowResultAction(true);</b>
&nbsp;
<b class="nc">&nbsp;    frame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</b>
<b class="nc">&nbsp;    frame.addWindowListener(new CloseListener());</b>
<b class="nc">&nbsp;    URL iconUrl = JLanguageTool.getDataBroker().getFromResourceDirAsUrl(TRAY_ICON);</b>
<b class="nc">&nbsp;    frame.setIconImage(new ImageIcon(iconUrl).getImage());</b>
&nbsp;
<b class="nc">&nbsp;    textArea = new JTextArea();</b>
<b class="nc">&nbsp;    textArea.setLineWrap(true);</b>
<b class="nc">&nbsp;    textArea.setWrapStyleWord(true);</b>
<b class="nc">&nbsp;    textArea.addKeyListener(new ControlReturnTextCheckingListener());</b>
&nbsp;
<b class="nc">&nbsp;    textLineNumber = new TextLineNumber(textArea, 2);</b>
<b class="nc">&nbsp;    numberedTextAreaPane = new JScrollPane(textArea);</b>
<b class="nc">&nbsp;    numberedTextAreaPane.setRowHeaderView(textLineNumber);</b>
&nbsp;
<b class="nc">&nbsp;    resultArea = new JTextPane();</b>
<b class="nc">&nbsp;    undoRedo = new UndoRedoSupport(this.textArea, messages);</b>
<b class="nc">&nbsp;    frame.setJMenuBar(createMenuBar());</b>
&nbsp;
<b class="nc">&nbsp;    GridBagConstraints buttonCons = new GridBagConstraints();</b>
&nbsp;
<b class="nc">&nbsp;    JPanel insidePanel = new JPanel();</b>
<b class="nc">&nbsp;    insidePanel.setOpaque(false);</b>
<b class="nc">&nbsp;    insidePanel.setLayout(new GridBagLayout());</b>
&nbsp;
<b class="nc">&nbsp;    buttonCons.gridx = 0;</b>
<b class="nc">&nbsp;    buttonCons.gridy = 0;</b>
<b class="nc">&nbsp;    buttonCons.anchor = GridBagConstraints.LINE_START;</b>
<b class="nc">&nbsp;    insidePanel.add(new JLabel(messages.getString(&quot;textLanguage&quot;) + &quot; &quot;), buttonCons);</b>
&nbsp;
&nbsp;    //create a ComboBox with flags, do not include hidden languages
<b class="nc">&nbsp;    languageBox = LanguageComboBox.create(messages, EXTERNAL_LANGUAGE_SUFFIX,</b>
&nbsp;            true, false);
<b class="nc">&nbsp;    buttonCons.gridx = 1;</b>
<b class="nc">&nbsp;    buttonCons.gridy = 0;</b>
<b class="nc">&nbsp;    buttonCons.anchor = GridBagConstraints.LINE_START;</b>
<b class="nc">&nbsp;    insidePanel.add(languageBox, buttonCons);</b>
&nbsp;
<b class="nc">&nbsp;    JCheckBox autoDetectBox = new JCheckBox(messages.getString(&quot;atd&quot;));</b>
<b class="nc">&nbsp;    buttonCons.gridx = 2;</b>
<b class="nc">&nbsp;    buttonCons.gridy = 0;</b>
<b class="nc">&nbsp;    buttonCons.gridwidth = GridBagConstraints.REMAINDER;</b>
<b class="nc">&nbsp;    buttonCons.anchor = GridBagConstraints.LINE_START;</b>
<b class="nc">&nbsp;    insidePanel.add(autoDetectBox, buttonCons);</b>
&nbsp;
<b class="nc">&nbsp;    buttonCons.gridx = 0;</b>
<b class="nc">&nbsp;    buttonCons.gridy = 1;</b>
<b class="nc">&nbsp;    buttonCons.gridwidth = GridBagConstraints.REMAINDER;</b>
<b class="nc">&nbsp;    buttonCons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;    buttonCons.anchor = GridBagConstraints.LINE_END;</b>
<b class="nc">&nbsp;    buttonCons.weightx = 1.0;</b>
<b class="nc">&nbsp;    insidePanel.add(statusLabel, buttonCons);</b>
&nbsp;
<b class="nc">&nbsp;    Container contentPane = frame.getContentPane();</b>
<b class="nc">&nbsp;    GridBagLayout gridLayout = new GridBagLayout();</b>
<b class="nc">&nbsp;    contentPane.setLayout(gridLayout);</b>
<b class="nc">&nbsp;    GridBagConstraints cons = new GridBagConstraints();</b>
&nbsp;
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 1;</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;    cons.anchor = GridBagConstraints.FIRST_LINE_START;</b>
<b class="nc">&nbsp;    JToolBar toolbar = new JToolBar(&quot;Toolbar&quot;, JToolBar.HORIZONTAL);</b>
<b class="nc">&nbsp;    toolbar.setFloatable(false);</b>
<b class="nc">&nbsp;    contentPane.add(toolbar,cons);</b>
&nbsp;
<b class="nc">&nbsp;    JButton openButton = new JButton(openAction);</b>
<b class="nc">&nbsp;    openButton.setHideActionText(true);</b>
<b class="nc">&nbsp;    openButton.setFocusable(false);</b>
<b class="nc">&nbsp;    toolbar.add(openButton);</b>
&nbsp;
<b class="nc">&nbsp;    JButton saveButton = new JButton(saveAction);</b>
<b class="nc">&nbsp;    saveButton.setHideActionText(true);</b>
<b class="nc">&nbsp;    saveButton.setFocusable(false);</b>
<b class="nc">&nbsp;    toolbar.add(saveButton);</b>
&nbsp;
<b class="nc">&nbsp;    JButton saveAsButton = new JButton(saveAsAction);</b>
<b class="nc">&nbsp;    saveAsButton.setHideActionText(true);</b>
<b class="nc">&nbsp;    saveAsButton.setFocusable(false);</b>
<b class="nc">&nbsp;    toolbar.add(saveAsButton);</b>
&nbsp;
<b class="nc">&nbsp;    JButton spellButton = new JButton(this.checkAction);</b>
<b class="nc">&nbsp;    spellButton.setHideActionText(true);</b>
<b class="nc">&nbsp;    spellButton.setFocusable(false);</b>
<b class="nc">&nbsp;    toolbar.add(spellButton);</b>
&nbsp;
<b class="nc">&nbsp;    JToggleButton autoSpellButton = new JToggleButton(autoCheckAction);</b>
<b class="nc">&nbsp;    autoSpellButton.setHideActionText(true);</b>
<b class="nc">&nbsp;    autoSpellButton.setFocusable(false);</b>
<b class="nc">&nbsp;    toolbar.add(autoSpellButton);</b>
&nbsp;
<b class="nc">&nbsp;    JButton clearTextButton = new JButton(new ClearTextAction());</b>
<b class="nc">&nbsp;    clearTextButton.setHideActionText(true);</b>
<b class="nc">&nbsp;    clearTextButton.setFocusable(false);</b>
<b class="nc">&nbsp;    toolbar.add(clearTextButton);</b>
&nbsp;
<b class="nc">&nbsp;    cons.insets = new Insets(5, 5, 5, 5);</b>
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;    cons.weightx = 10.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 10.0f;</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 2;</b>
<b class="nc">&nbsp;    cons.weighty = 5.0f;</b>
<b class="nc">&nbsp;    splitPane = new JSplitPane(JSplitPane.VERTICAL_SPLIT,</b>
&nbsp;            numberedTextAreaPane, new JScrollPane(resultArea));
<b class="nc">&nbsp;    mainPanel.setLayout(new GridLayout(0,1));</b>
<b class="nc">&nbsp;    contentPane.add(mainPanel, cons);</b>
<b class="nc">&nbsp;    mainPanel.add(splitPane);</b>
&nbsp;
<b class="nc">&nbsp;    cons.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;    cons.gridx = 0;</b>
<b class="nc">&nbsp;    cons.gridy = 3;</b>
<b class="nc">&nbsp;    cons.weightx = 1.0f;</b>
<b class="nc">&nbsp;    cons.weighty = 0.0f;</b>
<b class="nc">&nbsp;    cons.insets = new Insets(4, 12, 4, 12);</b>
<b class="nc">&nbsp;    contentPane.add(insidePanel, cons);</b>
&nbsp;
<b class="nc">&nbsp;    ltSupport = new LanguageToolSupport(this.frame, this.textArea, this.undoRedo);</b>
<b class="nc">&nbsp;    ResultAreaHelper.install(messages, ltSupport, resultArea);</b>
<b class="nc">&nbsp;    languageBox.selectLanguage(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;    languageBox.setEnabled(!ltSupport.getConfig().getAutoDetect());</b>
<b class="nc">&nbsp;    autoDetectBox.setSelected(ltSupport.getConfig().getAutoDetect());</b>
<b class="nc">&nbsp;    taggerShowsDisambigLog = ltSupport.getConfig().getTaggerShowsDisambigLog();</b>
&nbsp;
<b class="nc">&nbsp;    languageBox.addItemListener(new ItemListener() {</b>
&nbsp;      @Override
&nbsp;      public void itemStateChanged(ItemEvent e) {
<b class="nc">&nbsp;        if (e.getStateChange() == ItemEvent.SELECTED) {</b>
&nbsp;          // we cannot re-use the existing LT object anymore
<b class="nc">&nbsp;          frame.applyComponentOrientation(</b>
<b class="nc">&nbsp;                  ComponentOrientation.getOrientation(Locale.getDefault()));</b>
<b class="nc">&nbsp;          Language lang = languageBox.getSelectedLanguage();</b>
<b class="nc">&nbsp;          ComponentOrientation componentOrientation =</b>
<b class="nc">&nbsp;            ComponentOrientation.getOrientation(lang.getLocale());</b>
<b class="nc">&nbsp;          textArea.applyComponentOrientation(componentOrientation);</b>
<b class="nc">&nbsp;          resultArea.applyComponentOrientation(componentOrientation);</b>
<b class="nc">&nbsp;          ltSupport.setLanguage(lang);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    autoDetectBox.addItemListener(new ItemListener() {</b>
&nbsp;      @Override
&nbsp;      public void itemStateChanged(ItemEvent e) {
<b class="nc">&nbsp;        boolean selected = e.getStateChange() == ItemEvent.SELECTED;</b>
<b class="nc">&nbsp;        languageBox.setEnabled(!selected);</b>
<b class="nc">&nbsp;        ltSupport.getConfig().setAutoDetect(selected);</b>
<b class="nc">&nbsp;        if (selected) {</b>
<b class="nc">&nbsp;          Language detected = ltSupport.autoDetectLanguage(textArea.getText());</b>
<b class="nc">&nbsp;          languageBox.selectLanguage(detected);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    ltSupport.addLanguageToolListener(new LanguageToolListener() {</b>
&nbsp;      @Override
&nbsp;      public void languageToolEventOccurred(LanguageToolEvent event) {
<b class="nc">&nbsp;        if (event.getType() == LanguageToolEvent.Type.CHECKING_STARTED) {</b>
<b class="nc">&nbsp;          String msg = org.languagetool.tools.Tools.i18n(messages, &quot;checkStart&quot;);</b>
<b class="nc">&nbsp;          statusLabel.setText(msg);</b>
<b class="nc">&nbsp;          if (event.getCaller() == getFrame()) {</b>
<b class="nc">&nbsp;            setWaitCursor();</b>
<b class="nc">&nbsp;            checkAction.setEnabled(false);</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (event.getType() == LanguageToolEvent.Type.CHECKING_FINISHED) {</b>
<b class="nc">&nbsp;          if (event.getCaller() == getFrame()) {</b>
<b class="nc">&nbsp;            checkAction.setEnabled(true);</b>
<b class="nc">&nbsp;            unsetWaitCursor();</b>
&nbsp;          }
<b class="nc">&nbsp;          String msg = org.languagetool.tools.Tools.i18n(messages, &quot;checkDone&quot;, event.getSource().getMatches().size(), event.getElapsedTime());</b>
<b class="nc">&nbsp;          statusLabel.setText(msg);</b>
<b class="nc">&nbsp;        } else if (event.getType() == LanguageToolEvent.Type.LANGUAGE_CHANGED) {</b>
<b class="nc">&nbsp;          languageBox.selectLanguage(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;        } else if (event.getType() == LanguageToolEvent.Type.RULE_ENABLED) {</b>
&nbsp;          //this will trigger a check and the result will be updated by
&nbsp;          //the CHECKING_FINISHED event
<b class="nc">&nbsp;        } else if (event.getType() == LanguageToolEvent.Type.RULE_DISABLED) {</b>
<b class="nc">&nbsp;          String msg = org.languagetool.tools.Tools.i18n(messages, &quot;checkDoneNoTime&quot;, event.getSource().getMatches().size());</b>
<b class="nc">&nbsp;          statusLabel.setText(msg);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    frame.applyComponentOrientation(ComponentOrientation.getOrientation(Locale.getDefault()));</b>
<b class="nc">&nbsp;    Language lang = ltSupport.getLanguage();</b>
<b class="nc">&nbsp;    ComponentOrientation componentOrientation =</b>
<b class="nc">&nbsp;      ComponentOrientation.getOrientation(lang.getLocale());</b>
<b class="nc">&nbsp;    textArea.applyComponentOrientation(componentOrientation);</b>
<b class="nc">&nbsp;    resultArea.applyComponentOrientation(componentOrientation);</b>
&nbsp;
<b class="nc">&nbsp;    ResourceBundle textLanguageMessageBundle = JLanguageTool.getMessageBundle(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;    textArea.setText(textLanguageMessageBundle.getString(&quot;guiDemoText&quot;));</b>
&nbsp;
<b class="nc">&nbsp;    Configuration config = ltSupport.getConfig();</b>
<b class="nc">&nbsp;    if (config.getFontName() != null</b>
<b class="nc">&nbsp;            || config.getFontStyle() != Configuration.FONT_STYLE_INVALID</b>
<b class="nc">&nbsp;            || config.getFontSize() != Configuration.FONT_SIZE_INVALID) {</b>
<b class="nc">&nbsp;      String fontName = config.getFontName();</b>
<b class="nc">&nbsp;      if (fontName == null) {</b>
<b class="nc">&nbsp;        fontName = textArea.getFont().getFamily();</b>
&nbsp;      }
<b class="nc">&nbsp;      int fontSize = config.getFontSize();</b>
<b class="nc">&nbsp;      if (fontSize == Configuration.FONT_SIZE_INVALID) {</b>
<b class="nc">&nbsp;        fontSize = textArea.getFont().getSize();</b>
&nbsp;      }
<b class="nc">&nbsp;      Font font = new Font(fontName, config.getFontStyle(), fontSize);</b>
<b class="nc">&nbsp;      textArea.setFont(font);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    frame.pack();</b>
<b class="nc">&nbsp;    frame.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);</b>
<b class="nc">&nbsp;    frame.setLocationByPlatform(true);</b>
<b class="nc">&nbsp;    splitPane.setDividerLocation(200);</b>
<b class="nc">&nbsp;    MainWindowStateBean state =</b>
<b class="nc">&nbsp;            localStorage.loadProperty(&quot;gui.state&quot;, MainWindowStateBean.class);</b>
<b class="nc">&nbsp;    if(state != null) {</b>
<b class="nc">&nbsp;      if(state.getBounds() != null) {</b>
<b class="nc">&nbsp;        frame.setBounds(state.getBounds());</b>
<b class="nc">&nbsp;        ResizeComponentListener.setBoundsProperty(frame, state.getBounds());</b>
&nbsp;      }
<b class="nc">&nbsp;      if(state.getDividerLocation() != null) {</b>
<b class="nc">&nbsp;        splitPane.setDividerLocation(state.getDividerLocation());</b>
&nbsp;      }
<b class="nc">&nbsp;      if(state.getState() != null) {</b>
<b class="nc">&nbsp;        frame.setExtendedState(state.getState());</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    ResizeComponentListener.attachToWindow(frame);</b>
<b class="nc">&nbsp;    maybeStartServer();</b>
&nbsp;  }
&nbsp;
&nbsp;  private String getLabel(String key) {
<b class="nc">&nbsp;    return Tools.getLabel(messages.getString(key));</b>
&nbsp;  }
&nbsp;
&nbsp;  private int getMnemonic(String key) {
<b class="nc">&nbsp;    return Tools.getMnemonic(messages.getString(key));</b>
&nbsp;  }
&nbsp;
&nbsp;  private KeyStroke getMenuKeyStroke(int keyEvent) {
<b class="nc">&nbsp;    return KeyStroke.getKeyStroke(keyEvent, Toolkit.getDefaultToolkit().getMenuShortcutKeyMask());</b>
&nbsp;  }
&nbsp;
&nbsp;  private JMenuBar createMenuBar() {
<b class="nc">&nbsp;    JMenuBar menuBar = new JMenuBar();</b>
<b class="nc">&nbsp;    JMenu fileMenu = new JMenu(getLabel(&quot;guiMenuFile&quot;));</b>
<b class="nc">&nbsp;    fileMenu.setMnemonic(getMnemonic(&quot;guiMenuFile&quot;));</b>
<b class="nc">&nbsp;    JMenu editMenu = new JMenu(getLabel(&quot;guiMenuEdit&quot;));</b>
<b class="nc">&nbsp;    editMenu.setMnemonic(getMnemonic(&quot;guiMenuEdit&quot;));</b>
<b class="nc">&nbsp;    JMenu grammarMenu = new JMenu(getLabel(&quot;guiMenuGrammar&quot;));</b>
<b class="nc">&nbsp;    grammarMenu.setMnemonic(getMnemonic(&quot;guiMenuGrammar&quot;));</b>
<b class="nc">&nbsp;    JMenu helpMenu = new JMenu(getLabel(&quot;guiMenuHelp&quot;));</b>
<b class="nc">&nbsp;    helpMenu.setMnemonic(getMnemonic(&quot;guiMenuHelp&quot;));</b>
&nbsp;
<b class="nc">&nbsp;    fileMenu.add(openAction);</b>
<b class="nc">&nbsp;    fileMenu.add(saveAction);</b>
<b class="nc">&nbsp;    fileMenu.add(saveAsAction);</b>
<b class="nc">&nbsp;    recentFilesMenu = new JMenu(getLabel(&quot;guiMenuRecentFiles&quot;));</b>
<b class="nc">&nbsp;    recentFilesMenu.setMnemonic(getMnemonic(&quot;guiMenuRecentFiles&quot;));</b>
<b class="nc">&nbsp;    fileMenu.add(recentFilesMenu);</b>
<b class="nc">&nbsp;    updateRecentFilesMenu();</b>
<b class="nc">&nbsp;    fileMenu.addSeparator();</b>
<b class="nc">&nbsp;    fileMenu.add(new HideAction());</b>
<b class="nc">&nbsp;    fileMenu.addSeparator();</b>
<b class="nc">&nbsp;    fileMenu.add(new QuitAction());</b>
&nbsp;
<b class="nc">&nbsp;    grammarMenu.add(checkAction);</b>
<b class="nc">&nbsp;    JCheckBoxMenuItem item = new JCheckBoxMenuItem(autoCheckAction);</b>
<b class="nc">&nbsp;    grammarMenu.add(item);</b>
<b class="nc">&nbsp;    JCheckBoxMenuItem showResult = new JCheckBoxMenuItem(showResultAction);</b>
<b class="nc">&nbsp;    grammarMenu.add(showResult);</b>
<b class="nc">&nbsp;    grammarMenu.add(new CheckClipboardAction());</b>
<b class="nc">&nbsp;    grammarMenu.add(new TagTextAction());</b>
<b class="nc">&nbsp;    grammarMenu.add(new AddRulesAction());</b>
<b class="nc">&nbsp;    grammarMenu.add(new OptionsAction());</b>
<b class="nc">&nbsp;    grammarMenu.add(new SelectFontAction());</b>
<b class="nc">&nbsp;    JMenu lafMenu = new JMenu(messages.getString(&quot;guiLookAndFeelMenu&quot;));</b>
<b class="nc">&nbsp;    UIManager.LookAndFeelInfo[] lafInfo = UIManager.getInstalledLookAndFeels();</b>
<b class="nc">&nbsp;    ButtonGroup buttonGroup = new ButtonGroup();</b>
<b class="nc">&nbsp;    for (UIManager.LookAndFeelInfo laf : lafInfo) {</b>
<b class="nc">&nbsp;      if (!&quot;Nimbus&quot;.equals(laf.getName())) {</b>
&nbsp;        continue;
&nbsp;      }
<b class="nc">&nbsp;      addLookAndFeelMenuItem(lafMenu, laf, buttonGroup);</b>
&nbsp;    }
<b class="nc">&nbsp;    for (UIManager.LookAndFeelInfo laf : lafInfo) {</b>
<b class="nc">&nbsp;      if (&quot;Nimbus&quot;.equals(laf.getName())) {</b>
&nbsp;        continue;
&nbsp;      }
<b class="nc">&nbsp;      addLookAndFeelMenuItem(lafMenu, laf, buttonGroup);</b>
&nbsp;    }
<b class="nc">&nbsp;    grammarMenu.add(lafMenu);</b>
&nbsp;
<b class="nc">&nbsp;    helpMenu.add(new AboutAction());</b>
&nbsp;
<b class="nc">&nbsp;    undoRedo.undoAction.putValue(Action.NAME, getLabel(&quot;guiMenuUndo&quot;));</b>
<b class="nc">&nbsp;    undoRedo.undoAction.putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuUndo&quot;));</b>
<b class="nc">&nbsp;    undoRedo.redoAction.putValue(Action.NAME, getLabel(&quot;guiMenuRedo&quot;));</b>
<b class="nc">&nbsp;    undoRedo.redoAction.putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuRedo&quot;));</b>
&nbsp;
<b class="nc">&nbsp;    editMenu.add(undoRedo.undoAction);</b>
<b class="nc">&nbsp;    editMenu.add(undoRedo.redoAction);</b>
<b class="nc">&nbsp;    editMenu.addSeparator();</b>
&nbsp;
<b class="nc">&nbsp;    Action cutAction = new DefaultEditorKit.CutAction();</b>
<b class="nc">&nbsp;    cutAction.putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_cut.png&quot;));</b>
<b class="nc">&nbsp;    cutAction.putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_cut.png&quot;));</b>
<b class="nc">&nbsp;    cutAction.putValue(Action.NAME, getLabel(&quot;guiMenuCut&quot;));</b>
<b class="nc">&nbsp;    cutAction.putValue(Action.MNEMONIC_KEY, KeyEvent.VK_T);</b>
<b class="nc">&nbsp;    editMenu.add(cutAction);</b>
&nbsp;
<b class="nc">&nbsp;    Action copyAction = new DefaultEditorKit.CopyAction();</b>
<b class="nc">&nbsp;    copyAction.putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_copy.png&quot;));</b>
<b class="nc">&nbsp;    copyAction.putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_copy.png&quot;));</b>
<b class="nc">&nbsp;    copyAction.putValue(Action.NAME, getLabel(&quot;guiMenuCopy&quot;));</b>
<b class="nc">&nbsp;    copyAction.putValue(Action.MNEMONIC_KEY, KeyEvent.VK_C);</b>
<b class="nc">&nbsp;    editMenu.add(copyAction);</b>
&nbsp;
<b class="nc">&nbsp;    Action pasteAction = new DefaultEditorKit.PasteAction();</b>
<b class="nc">&nbsp;    pasteAction.putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_paste.png&quot;));</b>
<b class="nc">&nbsp;    pasteAction.putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_paste.png&quot;));</b>
<b class="nc">&nbsp;    pasteAction.putValue(Action.NAME, getLabel(&quot;guiMenuPaste&quot;));</b>
<b class="nc">&nbsp;    pasteAction.putValue(Action.MNEMONIC_KEY, KeyEvent.VK_P);</b>
<b class="nc">&nbsp;    editMenu.add(pasteAction);</b>
&nbsp;
<b class="nc">&nbsp;    editMenu.addSeparator();</b>
&nbsp;
<b class="nc">&nbsp;    editMenu.add(new SelectAllAction());</b>
&nbsp;
<b class="nc">&nbsp;    menuBar.add(fileMenu);</b>
<b class="nc">&nbsp;    menuBar.add(editMenu);</b>
<b class="nc">&nbsp;    menuBar.add(grammarMenu);</b>
<b class="nc">&nbsp;    menuBar.add(helpMenu);</b>
<b class="nc">&nbsp;    return menuBar;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void updateRecentFilesMenu() {
<b class="nc">&nbsp;    recentFilesMenu.removeAll();</b>
<b class="nc">&nbsp;    String[] files = recentFiles.toArray(new String[0]);</b>
<b class="nc">&nbsp;    ArrayUtils.reverse(files);</b>
<b class="nc">&nbsp;    for(String filename : files) {</b>
<b class="nc">&nbsp;      recentFilesMenu.add(new RecentFileAction(new File(filename)));</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void loadRecentFiles() {
<b class="nc">&nbsp;    CircularFifoQueue&lt;String&gt; l = localStorage.loadProperty(&quot;recentFiles&quot;, CircularFifoQueue.class);</b>
<b class="nc">&nbsp;    if(l != null) {</b>
<b class="nc">&nbsp;      for(String name : l) {</b>
<b class="nc">&nbsp;        File f = new File(name);</b>
<b class="nc">&nbsp;        if(f.exists() &amp;&amp; f.isFile()) {</b>
<b class="nc">&nbsp;          recentFiles.add(name);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void addLookAndFeelMenuItem(JMenu lafMenu,
&nbsp;        UIManager.LookAndFeelInfo laf, ButtonGroup buttonGroup)
&nbsp;  {
<b class="nc">&nbsp;    JRadioButtonMenuItem lfItem = new JRadioButtonMenuItem(new SelectLFAction(laf));</b>
<b class="nc">&nbsp;    lafMenu.add(lfItem);</b>
<b class="nc">&nbsp;    buttonGroup.add(lfItem);</b>
<b class="nc">&nbsp;    if (laf.getClassName().equals(UIManager.getLookAndFeel().getClass().getName())) {</b>
<b class="nc">&nbsp;      buttonGroup.setSelected(lfItem.getModel(), true);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void setLookAndFeel() {
<b class="nc">&nbsp;    String lookAndFeelName = null;</b>
<b class="nc">&nbsp;    String className = null;</b>
&nbsp;    try {
<b class="nc">&nbsp;      Configuration config = new Configuration(new File(System.getProperty(&quot;user.home&quot;)), LanguageToolSupport.CONFIG_FILE, null);</b>
<b class="nc">&nbsp;      if (config.getLookAndFeelName() != null) {</b>
<b class="nc">&nbsp;        lookAndFeelName = config.getLookAndFeelName();</b>
&nbsp;      }
&nbsp;    } catch (IOException ex) {
&nbsp;      // ignore
&nbsp;    }
<b class="nc">&nbsp;    if (lookAndFeelName == null) {</b>
<b class="nc">&nbsp;      lookAndFeelName = &quot;Nimbus&quot;;</b>
&nbsp;      // to use the system&#39;s look and feel:
&nbsp;      //lookAndFeelName = UIManager.getSystemLookAndFeelClassName();
&nbsp;    }
<b class="nc">&nbsp;    for (UIManager.LookAndFeelInfo info : UIManager.getInstalledLookAndFeels()) {</b>
<b class="nc">&nbsp;      if (lookAndFeelName.equals(info.getName())) {</b>
<b class="nc">&nbsp;        className = info.getClassName();</b>
&nbsp;        break;
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    if (className != null) {</b>
&nbsp;      try {
<b class="nc">&nbsp;        UIManager.setLookAndFeel(className);</b>
&nbsp;      } catch (Exception ignored) {
&nbsp;        // Well, what can we do...
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private PopupMenu makePopupMenu() {
<b class="nc">&nbsp;    PopupMenu popup = new PopupMenu();</b>
<b class="nc">&nbsp;    ActionListener rmbListener = new TrayActionRMBListener();</b>
&nbsp;    // Enable or disable embedded HTTP server:
<b class="nc">&nbsp;    enableHttpServerItem = new CheckboxMenuItem(Tools.getLabel(messages.getString(&quot;tray_menu_enable_server&quot;)));</b>
<b class="nc">&nbsp;    enableHttpServerItem.setState(httpServer != null &amp;&amp; httpServer.isRunning());</b>
<b class="nc">&nbsp;    enableHttpServerItem.addItemListener(new TrayActionItemListener());</b>
<b class="nc">&nbsp;    popup.add(enableHttpServerItem);</b>
&nbsp;    // Check clipboard text:
<b class="nc">&nbsp;    MenuItem checkClipboardItem =</b>
<b class="nc">&nbsp;            new MenuItem(Tools.getLabel(messages.getString(&quot;guiMenuCheckClipboard&quot;)));</b>
<b class="nc">&nbsp;    checkClipboardItem.addActionListener(rmbListener);</b>
<b class="nc">&nbsp;    popup.add(checkClipboardItem);</b>
&nbsp;    // Open main window:
<b class="nc">&nbsp;    MenuItem restoreItem = new MenuItem(Tools.getLabel(messages.getString(&quot;guiMenuShowMainWindow&quot;)));</b>
<b class="nc">&nbsp;    restoreItem.addActionListener(rmbListener);</b>
<b class="nc">&nbsp;    popup.add(restoreItem);</b>
&nbsp;    // Exit:
<b class="nc">&nbsp;    MenuItem exitItem = new MenuItem(Tools.getLabel(messages.getString(&quot;guiMenuQuit&quot;)));</b>
<b class="nc">&nbsp;    exitItem.addActionListener(rmbListener);</b>
<b class="nc">&nbsp;    popup.add(exitItem);</b>
<b class="nc">&nbsp;    return popup;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void checkClipboardText() {
<b class="nc">&nbsp;    String s = getClipboardText();</b>
<b class="nc">&nbsp;    textArea.setText(s);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void hideToTray() {
<b class="nc">&nbsp;    if (!isInTray) {</b>
<b class="nc">&nbsp;      SystemTray tray = SystemTray.getSystemTray();</b>
<b class="nc">&nbsp;      String iconPath = tray.getTrayIconSize().height &gt; 16 ? TRAY_ICON : TRAY_SMALL_ICON;</b>
<b class="nc">&nbsp;      URL iconUrl = JLanguageTool.getDataBroker().getFromResourceDirAsUrl(iconPath);</b>
<b class="nc">&nbsp;      Image img = Toolkit.getDefaultToolkit().getImage(iconUrl);</b>
<b class="nc">&nbsp;      PopupMenu popup = makePopupMenu();</b>
&nbsp;      try {
<b class="nc">&nbsp;        trayIcon = new TrayIcon(img, TRAY_TOOLTIP, popup);</b>
<b class="nc">&nbsp;        trayIcon.addMouseListener(new TrayActionListener());</b>
<b class="nc">&nbsp;        setTrayIcon();</b>
<b class="nc">&nbsp;        tray.add(trayIcon);</b>
&nbsp;      } catch (AWTException e1) {
<b class="nc">&nbsp;        Tools.showError(e1);</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    isInTray = true;</b>
<b class="nc">&nbsp;    frame.setVisible(false);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void tagText() {
<b class="nc">&nbsp;    if (StringTools.isEmpty(textArea.getText().trim())) {</b>
<b class="nc">&nbsp;      textArea.setText(messages.getString(&quot;enterText2&quot;));</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    setWaitCursor();</b>
<b class="nc">&nbsp;    new Thread() {</b>
&nbsp;      @Override
&nbsp;      public void run() {
&nbsp;        try {
<b class="nc">&nbsp;          tagTextAndDisplayResults();</b>
&nbsp;        } finally {
<b class="nc">&nbsp;          SwingUtilities.invokeLater(() -&gt; unsetWaitCursor());</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;    }.start();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void quitOrHide() {
<b class="nc">&nbsp;    if (closeHidesToTray) {</b>
<b class="nc">&nbsp;      hideToTray();</b>
&nbsp;    } else {
<b class="nc">&nbsp;      quit();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void quit() {
<b class="nc">&nbsp;    stopServer();</b>
&nbsp;    try {
<b class="nc">&nbsp;      Configuration config = ltSupport.getConfig();</b>
<b class="nc">&nbsp;      config.setLanguage(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;      config.saveConfiguration(ltSupport.getLanguage());</b>
&nbsp;    } catch (IOException e) {
<b class="nc">&nbsp;      Tools.showError(e);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    MainWindowStateBean bean = new MainWindowStateBean();</b>
<b class="nc">&nbsp;    bean.setBounds(ResizeComponentListener.getBoundsProperty(frame));</b>
<b class="nc">&nbsp;    bean.setState(frame.getExtendedState());</b>
<b class="nc">&nbsp;    Component comp = mainPanel.getComponent(0);</b>
<b class="nc">&nbsp;    if(comp instanceof JSplitPane) {</b>
<b class="nc">&nbsp;      bean.setDividerLocation(((JSplitPane)comp).getDividerLocation());</b>
&nbsp;    } else {
<b class="nc">&nbsp;      MainWindowStateBean old = </b>
<b class="nc">&nbsp;        localStorage.loadProperty(GUI_STATE, MainWindowStateBean.class);</b>
<b class="nc">&nbsp;      bean.setDividerLocation(old.getDividerLocation());</b>
&nbsp;    }
<b class="nc">&nbsp;    localStorage.saveProperty(GUI_STATE, bean);</b>
&nbsp;
<b class="nc">&nbsp;    frame.setVisible(false);</b>
<b class="nc">&nbsp;    JLanguageTool.removeTemporaryFiles();</b>
<b class="nc">&nbsp;    System.exit(0);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void setTrayIcon() {
<b class="nc">&nbsp;    if (trayIcon != null) {</b>
<b class="nc">&nbsp;      SystemTray tray = SystemTray.getSystemTray();</b>
<b class="nc">&nbsp;      boolean httpServerRunning = httpServer != null &amp;&amp; httpServer.isRunning();</b>
<b class="nc">&nbsp;      boolean smallTray = tray.getTrayIconSize().height &lt;= 16;</b>
&nbsp;      String iconPath;
<b class="nc">&nbsp;      if (httpServerRunning) {</b>
<b class="nc">&nbsp;        trayIcon.setToolTip(messages.getString(&quot;tray_tooltip_server_running&quot;));</b>
<b class="nc">&nbsp;        iconPath = smallTray ? TRAY_SMALL_SERVER_ICON : TRAY_SERVER_ICON;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        trayIcon.setToolTip(TRAY_TOOLTIP);</b>
<b class="nc">&nbsp;        iconPath = smallTray ? TRAY_SMALL_ICON : TRAY_ICON;</b>
&nbsp;      }
<b class="nc">&nbsp;      URL iconUrl = JLanguageTool.getDataBroker().getFromResourceDirAsUrl(iconPath);</b>
<b class="nc">&nbsp;      Image img = Toolkit.getDefaultToolkit().getImage(iconUrl);</b>
<b class="nc">&nbsp;      trayIcon.setImage(img);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void showGUI() {
<b class="nc">&nbsp;    frame.setVisible(true);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void restoreFromTray() {
<b class="nc">&nbsp;    frame.setVisible(true);</b>
&nbsp;  }
&nbsp;
&nbsp;  // show GUI and check the text from clipboard/selection:
&nbsp;  private void restoreFromTrayAndCheck() {
<b class="nc">&nbsp;    String s = getClipboardText();</b>
<b class="nc">&nbsp;    restoreFromTray();</b>
<b class="nc">&nbsp;    textArea.setText(s);</b>
&nbsp;  }
&nbsp;
&nbsp;  private String getClipboardText() {
&nbsp;    // get text from clipboard or selection:
<b class="nc">&nbsp;    Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemSelection();</b>
<b class="nc">&nbsp;    if (clipboard == null) { // on Windows</b>
<b class="nc">&nbsp;      clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();</b>
&nbsp;    }
&nbsp;    String s;
<b class="nc">&nbsp;    Transferable data = clipboard.getContents(this);</b>
&nbsp;    try {
<b class="nc">&nbsp;      if (data != null</b>
<b class="nc">&nbsp;              &amp;&amp; data.isDataFlavorSupported(DataFlavor.getTextPlainUnicodeFlavor())) {</b>
<b class="nc">&nbsp;        DataFlavor df = DataFlavor.getTextPlainUnicodeFlavor();</b>
<b class="nc">&nbsp;        try (Reader sr = df.getReaderForText(data)) {</b>
<b class="nc">&nbsp;          s = StringTools.readerToString(sr);</b>
&nbsp;        }
&nbsp;      } else {
<b class="nc">&nbsp;        s = &quot;&quot;;</b>
&nbsp;      }
&nbsp;    } catch (Exception ex) {
<b class="nc">&nbsp;      s = data.toString();</b>
&nbsp;    }
<b class="nc">&nbsp;    return s;</b>
&nbsp;  }
&nbsp;
&nbsp;  private boolean maybeStartServer() {
<b class="nc">&nbsp;    Configuration config = ltSupport.getConfig();</b>
<b class="nc">&nbsp;    if (config.getRunServer()) {</b>
&nbsp;      try {
<b class="nc">&nbsp;        HTTPServerConfig serverConfig = new HTTPServerConfig(config.getServerPort(), false);</b>
<b class="nc">&nbsp;        serverConfig.setAllowOriginUrl(&quot;*&quot;);    // needed for Firefox so this server can be used from the add-on</b>
<b class="nc">&nbsp;        if (config.getNgramDirectory() != null) {</b>
<b class="nc">&nbsp;          serverConfig.setLanguageModelDirectory(config.getNgramDirectory().getAbsolutePath());</b>
&nbsp;        }
<b class="nc">&nbsp;        httpServer = new HTTPServer(serverConfig, true);</b>
<b class="nc">&nbsp;        httpServer.run();</b>
<b class="nc">&nbsp;        if (enableHttpServerItem != null) {</b>
<b class="nc">&nbsp;          enableHttpServerItem.setState(httpServer.isRunning());</b>
<b class="nc">&nbsp;          setTrayIcon();</b>
&nbsp;        }
&nbsp;      } catch (PortBindingException e) {
<b class="nc">&nbsp;        JOptionPane.showMessageDialog(null, e.getMessage(), &quot;Error&quot;, JOptionPane.ERROR_MESSAGE);</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return httpServer != null &amp;&amp; httpServer.isRunning();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void stopServer() {
<b class="nc">&nbsp;    if (httpServer != null) {</b>
<b class="nc">&nbsp;      httpServer.stop();</b>
<b class="nc">&nbsp;      if (enableHttpServerItem != null) {</b>
<b class="nc">&nbsp;        enableHttpServerItem.setState(httpServer.isRunning());</b>
<b class="nc">&nbsp;        setTrayIcon();</b>
&nbsp;      }
<b class="nc">&nbsp;      httpServer = null;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void checkTextAndDisplayResults() {
<b class="nc">&nbsp;    if (StringTools.isEmpty(textArea.getText().trim())) {</b>
<b class="nc">&nbsp;      textArea.setText(messages.getString(&quot;enterText2&quot;));</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    ltSupport.checkImmediately(getFrame());</b>
&nbsp;  }
&nbsp;
&nbsp;  private String getStackTraceAsHtml(Exception e) {
<b class="nc">&nbsp;    return &quot;&lt;br&gt;&lt;br&gt;&lt;b&gt;&lt;font color=\&quot;red\&quot;&gt;&quot;</b>
<b class="nc">&nbsp;            + org.languagetool.tools.Tools.getFullStackTrace(e).replace(&quot;\n&quot;, &quot;&lt;br/&gt;&quot;)</b>
&nbsp;            + &quot;&lt;/font&gt;&lt;/b&gt;&lt;br&gt;&quot;;
&nbsp;  }
&nbsp;
&nbsp;  private void setWaitCursor() {
<b class="nc">&nbsp;    frame.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
&nbsp;    // For some reason we also have to set the cursor here so it also shows
&nbsp;    // when user starts checking text with Ctrl+Return:
<b class="nc">&nbsp;    textArea.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
<b class="nc">&nbsp;    resultArea.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
&nbsp;  }
&nbsp;
&nbsp;  private void unsetWaitCursor() {
<b class="nc">&nbsp;    frame.setCursor(Cursor.getDefaultCursor());</b>
<b class="nc">&nbsp;    textArea.setCursor(Cursor.getDefaultCursor());</b>
<b class="nc">&nbsp;    resultArea.setCursor(Cursor.getDefaultCursor());</b>
&nbsp;  }
&nbsp;
&nbsp;  private boolean appendTagsWithDisambigLog(StringBuilder sb,
&nbsp;          AnalyzedSentence sentence, boolean odd) {
&nbsp;
<b class="nc">&nbsp;    for (AnalyzedTokenReadings t : sentence.getTokens()) {</b>
<b class="nc">&nbsp;      if (t.isWhitespace() &amp;&amp; !t.isSentenceStart()) {</b>
&nbsp;        continue;
&nbsp;      }
<b class="nc">&nbsp;      odd = !odd;</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;tr&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;td bgcolor=\&quot;&quot;);</b>
<b class="nc">&nbsp;      if(odd) {</b>
<b class="nc">&nbsp;        sb.append(&quot;#ffffff&quot;);</b>
&nbsp;      }
&nbsp;      else {
<b class="nc">&nbsp;        sb.append(&quot;#f1f1f1&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      sb.append(&quot;\&quot;&gt;&quot;);</b>
<b class="nc">&nbsp;      if(!t.isWhitespace()) {</b>
<b class="nc">&nbsp;        sb.append(t.getToken());</b>
<b class="nc">&nbsp;        sb.append(&quot;&lt;font color=&#39;&quot;);</b>
<b class="nc">&nbsp;        sb.append(TAG_COLOR);</b>
<b class="nc">&nbsp;        sb.append(&quot;&#39;&gt;[&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      Iterator&lt;AnalyzedToken&gt; iterator = t.iterator();</b>
<b class="nc">&nbsp;      while (iterator.hasNext()) {</b>
<b class="nc">&nbsp;        AnalyzedToken token = iterator.next();</b>
<b class="nc">&nbsp;        String posTag = token.getPOSTag();</b>
<b class="nc">&nbsp;        if (t.isSentenceStart()) {</b>
<b class="nc">&nbsp;          sb.append(StringTools.escapeHTML(&quot;&lt;S&gt;&quot;));</b>
<b class="nc">&nbsp;        } else if (JLanguageTool.SENTENCE_END_TAGNAME.equals(posTag)) {</b>
<b class="nc">&nbsp;          sb.append(StringTools.escapeHTML(&quot;&lt;/S&gt;&quot;));</b>
<b class="nc">&nbsp;        } else if (JLanguageTool.PARAGRAPH_END_TAGNAME.equals(posTag)) {</b>
<b class="nc">&nbsp;          sb.append(StringTools.escapeHTML(&quot;&lt;P/&gt;&quot;));</b>
&nbsp;        } else {
<b class="nc">&nbsp;          if (!t.isWhitespace()) {</b>
<b class="nc">&nbsp;          sb.append(token);</b>
<b class="nc">&nbsp;          if (iterator.hasNext()) {</b>
<b class="nc">&nbsp;            sb.append(&quot;, &quot;);</b>
&nbsp;          }
&nbsp;        }
&nbsp;      }
&nbsp;      }
<b class="nc">&nbsp;      if (!t.isWhitespace()) {</b>
<b class="nc">&nbsp;        if (t.getChunkTags().size() &gt; 0) {</b>
<b class="nc">&nbsp;          sb.append(&#39;,&#39;);</b>
<b class="nc">&nbsp;          sb.append(StringUtils.join(t.getChunkTags(), &quot;|&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (t.isImmunized()) {</b>
<b class="nc">&nbsp;          sb.append(&quot;{!}&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        sb.append(&quot;]&lt;/font&gt;&quot;);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        sb.append(&#39; &#39;);</b>
&nbsp;      }
<b class="nc">&nbsp;      sb.append(&quot;&lt;/td&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;td bgcolor=\&quot;&quot;);</b>
<b class="nc">&nbsp;      if(odd) {</b>
<b class="nc">&nbsp;        sb.append(&quot;#ffffff&quot;);</b>
&nbsp;      }
&nbsp;      else {
<b class="nc">&nbsp;        sb.append(&quot;#f1f1f1&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      sb.append(&quot;\&quot;&gt;&quot;);</b>
<b class="nc">&nbsp;      if (!&quot;&quot;.equals(t.getHistoricalAnnotations())) {</b>
<b class="nc">&nbsp;        sb.append(StringTools.escapeHTML(t.getHistoricalAnnotations())</b>
<b class="nc">&nbsp;                .trim().replace(&quot;\n&quot;, &quot;&lt;br&gt;&quot;));</b>
&nbsp;      }
<b class="nc">&nbsp;      sb.append(&quot;&lt;/td&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;/tr&gt;&quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    return odd;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void tagTextAndDisplayResults() {
&nbsp;    // make sure we track stats like the disambiguation log to be able to show them
<b class="nc">&nbsp;    GlobalConfig.setVerbose(true);</b>
<b class="nc">&nbsp;    JLanguageTool lt = ltSupport.getLanguageTool();</b>
&nbsp;    // tag text
<b class="nc">&nbsp;    List&lt;String&gt; sentences = lt.sentenceTokenize(textArea.getText());</b>
<b class="nc">&nbsp;    StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;    if(taggerShowsDisambigLog) {</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;table&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;tr&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;td&gt;&lt;b&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(messages.getString(&quot;token&quot;));</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;/b&gt;&lt;/td&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;td&gt;&lt;b&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(messages.getString(&quot;disambiguatorLog&quot;));</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;/b&gt;&lt;/td&gt;&quot;);</b>
<b class="nc">&nbsp;      sb.append(&quot;&lt;/tr&gt;&quot;);</b>
<b class="nc">&nbsp;      boolean odd = true;</b>
&nbsp;      try {
<b class="nc">&nbsp;        for (String sent : sentences) {</b>
<b class="nc">&nbsp;          AnalyzedSentence analyzed = lt.getAnalyzedSentence(sent);</b>
<b class="nc">&nbsp;          odd = appendTagsWithDisambigLog(sb, analyzed, odd);</b>
&nbsp;        }
&nbsp;      } catch (Exception e) {
<b class="nc">&nbsp;        sb.append(getStackTraceAsHtml(e));</b>
&nbsp;      }
<b class="nc">&nbsp;      sb.append(&quot;&lt;/table&gt;&quot;);</b>
&nbsp;    } else {
&nbsp;      try {
<b class="nc">&nbsp;        for (String sent : sentences) {</b>
<b class="nc">&nbsp;          AnalyzedSentence analyzed = lt.getAnalyzedSentence(sent);</b>
<b class="nc">&nbsp;          String analyzedString = StringTools.escapeHTML(analyzed.toString(&quot;,&quot;)).</b>
<b class="nc">&nbsp;                  replace(&quot;&amp;lt;S&amp;gt;&quot;, &quot;&amp;lt;S&amp;gt;&lt;br&gt;&quot;).</b>
<b class="nc">&nbsp;                  replace(&quot;[&quot;, &quot;&lt;font color=&#39;&quot; + TAG_COLOR + &quot;&#39;&gt;[&quot;).</b>
<b class="nc">&nbsp;                  replace(&quot;]&quot;, &quot;]&lt;/font&gt;&lt;br&gt;&quot;);</b>
<b class="nc">&nbsp;          sb.append(analyzedString).append(&#39;\n&#39;);</b>
&nbsp;        }
&nbsp;      } catch (Exception e) {
<b class="nc">&nbsp;        sb.append(getStackTraceAsHtml(e));</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    SwingUtilities.invokeLater(new Runnable() {</b>
&nbsp;      @Override
&nbsp;      public void run() {
<b class="nc">&nbsp;        if (taggerDialog == null) {</b>
<b class="nc">&nbsp;          taggerDialog = new JDialog(frame);</b>
<b class="nc">&nbsp;          taggerDialog.setTitle(messages.getString(&quot;taggerWindowTitle&quot;));</b>
<b class="nc">&nbsp;          taggerDialog.setDefaultCloseOperation(JDialog.HIDE_ON_CLOSE);</b>
<b class="nc">&nbsp;          taggerDialog.setResizable(true);</b>
<b class="nc">&nbsp;          taggerDialog.setSize(640, 480);</b>
<b class="nc">&nbsp;          taggerDialog.setLocationRelativeTo(frame);</b>
<b class="nc">&nbsp;          KeyStroke stroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</b>
<b class="nc">&nbsp;          ActionListener actionListener = actionEvent -&gt; taggerDialog.setVisible(false);</b>
<b class="nc">&nbsp;          taggerDialog.getRootPane().registerKeyboardAction(actionListener,</b>
&nbsp;                  stroke, JComponent.WHEN_IN_FOCUSED_WINDOW);
<b class="nc">&nbsp;          JPanel panel = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;          taggerDialog.add(panel);</b>
<b class="nc">&nbsp;          taggerArea = new JTextPane();</b>
<b class="nc">&nbsp;          taggerArea.setContentType(&quot;text/html&quot;);</b>
<b class="nc">&nbsp;          taggerArea.setEditable(false);</b>
<b class="nc">&nbsp;          GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;          c.gridx = 0;</b>
<b class="nc">&nbsp;          c.gridwidth = 2;</b>
<b class="nc">&nbsp;          c.gridy = 0;</b>
<b class="nc">&nbsp;          c.weightx = 1.0;</b>
<b class="nc">&nbsp;          c.weighty = 1.0;</b>
<b class="nc">&nbsp;          c.insets = new Insets(8,8,4,8);</b>
<b class="nc">&nbsp;          c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;          panel.add(new JScrollPane(taggerArea),c);</b>
<b class="nc">&nbsp;          c.gridwidth = 1;</b>
<b class="nc">&nbsp;          c.gridx = 0;</b>
<b class="nc">&nbsp;          c.gridy = 1;</b>
<b class="nc">&nbsp;          c.weightx = 0.0;</b>
<b class="nc">&nbsp;          c.weighty = 0.0;</b>
<b class="nc">&nbsp;          c.insets = new Insets(4,8,8,8);</b>
<b class="nc">&nbsp;          c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;          c.anchor = GridBagConstraints.EAST;</b>
<b class="nc">&nbsp;          JCheckBox showDisAmbig =</b>
<b class="nc">&nbsp;                  new JCheckBox(messages.getString(&quot;ShowDisambiguatorLog&quot;));</b>
<b class="nc">&nbsp;          showDisAmbig.setSelected(taggerShowsDisambigLog);</b>
<b class="nc">&nbsp;          showDisAmbig.addItemListener((ItemEvent e) -&gt; {</b>
<b class="nc">&nbsp;            taggerShowsDisambigLog = e.getStateChange() == ItemEvent.SELECTED;</b>
<b class="nc">&nbsp;            ltSupport.getConfig().setTaggerShowsDisambigLog(taggerShowsDisambigLog);</b>
&nbsp;          });
<b class="nc">&nbsp;          panel.add(showDisAmbig,c);</b>
<b class="nc">&nbsp;          c.gridx = 1;</b>
<b class="nc">&nbsp;          JButton closeButton = new JButton(</b>
<b class="nc">&nbsp;                  messages.getString(&quot;guiCloseButton&quot;));</b>
<b class="nc">&nbsp;          closeButton.addActionListener(actionListener);</b>
<b class="nc">&nbsp;          panel.add(closeButton,c);</b>
&nbsp;        }
&nbsp;        // orientation each time should be set as language may is changed
<b class="nc">&nbsp;        taggerDialog.applyComponentOrientation(ComponentOrientation.getOrientation(</b>
<b class="nc">&nbsp;                languageBox.getSelectedLanguage().getLocale()));</b>
&nbsp;
<b class="nc">&nbsp;        taggerDialog.setVisible(true);</b>
<b class="nc">&nbsp;        taggerArea.setText(HTML_FONT_START + sb + HTML_FONT_END);</b>
&nbsp;      }
&nbsp;    });
&nbsp;  }
&nbsp;
&nbsp;  private void setResultAreaVisible(boolean enable) {
<b class="nc">&nbsp;    if (enable) {</b>
<b class="nc">&nbsp;      this.mainPanel.removeAll();</b>
<b class="nc">&nbsp;      mainPanel.add(this.splitPane);</b>
<b class="nc">&nbsp;      splitPane.setTopComponent(numberedTextAreaPane);</b>
<b class="nc">&nbsp;      splitPane.setDividerLocation(200);</b>
<b class="nc">&nbsp;      MainWindowStateBean state</b>
<b class="nc">&nbsp;              = localStorage.loadProperty(GUI_STATE, MainWindowStateBean.class);</b>
<b class="nc">&nbsp;      if (state != null &amp;&amp; state.getDividerLocation() != null) {</b>
<b class="nc">&nbsp;        splitPane.setDividerLocation(state.getDividerLocation());</b>
&nbsp;      }
<b class="nc">&nbsp;      ResultAreaHelper.enable(resultArea);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      MainWindowStateBean bean = new MainWindowStateBean();</b>
<b class="nc">&nbsp;      bean.setDividerLocation(splitPane.getDividerLocation());</b>
<b class="nc">&nbsp;      localStorage.saveProperty(GUI_STATE, bean);</b>
<b class="nc">&nbsp;      this.mainPanel.removeAll();</b>
<b class="nc">&nbsp;      splitPane.setTopComponent(null);</b>
<b class="nc">&nbsp;      mainPanel.add(numberedTextAreaPane);</b>
<b class="nc">&nbsp;      ResultAreaHelper.disable(resultArea);</b>
&nbsp;    }
<b class="nc">&nbsp;    mainPanel.validate();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void setTrayMode(boolean trayMode) {
<b class="nc">&nbsp;    this.closeHidesToTray = trayMode;</b>
&nbsp;  }
&nbsp;
&nbsp;  public static void main(String[] args) {
<b class="nc">&nbsp;    if (System.getSecurityManager() == null) {</b>
<b class="nc">&nbsp;      JnaTools.setBugWorkaroundProperty();</b>
&nbsp;    }
<b class="nc">&nbsp;    LocalStorage localStorage = new LocalStorage();</b>
<b class="nc">&nbsp;    LocaleBean bean = localStorage.loadProperty(&quot;gui.locale&quot;, LocaleBean.class);</b>
<b class="nc">&nbsp;    if(bean != null) {</b>
<b class="nc">&nbsp;      Locale.setDefault(bean.asLocale());</b>
&nbsp;    }
<b class="nc">&nbsp;    Main prg = new Main(localStorage);</b>
<b class="nc">&nbsp;    if (args.length == 1 &amp;&amp; (args[0].equals(&quot;-t&quot;) || args[0].equals(&quot;--tray&quot;))) {</b>
&nbsp;      // dock to systray on startup
<b class="nc">&nbsp;      SwingUtilities.invokeLater(new Runnable() {</b>
&nbsp;        @Override
&nbsp;        public void run() {
&nbsp;          try {
<b class="nc">&nbsp;            prg.createGUI();</b>
<b class="nc">&nbsp;            prg.setTrayMode(true);</b>
<b class="nc">&nbsp;            prg.hideToTray();</b>
&nbsp;          } catch (Exception e) {
<b class="nc">&nbsp;            Tools.showError(e);</b>
<b class="nc">&nbsp;            System.exit(1);</b>
&nbsp;          }
&nbsp;        }
&nbsp;      });
<b class="nc">&nbsp;    } else if (args.length == 1 &amp;&amp; (args[0].equals(&quot;-h&quot;) || args[0].equals(&quot;--help&quot;))) {</b>
<b class="nc">&nbsp;      printUsage();</b>
<b class="nc">&nbsp;    } else if (args.length == 0 || args.length == 1) {</b>
<b class="nc">&nbsp;      SwingUtilities.invokeLater(new Runnable() {</b>
&nbsp;        @Override
&nbsp;        public void run() {
&nbsp;          try {
<b class="nc">&nbsp;            prg.createGUI();</b>
<b class="nc">&nbsp;            prg.showGUI();</b>
<b class="nc">&nbsp;            if (args.length == 1) {</b>
<b class="nc">&nbsp;              prg.loadFile(new File(args[0]));</b>
&nbsp;            }
&nbsp;          } catch (Exception e) {
<b class="nc">&nbsp;            Tools.showError(e);</b>
&nbsp;          }
&nbsp;        }
&nbsp;      });
&nbsp;    } else {
<b class="nc">&nbsp;      printUsage();</b>
<b class="nc">&nbsp;      System.exit(1);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static void printUsage() {
<b class="nc">&nbsp;    System.out.println(&quot;Usage: java org.languagetool.gui.Main [-t|--tray]&quot;);</b>
<b class="nc">&nbsp;    System.out.println(&quot;    or java org.languagetool.gui.Main [file]&quot;);</b>
<b class="nc">&nbsp;    System.out.println(&quot;Parameters:&quot;);</b>
<b class="nc">&nbsp;    System.out.println(&quot;    -t, --tray: dock LanguageTool to system tray on startup&quot;);</b>
<b class="nc">&nbsp;    System.out.println(&quot;    file:       a plain text file to load on startup&quot;);</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private class ControlReturnTextCheckingListener extends KeyAdapter {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void keyPressed(KeyEvent e) {
<b class="nc">&nbsp;      if (e.getKeyCode() == KeyEvent.VK_ENTER &amp;&amp;</b>
<b class="nc">&nbsp;          (e.getModifiersEx() &amp; KeyEvent.CTRL_DOWN_MASK) == KeyEvent.CTRL_DOWN_MASK) {</b>
<b class="nc">&nbsp;        checkTextAndDisplayResults();</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  //
&nbsp;  // The System Tray stuff
&nbsp;  //
&nbsp;
<b class="nc">&nbsp;  class TrayActionItemListener implements ItemListener {</b>
&nbsp;    @Override
&nbsp;    public void itemStateChanged(ItemEvent e) {
&nbsp;      try {
<b class="nc">&nbsp;        Configuration config = ltSupport.getConfig();</b>
<b class="nc">&nbsp;        if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;          config.setRunServer(true);</b>
<b class="nc">&nbsp;          boolean serverStarted = maybeStartServer();</b>
<b class="nc">&nbsp;          enableHttpServerItem.setState(serverStarted);</b>
<b class="nc">&nbsp;          config.setRunServer(serverStarted);</b>
<b class="nc">&nbsp;          config.saveConfiguration(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;        } else if (e.getStateChange() == ItemEvent.DESELECTED) {</b>
<b class="nc">&nbsp;          config.setRunServer(false);</b>
<b class="nc">&nbsp;          config.saveConfiguration(ltSupport.getLanguage());</b>
<b class="nc">&nbsp;          stopServer();</b>
&nbsp;        }
&nbsp;      } catch (IOException ex) {
<b class="nc">&nbsp;        Tools.showError(ex);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  class TrayActionRMBListener implements ActionListener {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      if (isCommand(e, &quot;guiMenuCheckClipboard&quot;)) {</b>
<b class="nc">&nbsp;        restoreFromTrayAndCheck();</b>
<b class="nc">&nbsp;      } else if (isCommand(e, &quot;guiMenuShowMainWindow&quot;)) {</b>
<b class="nc">&nbsp;        restoreFromTray();</b>
<b class="nc">&nbsp;      } else if (isCommand(e, &quot;guiMenuQuit&quot;)) {</b>
<b class="nc">&nbsp;        quit();</b>
&nbsp;      } else {
<b class="nc">&nbsp;        JOptionPane.showMessageDialog(null, &quot;Unknown action: &quot;</b>
<b class="nc">&nbsp;                + e.getActionCommand(), &quot;Error&quot;, JOptionPane.ERROR_MESSAGE);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    private boolean isCommand(ActionEvent e, String label) {
<b class="nc">&nbsp;      return e.getActionCommand().equalsIgnoreCase(Tools.getLabel(messages.getString(label)));</b>
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  class TrayActionListener extends MouseAdapter {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void mouseClicked(@SuppressWarnings(&quot;unused&quot;)MouseEvent e) {
<b class="nc">&nbsp;      if (frame.isVisible() &amp;&amp; frame.isActive()) {</b>
<b class="nc">&nbsp;        frame.setVisible(false);</b>
<b class="nc">&nbsp;      } else if (frame.isVisible() &amp;&amp; !frame.isActive()) {</b>
<b class="nc">&nbsp;        frame.toFront();</b>
<b class="nc">&nbsp;        restoreFromTrayAndCheck();</b>
&nbsp;      } else {
<b class="nc">&nbsp;        restoreFromTrayAndCheck();</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  class CloseListener extends WindowAdapter {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowClosing(@SuppressWarnings(&quot;unused&quot;)WindowEvent e) {
<b class="nc">&nbsp;      quitOrHide();</b>
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  static class PlainTextFileFilter extends FileFilter {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean accept(File f) {
<b class="nc">&nbsp;      boolean isTextFile = f.getName().toLowerCase().endsWith(&quot;.txt&quot;);</b>
<b class="nc">&nbsp;      return isTextFile || f.isDirectory();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getDescription() {
<b class="nc">&nbsp;      return &quot;*.txt&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;
&nbsp;  class OpenAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    OpenAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuOpen&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;guiMenuOpenShortDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LONG_DESCRIPTION, messages.getString(&quot;guiMenuOpenLongDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuOpen&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, getMenuKeyStroke(KeyEvent.VK_O));</b>
<b class="nc">&nbsp;      putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_open.png&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_open.png&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      loadFile();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class SaveAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    SaveAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuSave&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;guiMenuSaveShortDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LONG_DESCRIPTION, messages.getString(&quot;guiMenuSaveLongDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuSave&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, KeyStroke.getKeyStroke(KeyEvent.VK_S, Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));</b>
<b class="nc">&nbsp;      putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_save.png&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_save.png&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      saveFile(false);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class SaveAsAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    SaveAsAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuSaveAs&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;guiMenuSaveAsShortDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LONG_DESCRIPTION, messages.getString(&quot;guiMenuSaveAsLongDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuSaveAs&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_saveas.png&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_saveas.png&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      saveFile(true);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class CheckClipboardAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    CheckClipboardAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuCheckClipboard&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuCheckClipboard&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, getMenuKeyStroke(KeyEvent.VK_Y));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      checkClipboardText();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class TagTextAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    TagTextAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiTagText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiTagText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, getMenuKeyStroke(KeyEvent.VK_T));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      tagText();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class AddRulesAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    AddRulesAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuAddRules&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuAddRules&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
&nbsp;      try {
<b class="nc">&nbsp;        addLanguage();</b>
&nbsp;      } catch (Exception ex) {
<b class="nc">&nbsp;        Tools.showError(ex);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class OptionsAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    OptionsAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuOptions&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuOptions&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, getMenuKeyStroke(KeyEvent.VK_S));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      showOptions();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class SelectFontAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    SelectFontAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiSelectFont&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      showSelectFontDialog();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class SelectLFAction extends AbstractAction {
&nbsp;
&nbsp;    private final UIManager.LookAndFeelInfo lf;
&nbsp;
<b class="nc">&nbsp;    SelectLFAction(UIManager.LookAndFeelInfo lf) {</b>
<b class="nc">&nbsp;      super(lf.getName());</b>
<b class="nc">&nbsp;      this.lf = lf;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
&nbsp;      try {
<b class="nc">&nbsp;        UIManager.setLookAndFeel(lf.getClassName());</b>
<b class="nc">&nbsp;        SwingUtilities.updateComponentTreeUI(frame);</b>
<b class="nc">&nbsp;        frame.pack();</b>
<b class="nc">&nbsp;        ltSupport.getConfig().setLookAndFeelName(lf.getName());</b>
&nbsp;      } catch (ClassNotFoundException | InstantiationException
&nbsp;              | IllegalAccessException | UnsupportedLookAndFeelException ex) {
<b class="nc">&nbsp;        Tools.showError(ex);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class HideAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    HideAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuHide&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuHide&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, getMenuKeyStroke(KeyEvent.VK_D));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      hideToTray();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class QuitAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    QuitAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuQuit&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuQuit&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.ACCELERATOR_KEY, getMenuKeyStroke(KeyEvent.VK_Q));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      quit();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class AboutAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    AboutAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuAbout&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiMenuAbout&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      AboutDialog about = new AboutDialog(messages, getFrame());</b>
<b class="nc">&nbsp;      about.show();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class CheckAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    CheckAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;checkText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;checkTextShortDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LONG_DESCRIPTION, messages.getString(&quot;checkTextLongDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;checkText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_spelldialog.png&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_spelldialog.png&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      checkTextAndDisplayResults();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class AutoCheckAction extends AbstractAction {
&nbsp;
&nbsp;    private boolean enable;
&nbsp;
<b class="nc">&nbsp;    AutoCheckAction(boolean initial) {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;autoCheckText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;autoCheckTextShortDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LONG_DESCRIPTION, messages.getString(&quot;autoCheckTextLongDesc&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;autoCheckText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_spellonline.png&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_spellonline.png&quot;));</b>
<b class="nc">&nbsp;      enable = initial;</b>
<b class="nc">&nbsp;      putValue(Action.SELECTED_KEY, enable);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      enable = !enable;</b>
<b class="nc">&nbsp;      putValue(Action.SELECTED_KEY, enable);</b>
<b class="nc">&nbsp;      ltSupport.setBackgroundCheckEnabled(enable);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class ClearTextAction extends AbstractAction {
&nbsp;
<b class="nc">&nbsp;    ClearTextAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;clearText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;clearText&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SMALL_ICON, getImageIcon(&quot;sc_closedoc.png&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LARGE_ICON_KEY, getImageIcon(&quot;lc_closedoc.png&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      ltSupport.getTextComponent().setText(&quot;&quot;);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private class SelectAllAction extends TextAction {
&nbsp;
<b class="nc">&nbsp;    private SelectAllAction() {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiMenuSelectAll&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, KeyEvent.VK_A);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      JTextComponent component = getFocusedComponent();</b>
<b class="nc">&nbsp;      component.selectAll();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class RecentFileAction extends AbstractAction {
&nbsp;
&nbsp;    private final File file;
&nbsp;
<b class="nc">&nbsp;    RecentFileAction(File file) {</b>
<b class="nc">&nbsp;      super(file.getName());</b>
<b class="nc">&nbsp;      this.file = file;</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, file.getAbsolutePath());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      if(file.exists()) {</b>
<b class="nc">&nbsp;        loadFile(file);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        JOptionPane.showMessageDialog(frame, messages.getString(&quot;guiFileNotFound&quot;),</b>
<b class="nc">&nbsp;                messages.getString(&quot;dialogTitleError&quot;), JOptionPane.ERROR_MESSAGE);</b>
<b class="nc">&nbsp;        recentFiles.remove(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        updateRecentFilesMenu();</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  class ShowResultAction extends AbstractAction {
&nbsp;
&nbsp;    private boolean enable;
&nbsp;
<b class="nc">&nbsp;    ShowResultAction(boolean initial) {</b>
<b class="nc">&nbsp;      super(getLabel(&quot;guiShowResultArea&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.SHORT_DESCRIPTION, messages.getString(&quot;guiShowResultArea&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.LONG_DESCRIPTION, messages.getString(&quot;guiShowResultArea&quot;));</b>
<b class="nc">&nbsp;      putValue(Action.MNEMONIC_KEY, getMnemonic(&quot;guiShowResultArea&quot;));</b>
<b class="nc">&nbsp;      enable = initial;</b>
<b class="nc">&nbsp;      putValue(Action.SELECTED_KEY, enable);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;      enable = !enable;</b>
<b class="nc">&nbsp;      putValue(Action.SELECTED_KEY, enable);</b>
<b class="nc">&nbsp;      setResultAreaVisible(enable);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private ImageIcon getImageIcon(String filename) {
<b class="nc">&nbsp;    Image image = Toolkit.getDefaultToolkit().getImage(</b>
<b class="nc">&nbsp;            JLanguageTool.getDataBroker().getFromResourceDirAsUrl(filename));</b>
<b class="nc">&nbsp;    return new ImageIcon(image);</b>
&nbsp;  }
&nbsp;
&nbsp;  private ConfigurationDialog getCurrentConfigDialog() {
<b class="nc">&nbsp;    Language language = ltSupport.getLanguage();</b>
&nbsp;    ConfigurationDialog configDialog;
<b class="nc">&nbsp;    if (configDialogs.containsKey(language)) {</b>
<b class="nc">&nbsp;      configDialog = configDialogs.get(language);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      configDialog = new ConfigurationDialog(frame, false, ltSupport.getConfig());</b>
<b class="nc">&nbsp;      configDialog.addExtraPanel(new GuiLangConfigPanel(messages, localStorage));</b>
<b class="nc">&nbsp;      configDialogs.put(language, configDialog);</b>
&nbsp;    }
<b class="nc">&nbsp;    return configDialog;</b>
&nbsp;  }
&nbsp;  /**
&nbsp;   *  This class will display line numbers for a related text component. The text
&nbsp;   *  component must use the same line height for each line. TextLineNumber
&nbsp;   *  supports wrapped lines and will highlight the line number of the current
&nbsp;   *  line in the text component.
&nbsp;   *
&nbsp;   *  This class was designed to be used as a component added to the row header
&nbsp;   *  of a JScrollPane.
&nbsp;   *
&nbsp;   *  Credits: The implementation of this class is based on
&nbsp;   *  &quot;Text Component Line Number&quot; Posted by Rob Camick on May 23, 2009 at
&nbsp;   *  https://tips4java.wordpress.com/2009/05/23/text-component-line-number/
&nbsp;   *
&nbsp;   *  Usage / License according to https://tips4java.wordpress.com/about/ :
&nbsp;   *  You are free to use and/or modify and/or distribute any or all code posted
&nbsp;   *  on the Java Tips Weblog without restriction. A credit in the code comments
&nbsp;   *  would be nice, but not in any way mandatory.
&nbsp;   */
&nbsp;  public class TextLineNumber extends JPanel
&nbsp;    implements CaretListener, DocumentListener, ComponentListener, PropertyChangeListener
&nbsp;  {
&nbsp;    private static final long serialVersionUID = 1L;
&nbsp;    public final static float LEFT = 0.0f;
&nbsp;    public final static float CENTER = 0.5f;
&nbsp;    public final static float RIGHT = 1.0f;
&nbsp;
<b class="nc">&nbsp;    private final Border OUTER = new MatteBorder(0, 0, 0, 1, Color.GRAY);</b>
&nbsp;
&nbsp;    //  Text component this TextTextLineNumber component is in sync with
&nbsp;    private final JTextComponent component;
&nbsp;
&nbsp;    //  Properties that can be changed
&nbsp;    private int borderGap;
&nbsp;    private Color currentLineForeground;
&nbsp;    private float digitAlignment;
&nbsp;    private int minimumDisplayDigits;
&nbsp;
&nbsp;    //  Keep history information to reduce the number of times the component
&nbsp;    //  needs to be repainted
&nbsp;    private int lastLine;
&nbsp;
&nbsp;    /**
&nbsp;     *  Create a line number component for a text component.
&nbsp;     *
&nbsp;     *  @param component  the related text component
&nbsp;     *  @param minimumDisplayDigits  the number of digits used to calculate
&nbsp;     *                               the minimum width of the component
&nbsp;     */
<b class="nc">&nbsp;    public TextLineNumber(JTextComponent component, int minimumDisplayDigits) {</b>
<b class="nc">&nbsp;      this.component = component;</b>
&nbsp;
<b class="nc">&nbsp;      setFont(component.getFont());</b>
<b class="nc">&nbsp;      setBorderGap(5);</b>
<b class="nc">&nbsp;      setCurrentLineForeground(Color.RED);</b>
<b class="nc">&nbsp;      setDigitAlignment(RIGHT);</b>
<b class="nc">&nbsp;      setMinimumDisplayDigits(minimumDisplayDigits);</b>
&nbsp;
<b class="nc">&nbsp;      component.getDocument().addDocumentListener(this);</b>
<b class="nc">&nbsp;      component.addCaretListener(this);</b>
<b class="nc">&nbsp;      component.addPropertyChangeListener(&quot;font&quot;, this);</b>
<b class="nc">&nbsp;      component.addComponentListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Gets the border gap
&nbsp;     *  @return the border gap in pixels
&nbsp;     */
&nbsp;    public int getBorderGap() {
<b class="nc">&nbsp;      return borderGap;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  The border gap is used in calculating the left and right insets of the
&nbsp;     *  border. Default value is 5.
&nbsp;     *  @param borderGap  the gap in pixels
&nbsp;     */
&nbsp;    public void setBorderGap(int borderGap) {
<b class="nc">&nbsp;      this.borderGap = borderGap;</b>
<b class="nc">&nbsp;      Border inner = new EmptyBorder(0, borderGap, 0, borderGap);</b>
<b class="nc">&nbsp;      setBorder(new CompoundBorder(OUTER, inner));</b>
<b class="nc">&nbsp;      setPreferredWidth();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Gets the current line rendering Color
&nbsp;     *
&nbsp;     *  @return the Color used to render the current line number
&nbsp;     */
&nbsp;    public Color getCurrentLineForeground() {
<b class="nc">&nbsp;      return currentLineForeground == null ? getForeground() : currentLineForeground;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  The Color used to render the current line digits. Default is Coolor.RED.
&nbsp;     *
&nbsp;     *  @param currentLineForeground  the Color used to render the current line
&nbsp;     */
&nbsp;    public void setCurrentLineForeground(Color currentLineForeground) {
<b class="nc">&nbsp;      this.currentLineForeground = currentLineForeground;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Gets the digit alignment
&nbsp;     *
&nbsp;     *  @return the alignment of the painted digits
&nbsp;     */
&nbsp;    public float getDigitAlignment() {
<b class="nc">&nbsp;     return digitAlignment;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Specify the horizontal alignment of the digits within the component.
&nbsp;     *  Common values would be:
&nbsp;     *  &lt;ul&gt;
&nbsp;     *  &lt;li&gt;TextLineNumber.LEFT
&nbsp;     *  &lt;li&gt;TextLineNumber.CENTER
&nbsp;     *  &lt;li&gt;TextLineNumber.RIGHT (default)
&nbsp;     *  &lt;/ul&gt;
&nbsp;     */
&nbsp;    public void setDigitAlignment(float digitAlignment)  {
<b class="nc">&nbsp;      this.digitAlignment =</b>
<b class="nc">&nbsp;        digitAlignment &gt; 1.0f ? 1.0f : digitAlignment &lt; 0.0f ? -1.0f : digitAlignment;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Gets the minimum display digits
&nbsp;     *
&nbsp;     *  @return the minimum display digits
&nbsp;     */
&nbsp;    public int getMinimumDisplayDigits() {
<b class="nc">&nbsp;      return minimumDisplayDigits;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Specify the minimum number of digits used to calculate the preferred
&nbsp;     *  width of the component.
&nbsp;     *
&nbsp;     *  @param minimumDisplayDigits  the number digits used in the preferred
&nbsp;     *                               width calculation
&nbsp;     */
&nbsp;    public void setMinimumDisplayDigits(int minimumDisplayDigits) {
<b class="nc">&nbsp;      this.minimumDisplayDigits = minimumDisplayDigits;</b>
<b class="nc">&nbsp;      setPreferredWidth();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Calculate the width needed to display the maximum line number
&nbsp;     */
&nbsp;    private void setPreferredWidth() {
<b class="nc">&nbsp;      Element root = component.getDocument().getDefaultRootElement();</b>
<b class="nc">&nbsp;      int lines = root.getElementCount();</b>
<b class="nc">&nbsp;      int digits = Math.max(String.valueOf(lines).length(), minimumDisplayDigits);</b>
&nbsp;
<b class="nc">&nbsp;      FontMetrics fontMetrics = getFontMetrics(getFont());</b>
<b class="nc">&nbsp;      int width = fontMetrics.charWidth(&#39;0&#39;) * digits;</b>
<b class="nc">&nbsp;      Insets insets = getInsets();</b>
<b class="nc">&nbsp;      int preferredWidth = insets.left + insets.right + width;</b>
&nbsp;
<b class="nc">&nbsp;      Dimension d = getPreferredSize();</b>
<b class="nc">&nbsp;      d.setSize(preferredWidth, component.getHeight());</b>
<b class="nc">&nbsp;      setPreferredSize(d);</b>
<b class="nc">&nbsp;      setSize(d);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Draw the line numbers
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void paintComponent(Graphics g) {
<b class="nc">&nbsp;      super.paintComponent(g);</b>
&nbsp;
&nbsp;      //  Determine the width of the space available to draw the line number
<b class="nc">&nbsp;      FontMetrics fontMetrics = component.getFontMetrics(component.getFont());</b>
<b class="nc">&nbsp;      Insets insets = getInsets();</b>
<b class="nc">&nbsp;      int availableWidth = getSize().width - insets.left - insets.right;</b>
&nbsp;
&nbsp;      //  Determine the rows to draw within the clipped bounds.
<b class="nc">&nbsp;      Rectangle clip = g.getClipBounds();</b>
<b class="nc">&nbsp;      int rowStartOffset = component.viewToModel(new Point(0, clip.y));</b>
<b class="nc">&nbsp;      int endOffset      = component.viewToModel(new Point(0, clip.y + clip.height));</b>
&nbsp;
<b class="nc">&nbsp;      while (rowStartOffset &lt;= endOffset)</b>
&nbsp;      {
&nbsp;        try {
<b class="nc">&nbsp;          if (isCurrentLine(rowStartOffset)) {</b>
<b class="nc">&nbsp;            g.setColor(getCurrentLineForeground());</b>
&nbsp;          } else {
<b class="nc">&nbsp;            g.setColor(getForeground());</b>
&nbsp;          }
&nbsp;          //  Get the line number as a string and then determine the
&nbsp;          //  &quot;X&quot; and &quot;Y&quot; offsets for drawing the string.
&nbsp;
<b class="nc">&nbsp;          String lineNumber = getTextLineNumber(rowStartOffset);</b>
<b class="nc">&nbsp;          if (!lineNumber.isEmpty()) {</b>
<b class="nc">&nbsp;            int stringWidth = fontMetrics.stringWidth(lineNumber);</b>
<b class="nc">&nbsp;            int x = getOffsetX(availableWidth, stringWidth) + insets.left;</b>
<b class="nc">&nbsp;            int y = getOffsetY(rowStartOffset, fontMetrics);</b>
<b class="nc">&nbsp;            g.drawString(lineNumber, x, y);</b>
&nbsp;          }
&nbsp;          //  Move to the next row
<b class="nc">&nbsp;          rowStartOffset = Utilities.getRowEnd(component, rowStartOffset) + 1;</b>
&nbsp;        }
&nbsp;        catch(Exception e) {
<b class="nc">&nbsp;          e.printStackTrace();</b>
&nbsp;          break;
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     *  We need to know if the caret is currently positioned on the line we
&nbsp;     *  are about to paint so the line number can be highlighted.
&nbsp;     */
&nbsp;    private boolean isCurrentLine(int rowStartOffset) {
<b class="nc">&nbsp;      int caretPosition = component.getCaretPosition();</b>
<b class="nc">&nbsp;      Element root = component.getDocument().getDefaultRootElement();</b>
<b class="nc">&nbsp;      return root.getElementIndex(rowStartOffset) == root.getElementIndex(caretPosition);</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     *  Get the line number to be drawn. The empty string will be returned
&nbsp;     *  when a line of text has wrapped.
&nbsp;     */
&nbsp;    protected String getTextLineNumber(int rowStartOffset) {
<b class="nc">&nbsp;      Element root = component.getDocument().getDefaultRootElement();</b>
<b class="nc">&nbsp;      int index = root.getElementIndex(rowStartOffset);</b>
<b class="nc">&nbsp;      Element line = root.getElement(index);</b>
<b class="nc">&nbsp;      if (line.getStartOffset() == rowStartOffset) {</b>
<b class="nc">&nbsp;        return String.valueOf(index + 1);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        return &quot;&quot;;</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     *  Determine the X offset to properly align the line number when drawn
&nbsp;     */
&nbsp;    private int getOffsetX(int availableWidth, int stringWidth)
&nbsp;    {
<b class="nc">&nbsp;      return (int)((availableWidth - stringWidth) * digitAlignment);</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     *  Determine the Y offset for the current row
&nbsp;     */
&nbsp;    private int getOffsetY(int rowStartOffset, FontMetrics fontMetrics) throws BadLocationException {
&nbsp;      //  Get the bounding rectangle of the row
<b class="nc">&nbsp;      Rectangle r = component.modelToView(rowStartOffset);</b>
<b class="nc">&nbsp;      int y = r.y + r.height;</b>
&nbsp;      //  The text needs to be positioned above the bottom of the bounding
&nbsp;      //  rectangle based on the descent of the font(s) contained on the row.
<b class="nc">&nbsp;      return y - fontMetrics.getDescent();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void caretUpdate(CaretEvent e) {
&nbsp;      //  Get the line the caret is positioned on
<b class="nc">&nbsp;      int caretPosition = component.getCaretPosition();</b>
<b class="nc">&nbsp;      Element root = component.getDocument().getDefaultRootElement();</b>
<b class="nc">&nbsp;      int currentLine = root.getElementIndex(caretPosition);</b>
&nbsp;
&nbsp;      //  Need to repaint so the correct line number can be highlighted
<b class="nc">&nbsp;      if (lastLine != currentLine) {</b>
<b class="nc">&nbsp;        setPreferredWidth();</b>
<b class="nc">&nbsp;        documentChanged();</b>
<b class="nc">&nbsp;        lastLine = currentLine;</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void changedUpdate(DocumentEvent e) {
&nbsp;      //setPreferredWidth();
&nbsp;      //documentChanged();
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;      setPreferredWidth();</b>
<b class="nc">&nbsp;      documentChanged();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void removeUpdate(DocumentEvent e) {
&nbsp;      //setPreferredWidth();
<b class="nc">&nbsp;      documentChanged();</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     *  A document change may affect the number of displayed lines of text.
&nbsp;     *  Therefore the lines numbers will also change.
&nbsp;     */
&nbsp;    private void documentChanged() {
&nbsp;      //  View of the component has not been updated at the time
&nbsp;      //  the DocumentEvent is fired
<b class="nc">&nbsp;      SwingUtilities.invokeLater(new Runnable()</b>
<b class="nc">&nbsp;      {</b>
&nbsp;        @Override
&nbsp;        public void run() {
<b class="nc">&nbsp;          repaint();</b>
&nbsp;        }
&nbsp;      });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void propertyChange(PropertyChangeEvent evt) {
<b class="nc">&nbsp;      if (evt.getNewValue() instanceof Font) {</b>
<b class="nc">&nbsp;        Font newFont = (Font) evt.getNewValue();</b>
<b class="nc">&nbsp;        setFont(newFont);</b>
<b class="nc">&nbsp;        setPreferredWidth();</b>
<b class="nc">&nbsp;        documentChanged();</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;  @Override
&nbsp;  public void componentResized(ComponentEvent e) {
<b class="nc">&nbsp;    setPreferredWidth();</b>
<b class="nc">&nbsp;    documentChanged();</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public void componentMoved(ComponentEvent e) {
&nbsp;    // nothing to do here because moving the component does not change line numbers
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  @Override
&nbsp;  public void componentShown(ComponentEvent e) {
<b class="nc">&nbsp;    setPreferredWidth();</b>
<b class="nc">&nbsp;    documentChanged();</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public void componentHidden(ComponentEvent e) {
&nbsp;    // nothing to do here because moving the component does not change line numbers
<b class="nc">&nbsp;  }</b>
&nbsp; }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-02-17 23:45</div>
</div>
</body>
</html>
