


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LanguageToolSupport</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.languagetool.gui</a>
</div>

<h1>Coverage Summary for Class: LanguageToolSupport (org.languagetool.gui)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LanguageToolSupport</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/178)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/332)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LanguageToolSupport$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LanguageToolSupport$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LanguageToolSupport$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LanguageToolSupport$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LanguageToolSupport$ReplaceMenuItem</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LanguageToolSupport$RunnableImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LanguageToolSupport$Span</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/67)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/196)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/384)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/* LanguageTool, a natural language style checker
&nbsp; * Copyright (C) 2005 Daniel Naber (http://www.danielnaber.de)
&nbsp; * 
&nbsp; * This library is free software; you can redistribute it and/or
&nbsp; * modify it under the terms of the GNU Lesser General Public
&nbsp; * License as published by the Free Software Foundation; either
&nbsp; * version 2.1 of the License, or (at your option) any later version.
&nbsp; *
&nbsp; * This library is distributed in the hope that it will be useful,
&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
&nbsp; * Lesser General Public License for more details.
&nbsp; *
&nbsp; * You should have received a copy of the GNU Lesser General Public
&nbsp; * License along with this library; if not, write to the Free Software
&nbsp; * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301
&nbsp; * USA
&nbsp; */
&nbsp;package org.languagetool.gui;
&nbsp;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.jetbrains.annotations.Nullable;
&nbsp;import org.languagetool.*;
&nbsp;import org.languagetool.language.identifier.LanguageIdentifier;
&nbsp;import org.languagetool.language.identifier.LanguageIdentifierService;
&nbsp;import org.languagetool.rules.*;
&nbsp;
&nbsp;import javax.swing.*;
&nbsp;import javax.swing.event.*;
&nbsp;import javax.swing.text.*;
&nbsp;import java.awt.*;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.MouseEvent;
&nbsp;import java.awt.event.MouseListener;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.lang.reflect.InvocationTargetException;
&nbsp;import java.net.URL;
&nbsp;import java.util.List;
&nbsp;import java.util.*;
&nbsp;import java.util.concurrent.ScheduledExecutorService;
&nbsp;import java.util.concurrent.ScheduledThreadPoolExecutor;
&nbsp;import java.util.concurrent.ThreadFactory;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;
&nbsp;/**
&nbsp; * Support for associating a LanguageTool instance and a JTextComponent
&nbsp; *
&nbsp; * @author Panagiotis Minos
&nbsp; * @since 2.3
&nbsp; */
&nbsp;class LanguageToolSupport {
&nbsp;
&nbsp;  static final String CONFIG_FILE = &quot;.languagetool.cfg&quot;;
&nbsp;
&nbsp;  //maximum entries in the activate rule menu.
&nbsp;  //If entries&#39; number is bigger, create per category submenus
&nbsp;  //can set to 0 to always create category submenus
&nbsp;  private static final int MAX_RULES_NO_CATEGORY_MENU = 12;
&nbsp;  //maximum rule menu entries, if more create a More submenu
&nbsp;  private static final int MAX_RULES_PER_MENU = 12;
&nbsp;  //maximum category menu entries, if more create a More submenu
&nbsp;  private static final int MAX_CATEGORIES_PER_MENU = 12;
&nbsp;
&nbsp;  private final UndoRedoSupport undo;
&nbsp;  private final LanguageIdentifier langIdentifier;
&nbsp;  private final JFrame frame;
&nbsp;  private final JTextComponent textComponent;
<b class="nc">&nbsp;  private final EventListenerList listenerList = new EventListenerList();</b>
&nbsp;  private final ResourceBundle messages;
&nbsp;  private final List&lt;RuleMatch&gt; ruleMatches;
&nbsp;  private final List&lt;Span&gt; documentSpans;
&nbsp;
&nbsp;  private MultiThreadedJLanguageTool languageTool;
&nbsp;  private ScheduledExecutorService checkExecutor;
&nbsp;  private MouseListener mouseListener;
&nbsp;  private ActionListener actionListener;
<b class="nc">&nbsp;  private int millisecondDelay = 1500;</b>
&nbsp;  private AtomicInteger check;
<b class="nc">&nbsp;  private boolean popupMenuEnabled = true;</b>
<b class="nc">&nbsp;  private boolean backgroundCheckEnabled = true;</b>
&nbsp;  private Configuration config;
<b class="nc">&nbsp;  private boolean mustDetectLanguage = false;</b>
&nbsp;
&nbsp;  /**
&nbsp;   * LanguageTool support for a JTextComponent
&nbsp;   */
&nbsp;  LanguageToolSupport(JFrame frame, JTextComponent textComponent) {
<b class="nc">&nbsp;    this(frame, textComponent, null);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * LanguageTool support for a JTextComponent
&nbsp;   * @since 2.7
&nbsp;   */
<b class="nc">&nbsp;  LanguageToolSupport(JFrame frame, JTextComponent textComponent, UndoRedoSupport support) {</b>
<b class="nc">&nbsp;    this.frame = frame;</b>
<b class="nc">&nbsp;    this.textComponent = textComponent;</b>
<b class="nc">&nbsp;    this.messages = JLanguageTool.getMessageBundle();</b>
<b class="nc">&nbsp;    ruleMatches = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    documentSpans = new ArrayList&lt;&gt;();    </b>
<b class="nc">&nbsp;    this.undo = support;</b>
<b class="nc">&nbsp;    this.langIdentifier = LanguageIdentifierService.INSTANCE.getDefaultLanguageIdentifier(0, null, null, null);</b>
<b class="nc">&nbsp;    init();</b>
&nbsp;  }
&nbsp;
&nbsp;  void addLanguageToolListener(LanguageToolListener ltListener) {
<b class="nc">&nbsp;    listenerList.add(LanguageToolListener.class, ltListener);</b>
&nbsp;  }
&nbsp;
&nbsp;  void removeLanguageToolListener(LanguageToolListener ltListener) {
<b class="nc">&nbsp;    listenerList.remove(LanguageToolListener.class, ltListener);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void fireEvent(LanguageToolEvent.Type type, Object caller, long elapsedTime) {
<b class="nc">&nbsp;    LanguageToolEvent event = new LanguageToolEvent(this, type, caller, elapsedTime);</b>
<b class="nc">&nbsp;    fireEvent(event);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void fireEvent(LanguageToolEvent.Type type, Object caller) {
<b class="nc">&nbsp;    LanguageToolEvent event = new LanguageToolEvent(this, type, caller);</b>
<b class="nc">&nbsp;    fireEvent(event);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void fireEvent(LanguageToolEvent event) {
&nbsp;    // Guaranteed to return a non-null array
<b class="nc">&nbsp;    Object[] listeners = listenerList.getListenerList();</b>
&nbsp;    // Process the listeners last to first, notifying
&nbsp;    // those that are interested in this event
<b class="nc">&nbsp;    for (int i = listeners.length - 2; i &gt;= 0; i -= 2) {</b>
<b class="nc">&nbsp;      if (listeners[i] == LanguageToolListener.class) {</b>
&nbsp;        // Lazily create the event:
<b class="nc">&nbsp;        ((LanguageToolListener) listeners[i + 1]).languageToolEventOccurred(event);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  JTextComponent getTextComponent() {
<b class="nc">&nbsp;    return textComponent;</b>
&nbsp;  }
&nbsp;
&nbsp;  List&lt;RuleMatch&gt; getMatches() {
<b class="nc">&nbsp;    return this.ruleMatches;</b>
&nbsp;  }
&nbsp;
&nbsp;  void reloadConfig() {
&nbsp;    //FIXME
&nbsp;    //if mother tongue changes then create new JLanguageTool instance
&nbsp;
<b class="nc">&nbsp;    boolean update = false;</b>
&nbsp;  
<b class="nc">&nbsp;    Language language = languageTool.getLanguage();</b>
<b class="nc">&nbsp;    languageTool = new MultiThreadedJLanguageTool(language, config.getMotherTongue(), </b>
<b class="nc">&nbsp;        new UserConfig(config.getConfigurableValues()));</b>
<b class="nc">&nbsp;    config.initStyleCategories(languageTool.getAllRules());</b>
&nbsp;
<b class="nc">&nbsp;    Set&lt;String&gt; disabledRules = config.getDisabledRuleIds();</b>
<b class="nc">&nbsp;    if (disabledRules == null) {</b>
<b class="nc">&nbsp;      disabledRules = Collections.emptySet();</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Set&lt;String&gt; common = new HashSet&lt;&gt;(disabledRules);</b>
<b class="nc">&nbsp;    common.retainAll(languageTool.getDisabledRules());</b>
<b class="nc">&nbsp;    Set&lt;String&gt; toDisable = new HashSet&lt;&gt;(disabledRules);</b>
<b class="nc">&nbsp;    toDisable.removeAll(common);</b>
<b class="nc">&nbsp;    Set&lt;String&gt; toEnable = new HashSet&lt;&gt;(languageTool.getDisabledRules());</b>
<b class="nc">&nbsp;    toEnable.removeAll(common);</b>
&nbsp;    
<b class="nc">&nbsp;    for (String ruleId : toDisable) {</b>
<b class="nc">&nbsp;      languageTool.disableRule(ruleId);</b>
<b class="nc">&nbsp;      update = true;</b>
&nbsp;    }
<b class="nc">&nbsp;    for (String ruleId : toEnable) {</b>
<b class="nc">&nbsp;      languageTool.enableRule(ruleId);</b>
<b class="nc">&nbsp;      update = true;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Set&lt;String&gt; disabledCategoryNames = config.getDisabledCategoryNames();</b>
<b class="nc">&nbsp;    if (disabledCategoryNames == null) {</b>
<b class="nc">&nbsp;      disabledCategoryNames = Collections.emptySet();</b>
&nbsp;    }
<b class="nc">&nbsp;    Set&lt;CategoryId&gt; disabledCategories = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;    Map&lt;CategoryId, Category&gt; langCategories = languageTool.getCategories();</b>
&nbsp;    
<b class="nc">&nbsp;    for (CategoryId id : langCategories.keySet()) {</b>
<b class="nc">&nbsp;      String categoryName = langCategories.get(id).getName();</b>
<b class="nc">&nbsp;      if (disabledCategoryNames.contains(categoryName)) {</b>
<b class="nc">&nbsp;        disabledCategories.add(id);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Set&lt;CategoryId&gt; ltDisabledCategories = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;    for (CategoryId id : langCategories.keySet()) {</b>
<b class="nc">&nbsp;      if (languageTool.isCategoryDisabled(id)) {</b>
<b class="nc">&nbsp;        ltDisabledCategories.add(id);</b>
&nbsp;      }
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    Set&lt;CategoryId&gt; commonCat = new HashSet&lt;&gt;(disabledCategories);</b>
<b class="nc">&nbsp;    commonCat.retainAll(ltDisabledCategories);</b>
&nbsp;
<b class="nc">&nbsp;    Set&lt;CategoryId&gt; toDisableCat = new HashSet&lt;&gt;(disabledCategories);</b>
<b class="nc">&nbsp;    toDisableCat.removeAll(commonCat);</b>
&nbsp;
<b class="nc">&nbsp;    Set&lt;CategoryId&gt; toEnableCat = new HashSet&lt;&gt;(ltDisabledCategories);</b>
<b class="nc">&nbsp;    toEnableCat.removeAll(commonCat);</b>
&nbsp;
<b class="nc">&nbsp;    for(CategoryId id : toDisableCat) {</b>
<b class="nc">&nbsp;      languageTool.disableCategory(id);</b>
&nbsp;    }
<b class="nc">&nbsp;    for(CategoryId id : toEnableCat) {</b>
<b class="nc">&nbsp;      languageTool.enableRuleCategory(id);</b>
&nbsp;    }      
<b class="nc">&nbsp;    if (!toDisableCat.isEmpty() || !toEnableCat.isEmpty()) {</b>
&nbsp;      // ugly hack to trigger reInitSpellCheckIgnoreWords()
<b class="nc">&nbsp;      update = true;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Set&lt;String&gt; enabledRules = config.getEnabledRuleIds();</b>
<b class="nc">&nbsp;    if (enabledRules == null) {</b>
<b class="nc">&nbsp;      enabledRules = Collections.emptySet();</b>
&nbsp;    }
<b class="nc">&nbsp;    for (String ruleName : enabledRules) {</b>
<b class="nc">&nbsp;      languageTool.enableRule(ruleName);</b>
<b class="nc">&nbsp;      update = true;</b>
&nbsp;    }
&nbsp;    
&nbsp;//    languageTool.setConfigValues(config.getConfigValues());
&nbsp;
<b class="nc">&nbsp;    if (update) {</b>
&nbsp;      //FIXME
&nbsp;      //we could skip a full check if the user disabled but didn&#39;t enable rules
<b class="nc">&nbsp;      checkImmediately(null);</b>
<b class="nc">&nbsp;      fireEvent(LanguageToolEvent.Type.RULE_ENABLED, null);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void reloadLanguageTool(Language language) {
&nbsp;    try {
&nbsp;      //FIXME
&nbsp;      //no need to read again the file
<b class="nc">&nbsp;      config = new Configuration(new File(System.getProperty(&quot;user.home&quot;)), CONFIG_FILE, language);</b>
&nbsp;      //config still contains old language, update it
<b class="nc">&nbsp;      this.config.setLanguage(language);</b>
&nbsp;      // Calling shutdown here may cause a RejectedExecutionException:
&nbsp;      //if (languageTool != null) {
&nbsp;      //  languageTool.shutdownWhenDone();
&nbsp;      //}
<b class="nc">&nbsp;      languageTool = new MultiThreadedJLanguageTool(language, config.getMotherTongue(), </b>
<b class="nc">&nbsp;          new UserConfig(config.getConfigurableValues()));</b>
<b class="nc">&nbsp;      config.initStyleCategories(languageTool.getAllRules());</b>
<b class="nc">&nbsp;      languageTool.setCleanOverlappingMatches(false);</b>
<b class="nc">&nbsp;      Tools.configureFromRules(languageTool, config);</b>
<b class="nc">&nbsp;      activateLanguageModelRules(language);</b>
&nbsp;    } catch (Exception e) {
<b class="nc">&nbsp;      throw new RuntimeException(e);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void activateLanguageModelRules(Language language) {
<b class="nc">&nbsp;    if (config.getNgramDirectory() != null) {</b>
<b class="nc">&nbsp;      File ngramLangDir = new File(config.getNgramDirectory(), language.getShortCode());</b>
<b class="nc">&nbsp;      if (ngramLangDir.exists()) {</b>
&nbsp;        try {
<b class="nc">&nbsp;          languageTool.activateLanguageModelRules(config.getNgramDirectory());</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;          JOptionPane.showMessageDialog(null, &quot;Error while loading ngram database.\n&quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;      } else {
&nbsp;        // user might have set ngram directory to use it for e.g. English, but they
&nbsp;        // might not have the data for other languages that supports ngram, so don&#39;t
&nbsp;        // annoy them with an error dialog:
<b class="nc">&nbsp;        System.err.println(&quot;Not loading ngram data, directory does not exist: &quot; + ngramLangDir);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void init() {
&nbsp;    try {
<b class="nc">&nbsp;      config = new Configuration(new File(System.getProperty(&quot;user.home&quot;)), CONFIG_FILE, null);</b>
&nbsp;    } catch (IOException ex) {
<b class="nc">&nbsp;      throw new RuntimeException(&quot;Could not load configuration&quot;, ex);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    Language defaultLanguage = config.getLanguage();</b>
<b class="nc">&nbsp;    if (defaultLanguage == null) {</b>
<b class="nc">&nbsp;        defaultLanguage = Languages.getLanguageForLocale(Locale.getDefault());</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * Warm-up: we have a lot of lazy init in LT, which causes the first check to
&nbsp;     * be very slow (several seconds) for languages with a lot of data and a lot of
&nbsp;     * rules. We just assume that the default language is the language that the user
&nbsp;     * often uses and init the LT object for that now, not just when it&#39;s first used.
&nbsp;     * This makes the first check feel much faster:
&nbsp;     */    
<b class="nc">&nbsp;    reloadLanguageTool(defaultLanguage);</b>
&nbsp;
<b class="nc">&nbsp;    checkExecutor = new ScheduledThreadPoolExecutor(1, new ThreadFactory() {</b>
&nbsp;      @Override
&nbsp;      public Thread newThread(Runnable r) {
<b class="nc">&nbsp;        Thread t = new Thread(r);</b>
<b class="nc">&nbsp;        t.setDaemon(true);</b>
<b class="nc">&nbsp;        t.setPriority(Thread.MIN_PRIORITY);</b>
<b class="nc">&nbsp;        t.setName(t.getName() + &quot;-lt-background&quot;);</b>
<b class="nc">&nbsp;        return t;</b>
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    check = new AtomicInteger(0);</b>
&nbsp;
<b class="nc">&nbsp;    this.textComponent.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;      @Override
&nbsp;      public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        mustDetectLanguage = config.getAutoDetect();</b>
<b class="nc">&nbsp;        recalculateSpans(e.getOffset(), e.getLength(), false);</b>
<b class="nc">&nbsp;        if (backgroundCheckEnabled) {</b>
<b class="nc">&nbsp;          checkDelayed(null);</b>
&nbsp;        }
&nbsp;      }
&nbsp;
&nbsp;      @Override
&nbsp;      public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        mustDetectLanguage = config.getAutoDetect();</b>
<b class="nc">&nbsp;        recalculateSpans(e.getOffset(), e.getLength(), true);</b>
<b class="nc">&nbsp;        if (backgroundCheckEnabled) {</b>
<b class="nc">&nbsp;          checkDelayed(null);</b>
&nbsp;        }
&nbsp;      }
&nbsp;
&nbsp;      @Override
&nbsp;      public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;        mustDetectLanguage = config.getAutoDetect();</b>
<b class="nc">&nbsp;        if (backgroundCheckEnabled) {</b>
<b class="nc">&nbsp;          checkDelayed(null);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
&nbsp;
<b class="nc">&nbsp;    mouseListener = new MouseListener() {</b>
&nbsp;      @Override
&nbsp;      public void mouseClicked(MouseEvent me) {
<b class="nc">&nbsp;      }</b>
&nbsp;
&nbsp;      @Override
&nbsp;      public void mousePressed(MouseEvent me) {
<b class="nc">&nbsp;        if (me.isPopupTrigger()) {</b>
<b class="nc">&nbsp;          showPopup(me);</b>
&nbsp;        }
&nbsp;      }
&nbsp;
&nbsp;      @Override
&nbsp;      public void mouseReleased(MouseEvent me) {
<b class="nc">&nbsp;        if (me.isPopupTrigger()) {</b>
<b class="nc">&nbsp;          showPopup(me);</b>
&nbsp;        }
&nbsp;      }
&nbsp;
&nbsp;      @Override
<b class="nc">&nbsp;      public void mouseEntered(MouseEvent me) {}</b>
&nbsp;      @Override
<b class="nc">&nbsp;      public void mouseExited(MouseEvent me) {}</b>
&nbsp;    };
<b class="nc">&nbsp;    this.textComponent.addMouseListener(mouseListener);</b>
&nbsp;
<b class="nc">&nbsp;    actionListener = e -&gt; _actionPerformed(e);</b>
&nbsp;
<b class="nc">&nbsp;    mustDetectLanguage = config.getAutoDetect();</b>
<b class="nc">&nbsp;    if (!this.textComponent.getText().isEmpty() &amp;&amp; backgroundCheckEnabled) {</b>
<b class="nc">&nbsp;      checkImmediately(null);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  public int getMillisecondDelay() {
<b class="nc">&nbsp;    return millisecondDelay;</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * The text checking delay in milliseconds.
&nbsp;   */
&nbsp;  public void setMillisecondDelay(int millisecondDelay) {
<b class="nc">&nbsp;    this.millisecondDelay = millisecondDelay;</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean isPopupMenuEnabled() {
<b class="nc">&nbsp;    return popupMenuEnabled;</b>
&nbsp;  }
&nbsp;
&nbsp;  public void setPopupMenuEnabled(boolean popupMenuEnabled) {
<b class="nc">&nbsp;    if (this.popupMenuEnabled == popupMenuEnabled) {</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    this.popupMenuEnabled = popupMenuEnabled;</b>
<b class="nc">&nbsp;    if (popupMenuEnabled) {</b>
<b class="nc">&nbsp;      textComponent.addMouseListener(mouseListener);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      textComponent.removeMouseListener(mouseListener);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  public boolean isBackgroundCheckEnabled() {
<b class="nc">&nbsp;    return backgroundCheckEnabled;</b>
&nbsp;  }
&nbsp;
&nbsp;  public void setBackgroundCheckEnabled(boolean backgroundCheckEnabled) {
<b class="nc">&nbsp;    if (this.backgroundCheckEnabled == backgroundCheckEnabled) {</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    this.backgroundCheckEnabled = backgroundCheckEnabled;</b>
<b class="nc">&nbsp;    if (backgroundCheckEnabled) {</b>
<b class="nc">&nbsp;      checkImmediately(null);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  public void setLanguage(Language language) {
<b class="nc">&nbsp;    reloadLanguageTool(language);</b>
<b class="nc">&nbsp;    if (backgroundCheckEnabled) {</b>
<b class="nc">&nbsp;      checkImmediately(null);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  Language getLanguage() {
<b class="nc">&nbsp;      return this.languageTool.getLanguage();</b>
&nbsp;  }
&nbsp;
&nbsp;  public Configuration getConfig() {
<b class="nc">&nbsp;    return config;</b>
&nbsp;  }
&nbsp;
&nbsp;  // called from Main.showOptions() and Main.tagTextAndDisplayResults()
&nbsp;  JLanguageTool getLanguageTool() {
<b class="nc">&nbsp;    return languageTool;</b>
&nbsp;  }
&nbsp;
&nbsp;  void disableRule(String ruleId) {
<b class="nc">&nbsp;    Rule rule = this.getRuleForId(ruleId);</b>
<b class="nc">&nbsp;    if (rule == null) {</b>
&nbsp;      //System.err.println(&quot;No rule with id: &lt;&quot;+ruleId+&quot;&gt;&quot;);
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    if (rule.isDefaultOff()) {</b>
<b class="nc">&nbsp;      config.getEnabledRuleIds().remove(ruleId);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      config.getDisabledRuleIds().add(ruleId);</b>
&nbsp;    }
<b class="nc">&nbsp;    languageTool.disableRule(ruleId);</b>
<b class="nc">&nbsp;    updateHighlights(ruleId);</b>
<b class="nc">&nbsp;    fireEvent(LanguageToolEvent.Type.RULE_DISABLED, null);</b>
&nbsp;  }
&nbsp;
&nbsp;  void enableRule(String ruleId) {
<b class="nc">&nbsp;    Rule rule = this.getRuleForId(ruleId);</b>
<b class="nc">&nbsp;    if (rule == null) {</b>
&nbsp;      //System.err.println(&quot;No rule with id: &lt;&quot;+ruleId+&quot;&gt;&quot;);
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    if (rule.isDefaultOff()) {</b>
<b class="nc">&nbsp;      config.getEnabledRuleIds().add(ruleId);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      config.getDisabledRuleIds().remove(ruleId);</b>
&nbsp;    }
<b class="nc">&nbsp;    languageTool.enableRule(ruleId);</b>
<b class="nc">&nbsp;    fireEvent(LanguageToolEvent.Type.RULE_ENABLED, null);</b>
<b class="nc">&nbsp;    checkImmediately(null);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Nullable
&nbsp;  private Span getSpan(int offset) {
<b class="nc">&nbsp;    for (Span cur : documentSpans) {</b>
<b class="nc">&nbsp;      if (cur.end &gt; cur.start &amp;&amp; cur.start &lt;= offset &amp;&amp; offset &lt; cur.end) {</b>
<b class="nc">&nbsp;        return cur;</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return null;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void showPopup(MouseEvent event) {
<b class="nc">&nbsp;    if (documentSpans.isEmpty() &amp;&amp; languageTool.getDisabledRules().isEmpty()) {</b>
&nbsp;      //No errors and no disabled Rules
&nbsp;      return;
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    int offset = this.textComponent.viewToModel(event.getPoint());</b>
<b class="nc">&nbsp;    Span span = getSpan(offset);</b>
<b class="nc">&nbsp;    JPopupMenu popup = new JPopupMenu(&quot;Grammar Menu&quot;);</b>
<b class="nc">&nbsp;    if (span != null) {</b>
<b class="nc">&nbsp;      JLabel msgItem = new JLabel(&quot;&lt;html&gt;&quot;</b>
<b class="nc">&nbsp;              + span.msg.replace(&quot;&lt;suggestion&gt;&quot;, &quot;&lt;b&gt;&quot;).replace(&quot;&lt;/suggestion&gt;&quot;, &quot;&lt;/b&gt;&quot;)</b>
&nbsp;              + &quot;&lt;/html&gt;&quot;);
<b class="nc">&nbsp;      msgItem.setToolTipText(</b>
<b class="nc">&nbsp;              span.desc.replace(&quot;&lt;suggestion&gt;&quot;, &quot;&quot;).replace(&quot;&lt;/suggestion&gt;&quot;, &quot;&quot;));</b>
<b class="nc">&nbsp;      msgItem.setBorder(new JMenuItem().getBorder());</b>
<b class="nc">&nbsp;      popup.add(msgItem);</b>
&nbsp;
<b class="nc">&nbsp;      popup.add(new JSeparator());</b>
&nbsp;
<b class="nc">&nbsp;      for (String r : span.replacement) {</b>
<b class="nc">&nbsp;        ReplaceMenuItem item = new ReplaceMenuItem(r, span);</b>
<b class="nc">&nbsp;        popup.add(item);</b>
<b class="nc">&nbsp;        item.addActionListener(actionListener);</b>
&nbsp;      }
&nbsp;
<b class="nc">&nbsp;      popup.add(new JSeparator());</b>
&nbsp;
<b class="nc">&nbsp;      JMenuItem moreItem = new JMenuItem(messages.getString(&quot;guiMore&quot;));</b>
<b class="nc">&nbsp;      moreItem.addActionListener(e -&gt; showDialog(textComponent, span.msg, span.desc, span.rule, span.url));</b>
<b class="nc">&nbsp;      popup.add(moreItem);</b>
&nbsp;
<b class="nc">&nbsp;      JMenuItem ignoreItem = new JMenuItem(messages.getString(&quot;guiTurnOffRule&quot;));</b>
<b class="nc">&nbsp;      ignoreItem.addActionListener(e -&gt; disableRule(span.rule.getId()));</b>
<b class="nc">&nbsp;      popup.add(ignoreItem);</b>
<b class="nc">&nbsp;      popup.applyComponentOrientation(</b>
<b class="nc">&nbsp;        ComponentOrientation.getOrientation(Locale.getDefault()));</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    List&lt;Rule&gt; disabledRules = getDisabledRules();</b>
<b class="nc">&nbsp;    if (!disabledRules.isEmpty()) {</b>
<b class="nc">&nbsp;      JMenu activateRuleMenu = new JMenu(messages.getString(&quot;guiActivateRule&quot;));</b>
<b class="nc">&nbsp;      addDisabledRulesToMenu(disabledRules, activateRuleMenu);</b>
<b class="nc">&nbsp;      popup.add(activateRuleMenu);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (span != null) {</b>
<b class="nc">&nbsp;      textComponent.setCaretPosition(span.start);</b>
<b class="nc">&nbsp;      textComponent.moveCaretPosition(span.end);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    popup.addPopupMenuListener(new PopupMenuListener() {</b>
&nbsp;      @Override
&nbsp;      public void popupMenuWillBecomeVisible(PopupMenuEvent e) {
<b class="nc">&nbsp;      }</b>
&nbsp;
&nbsp;      @Override
&nbsp;      public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {
<b class="nc">&nbsp;      }</b>
&nbsp;
&nbsp;      @Override
&nbsp;      public void popupMenuCanceled(PopupMenuEvent e) {
<b class="nc">&nbsp;        if (span != null) {</b>
<b class="nc">&nbsp;          textComponent.setCaretPosition(span.start);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    });
<b class="nc">&nbsp;    popup.show(textComponent, event.getPoint().x, event.getPoint().y);</b>
&nbsp;
&nbsp;  }
&nbsp;
&nbsp;  private List&lt;Rule&gt; getDisabledRules() {
<b class="nc">&nbsp;    List&lt;Rule&gt; disabledRules = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (String ruleId : languageTool.getDisabledRules()) {</b>
<b class="nc">&nbsp;      Rule rule = getRuleForId(ruleId);</b>
<b class="nc">&nbsp;      if (rule == null || rule.isDefaultOff()) {</b>
&nbsp;        continue;
&nbsp;      }
<b class="nc">&nbsp;      disabledRules.add(rule);</b>
&nbsp;    }
<b class="nc">&nbsp;    Collections.sort(disabledRules, (r1, r2) -&gt; r1.getDescription().compareTo(r2.getDescription()));</b>
<b class="nc">&nbsp;    return disabledRules;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void addDisabledRulesToMenu(List&lt;Rule&gt; disabledRules, JMenu menu) {
<b class="nc">&nbsp;    if (disabledRules.size() &lt;= MAX_RULES_NO_CATEGORY_MENU) {</b>
<b class="nc">&nbsp;      createRulesMenu(menu, disabledRules);</b>
&nbsp;      return;
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    TreeMap&lt;String, ArrayList&lt;Rule&gt;&gt; categories = new TreeMap&lt;&gt;();</b>
<b class="nc">&nbsp;    for (Rule rule : disabledRules) {</b>
<b class="nc">&nbsp;      if (!categories.containsKey(rule.getCategory().getName())) {</b>
<b class="nc">&nbsp;        categories.put(rule.getCategory().getName(), new ArrayList&lt;&gt;());</b>
&nbsp;      }
<b class="nc">&nbsp;      categories.get(rule.getCategory().getName()).add(rule);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    JMenu parent = menu;</b>
<b class="nc">&nbsp;    int count = 0;</b>
<b class="nc">&nbsp;    for (String category : categories.keySet()) {</b>
<b class="nc">&nbsp;      count++;</b>
<b class="nc">&nbsp;      JMenu submenu = new JMenu(category);</b>
<b class="nc">&nbsp;      parent.add(submenu);</b>
<b class="nc">&nbsp;      createRulesMenu(submenu, categories.get(category));</b>
&nbsp;
<b class="nc">&nbsp;      if (categories.keySet().size() &lt;= MAX_CATEGORIES_PER_MENU) {</b>
&nbsp;        continue;
&nbsp;      }
&nbsp;
&nbsp;      //if menu contains MAX_CATEGORIES_PER_MENU-1, add a `more` menu
&nbsp;      //but only if the remain entries are more than one
<b class="nc">&nbsp;      if ((count % (MAX_CATEGORIES_PER_MENU - 1) == 0)</b>
<b class="nc">&nbsp;              &amp;&amp; (categories.keySet().size() - count &gt; 1)) {</b>
<b class="nc">&nbsp;        JMenu more = new JMenu(messages.getString(&quot;guiActivateRuleMoreCategories&quot;));</b>
<b class="nc">&nbsp;        parent.add(more);</b>
<b class="nc">&nbsp;        parent = more;</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void createRulesMenu(JMenu parent, List&lt;Rule&gt; rules) {
<b class="nc">&nbsp;    JMenu menu = parent;</b>
<b class="nc">&nbsp;    int count = 0;</b>
&nbsp;
<b class="nc">&nbsp;    for (Rule rule : rules) {</b>
<b class="nc">&nbsp;      count++;</b>
<b class="nc">&nbsp;      String id = rule.getId();</b>
<b class="nc">&nbsp;      JMenuItem ruleItem = new JMenuItem(rule.getDescription());</b>
<b class="nc">&nbsp;      ruleItem.addActionListener(e -&gt; enableRule(id));</b>
<b class="nc">&nbsp;      menu.add(ruleItem);</b>
&nbsp;
<b class="nc">&nbsp;      if (rules.size() &lt;= MAX_RULES_PER_MENU) {</b>
&nbsp;        continue;
&nbsp;      }
&nbsp;
&nbsp;      //if menu contains MAX_RULES_PER_MENU-1, add a `more` menu
&nbsp;      //but only if the remain entries are more than one
<b class="nc">&nbsp;      if ((count % (MAX_RULES_PER_MENU - 1) == 0)</b>
<b class="nc">&nbsp;              &amp;&amp; (rules.size() - count &gt; 1)) {</b>
<b class="nc">&nbsp;        JMenu more = new JMenu(messages.getString(&quot;guiActivateRuleMoreRules&quot;));</b>
<b class="nc">&nbsp;        menu.add(more);</b>
<b class="nc">&nbsp;        menu = more;</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  @Nullable
&nbsp;  Rule getRuleForId(String ruleId) {
<b class="nc">&nbsp;    List&lt;Rule&gt; allRules = languageTool.getAllRules();</b>
<b class="nc">&nbsp;    for (Rule rule : allRules) {</b>
<b class="nc">&nbsp;      if (rule.getId().equals(ruleId)) {</b>
<b class="nc">&nbsp;        return rule;</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return null;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void _actionPerformed(ActionEvent e) {
<b class="nc">&nbsp;    ReplaceMenuItem src = (ReplaceMenuItem) e.getSource();</b>
&nbsp;
<b class="nc">&nbsp;    this.documentSpans.remove(src.span);</b>
<b class="nc">&nbsp;    applySuggestion(e.getActionCommand(), src.span.start, src.span.end);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void applySuggestion(String str, int start, int end) {
<b class="nc">&nbsp;    if (end &lt; start) {</b>
<b class="nc">&nbsp;      throw new IllegalArgumentException(&quot;end before start: &quot; + end + &quot; &lt; &quot; + start);</b>
&nbsp;    }
<b class="nc">&nbsp;    Document doc = this.textComponent.getDocument();</b>
<b class="nc">&nbsp;    if (doc != null) {</b>
&nbsp;      try {
<b class="nc">&nbsp;        if (this.undo != null) {</b>
<b class="nc">&nbsp;          this.undo.startCompoundEdit();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (doc instanceof AbstractDocument) {</b>
<b class="nc">&nbsp;          ((AbstractDocument) doc).replace(start, end - start, str, null);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          doc.remove(start, end - start);</b>
<b class="nc">&nbsp;          doc.insertString(start, str, null);</b>
&nbsp;        }
&nbsp;      } catch (BadLocationException e) {
<b class="nc">&nbsp;        throw new IllegalArgumentException(e);</b>
&nbsp;      } finally {
<b class="nc">&nbsp;        if (this.undo != null) {</b>
<b class="nc">&nbsp;          this.undo.endCompoundEdit();</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  public void checkDelayed() {
<b class="nc">&nbsp;    checkDelayed(null);</b>
&nbsp;  }
&nbsp;
&nbsp;  public void checkDelayed(Object caller) {
<b class="nc">&nbsp;    check.getAndIncrement();</b>
<b class="nc">&nbsp;    checkExecutor.schedule(new RunnableImpl(caller), millisecondDelay, TimeUnit.MILLISECONDS);</b>
&nbsp;  }
&nbsp;
&nbsp;  public void checkImmediately() {
<b class="nc">&nbsp;    checkImmediately(null);</b>
&nbsp;  }
&nbsp;
&nbsp;  public void checkImmediately(Object caller) {
<b class="nc">&nbsp;    check.getAndIncrement();</b>
<b class="nc">&nbsp;    checkExecutor.schedule(new RunnableImpl(caller), 0, TimeUnit.MILLISECONDS);</b>
&nbsp;  }
&nbsp;
&nbsp;  Language autoDetectLanguage(String text) {
<b class="nc">&nbsp;    Language lang = langIdentifier.detectLanguage(text);</b>
<b class="nc">&nbsp;    if (lang == null) {</b>
<b class="nc">&nbsp;      lang = Languages.getLanguageForLocale(Locale.getDefault());</b>
&nbsp;    }
<b class="nc">&nbsp;    if (lang.hasVariant()) {</b>
&nbsp;      // UI only shows variants like &quot;English (American)&quot;, not just &quot;English&quot;, so use that:
<b class="nc">&nbsp;      lang = lang.getDefaultLanguageVariant();</b>
&nbsp;    }
<b class="nc">&nbsp;    return lang;</b>
&nbsp;  }
&nbsp;
&nbsp;  private synchronized List&lt;RuleMatch&gt; checkText(Object caller) throws IOException {
<b class="nc">&nbsp;    if (this.mustDetectLanguage) {</b>
<b class="nc">&nbsp;      mustDetectLanguage = false;</b>
<b class="nc">&nbsp;      if (!this.textComponent.getText().isEmpty()) {</b>
<b class="nc">&nbsp;        Language detectedLanguage = autoDetectLanguage(this.textComponent.getText());</b>
<b class="nc">&nbsp;        if (!detectedLanguage.equals(this.languageTool.getLanguage())) {</b>
<b class="nc">&nbsp;          reloadLanguageTool(detectedLanguage);</b>
<b class="nc">&nbsp;          if (SwingUtilities.isEventDispatchThread()) {</b>
<b class="nc">&nbsp;            fireEvent(LanguageToolEvent.Type.LANGUAGE_CHANGED, caller);</b>
&nbsp;          } else {
&nbsp;            try {
<b class="nc">&nbsp;              SwingUtilities.invokeAndWait(() -&gt; fireEvent(LanguageToolEvent.Type.LANGUAGE_CHANGED, caller));</b>
&nbsp;            } catch (InterruptedException ex) {
&nbsp;              //ignore
&nbsp;            } catch (InvocationTargetException ex) {
<b class="nc">&nbsp;              throw new RuntimeException(ex);</b>
&nbsp;            }
&nbsp;          }
&nbsp;        }
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    if (SwingUtilities.isEventDispatchThread()) {</b>
<b class="nc">&nbsp;      fireEvent(LanguageToolEvent.Type.CHECKING_STARTED, caller);</b>
&nbsp;    } else {
&nbsp;      try {
<b class="nc">&nbsp;        SwingUtilities.invokeAndWait(() -&gt; fireEvent(LanguageToolEvent.Type.CHECKING_STARTED, caller));</b>
&nbsp;      } catch (InterruptedException ex) {
&nbsp;        //ignore
&nbsp;      } catch (InvocationTargetException ex) {
<b class="nc">&nbsp;        throw new RuntimeException(ex);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    long startTime = System.currentTimeMillis();</b>
<b class="nc">&nbsp;    List&lt;RuleMatch&gt; matches = this.languageTool.check(this.textComponent.getText());</b>
<b class="nc">&nbsp;    long elapsedTime = System.currentTimeMillis() - startTime;</b>
&nbsp;
<b class="nc">&nbsp;    int v = check.get();</b>
<b class="nc">&nbsp;    if (v == 0) {</b>
<b class="nc">&nbsp;      if (!SwingUtilities.isEventDispatchThread()) {</b>
<b class="nc">&nbsp;        SwingUtilities.invokeLater(() -&gt; {</b>
<b class="nc">&nbsp;          updateHighlights(matches);</b>
<b class="nc">&nbsp;          fireEvent(LanguageToolEvent.Type.CHECKING_FINISHED, caller, elapsedTime);</b>
&nbsp;        });
&nbsp;      } else {
<b class="nc">&nbsp;        updateHighlights(matches);</b>
<b class="nc">&nbsp;        fireEvent(LanguageToolEvent.Type.CHECKING_FINISHED, caller, elapsedTime);</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return matches;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void removeHighlights() {
<b class="nc">&nbsp;    for (Highlighter.Highlight hl : textComponent.getHighlighter().getHighlights()) {</b>
<b class="nc">&nbsp;      if (hl.getPainter() instanceof HighlightPainter) {</b>
<b class="nc">&nbsp;        textComponent.getHighlighter().removeHighlight(hl);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void recalculateSpans(int offset, int length, boolean remove) {
<b class="nc">&nbsp;    if (length == 0) {</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    for (Span span : this.documentSpans) {</b>
<b class="nc">&nbsp;      if (offset &gt;= span.end) {</b>
&nbsp;        continue;
&nbsp;      }
<b class="nc">&nbsp;      if (!remove) {</b>
<b class="nc">&nbsp;        if (offset &lt;= span.start) {</b>
<b class="nc">&nbsp;          span.start += length;</b>
&nbsp;        }
<b class="nc">&nbsp;        span.end += length;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        if (offset + length &lt;= span.end) {</b>
<b class="nc">&nbsp;          if (offset &gt; span.start) {</b>
&nbsp;            //
<b class="nc">&nbsp;          } else if (offset + length &lt;= span.start) {</b>
<b class="nc">&nbsp;            span.start -= length;</b>
&nbsp;          } else {
<b class="nc">&nbsp;            span.start = offset;</b>
&nbsp;          }
<b class="nc">&nbsp;          span.end -= length;</b>
&nbsp;        } else {
<b class="nc">&nbsp;          span.end -= Math.min(length, span.end - offset);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    updateHighlights();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void updateHighlights(String disabledRule) {
<b class="nc">&nbsp;    List&lt;Span&gt; spans = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;RuleMatch&gt; matches = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (RuleMatch match : ruleMatches) {</b>
<b class="nc">&nbsp;      if (match.getRule().getId().equals(disabledRule)) {</b>
&nbsp;        continue;
&nbsp;      }
<b class="nc">&nbsp;      matches.add(match);</b>
<b class="nc">&nbsp;      spans.add(new Span(match));</b>
&nbsp;    }
<b class="nc">&nbsp;    prepareUpdateHighlights(matches, spans);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void updateHighlights(List&lt;RuleMatch&gt; matches) {
<b class="nc">&nbsp;    List&lt;Span&gt; spans = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (RuleMatch match : matches) {</b>
<b class="nc">&nbsp;      spans.add(new Span(match));</b>
&nbsp;    }
<b class="nc">&nbsp;    prepareUpdateHighlights(matches, spans);</b>
&nbsp;  }
&nbsp;
&nbsp;  private void prepareUpdateHighlights(List&lt;RuleMatch&gt; matches, List&lt;Span&gt; spans) {
<b class="nc">&nbsp;    ruleMatches.clear();</b>
<b class="nc">&nbsp;    documentSpans.clear();</b>
<b class="nc">&nbsp;    ruleMatches.addAll(matches);</b>
<b class="nc">&nbsp;    documentSpans.addAll(spans);</b>
<b class="nc">&nbsp;    updateHighlights();</b>
&nbsp;  }
&nbsp;
&nbsp;  private void updateHighlights() {
<b class="nc">&nbsp;    removeHighlights();</b>
&nbsp;
<b class="nc">&nbsp;    Highlighter h = textComponent.getHighlighter();</b>
&nbsp;
<b class="nc">&nbsp;    for (Span span : documentSpans) {</b>
<b class="nc">&nbsp;      if (span.start == span.end) {</b>
&nbsp;        continue;
&nbsp;      }
&nbsp;      try {
<b class="nc">&nbsp;        if (span.start &lt; span.end) { //to avoid the BadLocationException</b>
<b class="nc">&nbsp;          ITSIssueType issueType = span.rule.getLocQualityIssueType();</b>
<b class="nc">&nbsp;          Color ulColor = config.getUnderlineColor(span.rule.getCategory().getName(), span.rule.getId());</b>
<b class="nc">&nbsp;          Color colorForIssueType = getConfig().getErrorColors().get(issueType);</b>
<b class="nc">&nbsp;          Color underlineColor = ITSIssueType.Misspelling == span.rule.getLocQualityIssueType() ? Color.red : ulColor;</b>
<b class="nc">&nbsp;          HighlightPainter painter = new HighlightPainter(colorForIssueType, underlineColor);</b>
<b class="nc">&nbsp;          h.addHighlight(span.start, span.end, painter);</b>
&nbsp;        }
&nbsp;      } catch (BadLocationException ex) {
<b class="nc">&nbsp;        ex.printStackTrace();</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private void showDialog(Component parent, String title, String message, Rule rule, URL url) {
<b class="nc">&nbsp;    Tools.showRuleInfoDialog(parent, title, message, rule, url, messages, languageTool.getLanguage().getShortCodeWithCountryAndVariant());</b>
&nbsp;  }
&nbsp;
&nbsp;  private static class ReplaceMenuItem extends JMenuItem {
&nbsp;
&nbsp;    private final Span span;
&nbsp;
&nbsp;    private ReplaceMenuItem(String name, Span span) {
<b class="nc">&nbsp;      super(name);</b>
<b class="nc">&nbsp;      this.span = span;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static class Span {
&nbsp;
&nbsp;    private static final int MAX_SUGGESTIONS = 5;
&nbsp;    
&nbsp;    private int start;
&nbsp;    private int end;
&nbsp;    private final String msg;
&nbsp;    private final String desc;
&nbsp;    private final List&lt;String&gt; replacement;
&nbsp;    private final Rule rule;
&nbsp;    private final URL url;
&nbsp;
<b class="nc">&nbsp;    private Span(RuleMatch match) {</b>
<b class="nc">&nbsp;      start = match.getFromPos();</b>
<b class="nc">&nbsp;      end = match.getToPos();</b>
<b class="nc">&nbsp;      String tmp = match.getShortMessage();</b>
<b class="nc">&nbsp;      if (StringUtils.isEmpty(tmp)) {</b>
<b class="nc">&nbsp;        tmp = match.getMessage();</b>
&nbsp;      }
<b class="nc">&nbsp;      msg = Tools.shortenComment(tmp);</b>
<b class="nc">&nbsp;      desc = match.getMessage();</b>
<b class="nc">&nbsp;      replacement = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;      List&lt;String&gt; repl = match.getSuggestedReplacements();</b>
<b class="nc">&nbsp;      replacement.addAll(repl.subList(0, Math.min(MAX_SUGGESTIONS, repl.size())));</b>
<b class="nc">&nbsp;      rule = match.getRule();</b>
<b class="nc">&nbsp;      url = match.getUrl() != null ? match.getUrl() : rule.getUrl();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private class RunnableImpl implements Runnable {
&nbsp;
&nbsp;    private final Object caller;
&nbsp;
<b class="nc">&nbsp;    private RunnableImpl(Object caller) {</b>
<b class="nc">&nbsp;      this.caller = caller;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void run() {
<b class="nc">&nbsp;      int v = check.decrementAndGet();</b>
<b class="nc">&nbsp;      if (v != 0) {</b>
&nbsp;        return;
&nbsp;      }
&nbsp;      try {
<b class="nc">&nbsp;        checkText(caller);</b>
&nbsp;      } catch (Exception ex) {
<b class="nc">&nbsp;        Tools.showError(ex);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-02-17 23:58</div>
</div>
</body>
</html>
