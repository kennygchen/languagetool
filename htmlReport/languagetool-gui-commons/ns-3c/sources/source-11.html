


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PatternRuleHandler</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.languagetool.rules.patterns</a>
</div>

<h1>Coverage Summary for Class: PatternRuleHandler (org.languagetool.rules.patterns)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PatternRuleHandler</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/425)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/589)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/* LanguageTool, a natural language style checker
&nbsp; * Copyright (C) 2012 Daniel Naber (http://www.danielnaber.de)
&nbsp; *
&nbsp; * This library is free software; you can redistribute it and/or
&nbsp; * modify it under the terms of the GNU Lesser General Public
&nbsp; * License as published by the Free Software Foundation; either
&nbsp; * version 2.1 of the License, or (at your option) any later version.
&nbsp; *
&nbsp; * This library is distributed in the hope that it will be useful,
&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
&nbsp; * Lesser General Public License for more details.
&nbsp; *
&nbsp; * You should have received a copy of the GNU Lesser General Public
&nbsp; * License along with this library; if not, write to the Free Software
&nbsp; * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301
&nbsp; * USA
&nbsp; */
&nbsp;package org.languagetool.rules.patterns;
&nbsp;
&nbsp;import org.apache.commons.lang3.ObjectUtils;
&nbsp;import org.languagetool.Language;
&nbsp;import org.languagetool.Languages;
&nbsp;import org.languagetool.ResourceBundleTools;
&nbsp;import org.languagetool.RuleEntityResolver;
&nbsp;import org.languagetool.rules.*;
&nbsp;import org.languagetool.tagging.disambiguation.rules.DisambiguationPatternRule;
&nbsp;import org.languagetool.tools.StringInterner;
&nbsp;import org.xml.sax.Attributes;
&nbsp;import org.xml.sax.InputSource;
&nbsp;import org.xml.sax.SAXException;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.net.MalformedURLException;
&nbsp;import java.net.URL;
&nbsp;import java.util.*;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;public class PatternRuleHandler extends XMLRuleHandler {
&nbsp;
&nbsp;  @Override
&nbsp;  public InputSource resolveEntity(String publicId, String systemId) throws IOException, SAXException {
<b class="nc">&nbsp;    return new RuleEntityResolver().resolveEntity(publicId, systemId);</b>
&nbsp;  }
&nbsp;
&nbsp;  public static final String TYPE = &quot;type&quot;;
&nbsp;
&nbsp;  static final String MARKER_TAG = &quot;&lt;marker&gt;&quot;;
&nbsp;  static final String RAW_TAG = &quot;raw_pos&quot;;
&nbsp;  static final String PLEASE_SPELL_ME = &quot;&lt;pleasespellme/&gt;&quot;;
&nbsp;
&nbsp;  private static final String EXTERNAL = &quot;external&quot;;
&nbsp;
&nbsp;  protected final String sourceFile;
&nbsp;
&nbsp;  protected Category category;
&nbsp;  protected String categoryIssueType;
&nbsp;  protected String ruleGroupIssueType;
&nbsp;  protected String ruleIssueType;
&nbsp;  protected String name;
&nbsp;  protected String filterClassName;
&nbsp;  protected String filterArgs;
&nbsp;
<b class="nc">&nbsp;  private final List&lt;DisambiguationPatternRule&gt; rulegroupAntiPatterns = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;  private final List&lt;DisambiguationPatternRule&gt; ruleAntiPatterns = new ArrayList&lt;&gt;();</b>
&nbsp;  private int subId;
&nbsp;  private boolean interpretPosTagsPreDisambiguation;
&nbsp;
&nbsp;  private boolean defaultOff;
&nbsp;  private boolean defaultTempOff;
&nbsp;  private boolean ruleGroupDefaultOff;
&nbsp;  private boolean ruleGroupDefaultTempOff;
&nbsp;
&nbsp;  private String ruleGroupDescription;
<b class="nc">&nbsp;  private int startPos = -1;</b>
<b class="nc">&nbsp;  private int endPos = -1;</b>
&nbsp;  private int tokenCountForMarker;
&nbsp;
&nbsp;  private int antiPatternCounter;
&nbsp;
&nbsp;  private boolean inRule;
&nbsp;
<b class="nc">&nbsp;  private boolean relaxedMode = false;</b>
&nbsp;  private boolean inAntiPattern;
&nbsp;  
&nbsp;  private boolean isRuleSuppressMisspelled;
&nbsp;  private boolean isSuggestionSuppressMisspelled;
&nbsp;
<b class="nc">&nbsp;  private int minPrevMatches = 0;</b>
<b class="nc">&nbsp;  private int ruleGroupMinPrevMatches = 0;</b>
<b class="nc">&nbsp;  private int distanceTokens = 0;</b>
<b class="nc">&nbsp;  private int ruleGroupDistanceTokens = 0;</b>
&nbsp;  
&nbsp;  private String idPrefix;
&nbsp;
<b class="nc">&nbsp;  public PatternRuleHandler() {</b>
<b class="nc">&nbsp;    this.sourceFile = null;</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  public PatternRuleHandler(String sourceFile) {</b>
<b class="nc">&nbsp;    this.sourceFile = sourceFile;</b>
&nbsp;  }
<b class="nc">&nbsp;  public PatternRuleHandler(String filename, Language lang) {</b>
<b class="nc">&nbsp;    this.sourceFile = filename;</b>
<b class="nc">&nbsp;    if (lang != null) {</b>
<b class="nc">&nbsp;      this.language = Languages.getLanguageForShortCode(lang.getShortCodeWithCountryAndVariant());  </b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * If set to true, don&#39;t throw an exception if id or name is not set.
&nbsp;   * Used for online rule editor.
&nbsp;   * @since 2.1
&nbsp;   */
&nbsp;  void setRelaxedMode(boolean relaxedMode) {
<b class="nc">&nbsp;    this.relaxedMode = relaxedMode;</b>
&nbsp;  }
&nbsp;
&nbsp;  // ===========================================================
&nbsp;  // SAX DocumentHandler methods
&nbsp;  // ===========================================================
&nbsp;
&nbsp;  @Override
&nbsp;  public void startElement(String namespaceURI, String lName,
&nbsp;                           String qName, Attributes attrs) throws SAXException {
<b class="nc">&nbsp;    switch (qName) {</b>
&nbsp;      case &quot;category&quot;:
<b class="nc">&nbsp;        String catName = attrs.getValue(NAME);</b>
<b class="nc">&nbsp;        premiumCategoryAttribute = attrs.getValue(PREMIUM); //check if all rules should be premium by default in this category</b>
<b class="nc">&nbsp;        String catId = attrs.getValue(ID);</b>
<b class="nc">&nbsp;        Category.Location location = YES.equals(attrs.getValue(EXTERNAL)) ?</b>
<b class="nc">&nbsp;          Category.Location.EXTERNAL : Category.Location.INTERNAL;</b>
<b class="nc">&nbsp;        boolean onByDefault = !OFF.equals(attrs.getValue(DEFAULT));</b>
<b class="nc">&nbsp;        String tabName = attrs.getValue(TABNAME);</b>
<b class="nc">&nbsp;        category = new Category(new CategoryId(catId), catName, location, onByDefault, tabName);</b>
<b class="nc">&nbsp;        if (attrs.getValue(TYPE) != null) {</b>
<b class="nc">&nbsp;          categoryIssueType = attrs.getValue(TYPE);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (attrs.getValue(&quot;tags&quot;) != null) {</b>
<b class="nc">&nbsp;          categoryTags.addAll(Arrays.asList(attrs.getValue(&quot;tags&quot;).split(&quot; &quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (attrs.getValue(&quot;tone_tags&quot;) != null) {</b>
<b class="nc">&nbsp;          categoryToneTags.addAll(Arrays.asList(attrs.getValue(&quot;tone_tags&quot;).split(&quot; &quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        isGoalSpecificCategoryAttribute = attrs.getValue(GOAL_SPECIFIC);</b>
<b class="nc">&nbsp;        String prioCategoryAttributeValue = attrs.getValue(PRIO);</b>
<b class="nc">&nbsp;        if (prioCategoryAttributeValue != null) {</b>
<b class="nc">&nbsp;          prioCategoryAttribute = Integer.parseInt(prioCategoryAttributeValue);</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case &quot;rules&quot;:
<b class="nc">&nbsp;        String languageStr = attrs.getValue(&quot;lang&quot;);</b>
<b class="nc">&nbsp;        premiumFileAttribute = attrs.getValue(PREMIUM); //check if all rules should be premium by default in this file</b>
<b class="nc">&nbsp;        idPrefix = attrs.getValue(&quot;idprefix&quot;);</b>
<b class="nc">&nbsp;        if (language == null) {</b>
<b class="nc">&nbsp;          language = Languages.getLanguageForShortCode(languageStr);</b>
&nbsp;        }
<b class="nc">&nbsp;        messages = ResourceBundleTools.getMessageBundle(language);</b>
&nbsp;        break;
&nbsp;      case &quot;regexp&quot;:
<b class="nc">&nbsp;        inRegex = true;</b>
<b class="nc">&nbsp;        regexMode = &quot;exact&quot;.equals(attrs.getValue(&quot;type&quot;)) ? RegexpMode.EXACT : RegexpMode.SMART;</b>
<b class="nc">&nbsp;        regexCaseSensitive = attrs.getValue(CASE_SENSITIVE) != null &amp;&amp; YES.equals(attrs.getValue(CASE_SENSITIVE));</b>
<b class="nc">&nbsp;        regexpMark = attrs.getValue(MARK) != null ? Integer.parseInt(attrs.getValue(MARK)) : 0;</b>
&nbsp;        break;
&nbsp;      case RULE:
<b class="nc">&nbsp;        xmlLineNumber = pLocator.getLineNumber();</b>
<b class="nc">&nbsp;        regex = new StringBuilder();</b>
<b class="nc">&nbsp;        inRule = true;</b>
<b class="nc">&nbsp;        shortMessage = new StringBuilder();</b>
<b class="nc">&nbsp;        message = new StringBuilder();</b>
<b class="nc">&nbsp;        suggestionsOutMsg = new StringBuilder();</b>
<b class="nc">&nbsp;        url = new StringBuilder();</b>
<b class="nc">&nbsp;        id = attrs.getValue(ID);</b>
<b class="nc">&nbsp;        name = attrs.getValue(NAME);</b>
<b class="nc">&nbsp;        String minPrevMatchesStr = attrs.getValue(MINPREVMATCHES);</b>
<b class="nc">&nbsp;        if (minPrevMatchesStr != null) {</b>
<b class="nc">&nbsp;          if (inRuleGroup &amp;&amp; ruleGroupMinPrevMatches &gt; 0) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Rule group &quot; + ruleGroupId + &quot; has &quot; + MINPREVMATCHES + &quot;=&quot; + ruleGroupMinPrevMatches</b>
&nbsp;                + &quot;, thus rule &quot; + id + &quot; cannot specify &quot; + MINPREVMATCHES);
&nbsp;          }
<b class="nc">&nbsp;          minPrevMatches = Integer.parseInt(minPrevMatchesStr);  </b>
&nbsp;        } else {
<b class="nc">&nbsp;          minPrevMatches = ruleGroupMinPrevMatches;</b>
&nbsp;        }
<b class="nc">&nbsp;        String distanceTokensStr = attrs.getValue(DISTANCETOKENS);</b>
<b class="nc">&nbsp;        if (distanceTokensStr != null) {</b>
<b class="nc">&nbsp;          if (inRuleGroup &amp;&amp; ruleGroupDistanceTokens &gt; 0) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Rule group &quot; + ruleGroupId + &quot; has &quot; + DISTANCETOKENS + &quot;=&quot; + ruleGroupDistanceTokens</b>
&nbsp;                + &quot;, thus rule &quot; + id + &quot; cannot specify &quot; + DISTANCETOKENS);
&nbsp;          }
<b class="nc">&nbsp;          distanceTokens = Integer.parseInt(distanceTokensStr);  </b>
&nbsp;        } else {
<b class="nc">&nbsp;          distanceTokens = ruleGroupDistanceTokens;</b>
&nbsp;        }
<b class="nc">&nbsp;        String premiumRule = attrs.getValue(PREMIUM);</b>
&nbsp;        //check if this rule is premium
<b class="nc">&nbsp;        if (premiumRule != null) {</b>
<b class="nc">&nbsp;          if (YES.equals(premiumRule)) {</b>
<b class="nc">&nbsp;            isPremiumRule = true;</b>
<b class="nc">&nbsp;          } else if (NO.equals(premiumRule)) {</b>
<b class="nc">&nbsp;            isPremiumRule = false;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (premiumRuleGroupAttribute != null){</b>
<b class="nc">&nbsp;          if (YES.equals(premiumRuleGroupAttribute)) {</b>
<b class="nc">&nbsp;            isPremiumRule = true;</b>
<b class="nc">&nbsp;          } else if (NO.equals(premiumRuleGroupAttribute)) {</b>
<b class="nc">&nbsp;            isPremiumRule = false;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (premiumCategoryAttribute != null) {</b>
<b class="nc">&nbsp;          if (YES.equals(premiumCategoryAttribute)) {</b>
<b class="nc">&nbsp;            isPremiumRule = true;</b>
<b class="nc">&nbsp;          } else if (NO.equals(premiumCategoryAttribute)) {</b>
<b class="nc">&nbsp;            isPremiumRule = false;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (premiumFileAttribute != null){</b>
<b class="nc">&nbsp;          if (YES.equals(premiumFileAttribute)) {</b>
<b class="nc">&nbsp;            isPremiumRule = true;</b>
<b class="nc">&nbsp;          } else if (NO.equals(premiumFileAttribute)) {</b>
<b class="nc">&nbsp;            isPremiumRule = false;</b>
&nbsp;          }
&nbsp;        } else {
<b class="nc">&nbsp;          isPremiumRule = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (inRuleGroup) {</b>
<b class="nc">&nbsp;          subId++;</b>
<b class="nc">&nbsp;          if (id == null) {</b>
<b class="nc">&nbsp;            id = ruleGroupId;</b>
&nbsp;          }
<b class="nc">&nbsp;          if (name == null) {</b>
<b class="nc">&nbsp;            name = ruleGroupDescription;</b>
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        if (id == null &amp;&amp; !relaxedMode) {</b>
<b class="nc">&nbsp;          throw new RuntimeException(&quot;id is null for rule with name &#39;&quot; + name + &quot;&#39;&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        id = idPrefix != null ? idPrefix + id : id;</b>
<b class="nc">&nbsp;        if (inRuleGroup &amp;&amp; ruleGroupDefaultOff &amp;&amp; attrs.getValue(DEFAULT) != null) {</b>
<b class="nc">&nbsp;          throw new RuntimeException(&quot;Rule group &quot; + ruleGroupId + &quot; is off by default, thus a subrule of &quot; + id + &quot; cannot specify &#39;default=...&#39;. \033[1m Remove &#39;default=...&#39; from rule group or subrule level in &quot; + ruleGroupId + &quot;!\033[0m&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (inRuleGroup &amp;&amp; ruleGroupDefaultTempOff &amp;&amp; attrs.getValue(DEFAULT) != null) {</b>
<b class="nc">&nbsp;          throw new RuntimeException(&quot;Rule group &quot; + ruleGroupId + &quot; is off by default, thus a subrule of &quot; + id + &quot; cannot specify &#39;default=...&#39;. \033[1m Remove &#39;default=...&#39; from rule group or subrule level in &quot; + ruleGroupId + &quot;!\033[0m&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (inRuleGroup &amp;&amp; ruleGroupDefaultOff) {</b>
<b class="nc">&nbsp;          defaultOff = true;</b>
<b class="nc">&nbsp;        } else if (inRuleGroup &amp;&amp; ruleGroupDefaultTempOff) {</b>
<b class="nc">&nbsp;          defaultTempOff = true;</b>
&nbsp;        } else {
<b class="nc">&nbsp;          defaultOff = OFF.equals(attrs.getValue(DEFAULT));</b>
<b class="nc">&nbsp;          defaultTempOff = TEMP_OFF.equals(attrs.getValue(DEFAULT));</b>
&nbsp;        }
<b class="nc">&nbsp;        correctExamples = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        antipatternExamples = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        incorrectExamples = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        errorTriggeringExamples = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        suggestionMatches.clear();</b>
<b class="nc">&nbsp;        suggestionMatchesOutMsg.clear();</b>
<b class="nc">&nbsp;        if (attrs.getValue(TYPE) != null) {</b>
<b class="nc">&nbsp;          ruleIssueType = attrs.getValue(TYPE);</b>
&nbsp;        }
<b class="nc">&nbsp;        isRuleSuppressMisspelled = false;</b>
<b class="nc">&nbsp;        if (attrs.getValue(&quot;tags&quot;) != null) {</b>
<b class="nc">&nbsp;          ruleTags.addAll(Arrays.asList(attrs.getValue(&quot;tags&quot;).split(&quot; &quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (attrs.getValue(&quot;tone_tags&quot;) != null) {</b>
<b class="nc">&nbsp;          ruleToneTags.addAll(Arrays.asList(attrs.getValue(&quot;tone_tags&quot;).split(&quot; &quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        String isGoalSpecificRule = attrs.getValue(GOAL_SPECIFIC);</b>
&nbsp;        //check if this rule is goal specific
<b class="nc">&nbsp;        if (isGoalSpecificRule != null) {</b>
<b class="nc">&nbsp;          if (TRUE.equals(isGoalSpecificRule)) {</b>
<b class="nc">&nbsp;            isGoalSpecific = true;</b>
<b class="nc">&nbsp;          } else if (FALSE.equals(isGoalSpecificRule)) {</b>
<b class="nc">&nbsp;            isGoalSpecific = false;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (isGoalSpecificRuleGroupAttribute != null) {</b>
<b class="nc">&nbsp;          if (TRUE.equals(isGoalSpecificRuleGroupAttribute)) {</b>
<b class="nc">&nbsp;            isGoalSpecific = true;</b>
<b class="nc">&nbsp;          } else if (FALSE.equals(isGoalSpecificRuleGroupAttribute)) {</b>
<b class="nc">&nbsp;            isGoalSpecific = false;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (isGoalSpecificCategoryAttribute != null) {</b>
<b class="nc">&nbsp;          if (TRUE.equals(isGoalSpecificCategoryAttribute)) {</b>
<b class="nc">&nbsp;            isGoalSpecific = true;</b>
<b class="nc">&nbsp;          } else if (FALSE.equals(isGoalSpecificCategoryAttribute)) {</b>
<b class="nc">&nbsp;            isGoalSpecific = false;</b>
&nbsp;          }
&nbsp;        } else {
<b class="nc">&nbsp;          isGoalSpecific = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        String prioRuleAttributeValue = attrs.getValue(PRIO);</b>
<b class="nc">&nbsp;        if (prioRuleAttributeValue != null) {</b>
<b class="nc">&nbsp;          prioRuleAttribute = Integer.parseInt(prioRuleAttributeValue);</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case PATTERN:
<b class="nc">&nbsp;        startPattern(attrs);</b>
<b class="nc">&nbsp;        tokenCountForMarker = 0;</b>
<b class="nc">&nbsp;        interpretPosTagsPreDisambiguation = YES.equals(attrs.getValue(RAW_TAG));</b>
&nbsp;        break;
&nbsp;      case ANTIPATTERN:
<b class="nc">&nbsp;        xmlLineNumberAntiPattern = pLocator.getLineNumber();</b>
<b class="nc">&nbsp;        inAntiPattern = true;</b>
<b class="nc">&nbsp;        antiPatternCounter++;</b>
<b class="nc">&nbsp;        caseSensitive = YES.equals(attrs.getValue(CASE_SENSITIVE));</b>
<b class="nc">&nbsp;        tokenCounter = 0;</b>
<b class="nc">&nbsp;        tokenCountForMarker = 0;</b>
&nbsp;        break;
&nbsp;      case AND:
<b class="nc">&nbsp;        inAndGroup = true;</b>
<b class="nc">&nbsp;        tokenCountForMarker++;</b>
&nbsp;        break;
&nbsp;      case OR:
<b class="nc">&nbsp;        inOrGroup = true;</b>
<b class="nc">&nbsp;        tokenCountForMarker++;</b>
&nbsp;        break;
&nbsp;      case UNIFY:
<b class="nc">&nbsp;        inUnification = true;</b>
<b class="nc">&nbsp;        uniNegation = YES.equals(attrs.getValue(NEGATE));</b>
&nbsp;        break;
&nbsp;      case UNIFY_IGNORE:
<b class="nc">&nbsp;        inUnificationNeutral = true;</b>
&nbsp;        break;
&nbsp;      case FEATURE:
<b class="nc">&nbsp;        uFeature = attrs.getValue(ID);</b>
&nbsp;        break;
&nbsp;      case TYPE:
<b class="nc">&nbsp;        uType = attrs.getValue(ID);</b>
<b class="nc">&nbsp;        uTypeList.add(uType);</b>
&nbsp;        break;
&nbsp;      case TOKEN:
<b class="nc">&nbsp;        setToken(attrs);</b>
<b class="nc">&nbsp;        if (!inAndGroup &amp;&amp; !inOrGroup) {</b>
<b class="nc">&nbsp;          tokenCountForMarker++;</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case EXCEPTION:
<b class="nc">&nbsp;        setExceptions(attrs);</b>
&nbsp;        break;
&nbsp;      case EXAMPLE:
<b class="nc">&nbsp;        String typeVal = attrs.getValue(TYPE);</b>
<b class="nc">&nbsp;        if (inAntiPattern) {</b>
<b class="nc">&nbsp;          if (inRuleGroup &amp;&amp; !inRule) {</b>
<b class="nc">&nbsp;            inAntiPatternForRuleGroupExample = true;</b>
<b class="nc">&nbsp;            antiPatternForRuleGroupExample = new StringBuilder();</b>
&nbsp;          } else {
<b class="nc">&nbsp;            inAntiPatternExample = true;</b>
<b class="nc">&nbsp;            antiPatternExample = new StringBuilder();</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (&quot;incorrect&quot;.equals(typeVal) || attrs.getValue(&quot;correction&quot;) != null) {</b>
<b class="nc">&nbsp;          inIncorrectExample = true;</b>
<b class="nc">&nbsp;          incorrectExample = new StringBuilder();</b>
<b class="nc">&nbsp;          if (attrs.getValue(&quot;correction&quot;) != null) {</b>
<b class="nc">&nbsp;            exampleCorrection = new StringBuilder();</b>
<b class="nc">&nbsp;            exampleCorrection.append(attrs.getValue(&quot;correction&quot;));</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (&quot;triggers_error&quot;.equals(typeVal)) {</b>
<b class="nc">&nbsp;          inErrorTriggerExample = true;</b>
<b class="nc">&nbsp;          errorTriggerExample = new StringBuilder();</b>
&nbsp;        } else {
&nbsp;          // no attribute implies the sentence is a correct example
<b class="nc">&nbsp;          inCorrectExample = true;</b>
<b class="nc">&nbsp;          correctExample = new StringBuilder();</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case &quot;filter&quot;:
<b class="nc">&nbsp;        filterClassName = attrs.getValue(&quot;class&quot;);</b>
<b class="nc">&nbsp;        filterArgs = attrs.getValue(&quot;args&quot;);</b>
&nbsp;        break;
&nbsp;      case MESSAGE:
<b class="nc">&nbsp;        inMessage = true;</b>
<b class="nc">&nbsp;        inSuggestion = false;</b>
<b class="nc">&nbsp;        message = new StringBuilder();</b>
<b class="nc">&nbsp;        isRuleSuppressMisspelled = YES.equals(attrs.getValue(&quot;suppress_misspelled&quot;));</b>
<b class="nc">&nbsp;        if (isRuleSuppressMisspelled) {</b>
<b class="nc">&nbsp;          message.append(PLEASE_SPELL_ME);</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case SUGGESTION:
<b class="nc">&nbsp;        String strToAppend = &quot;&lt;suggestion&gt;&quot;;</b>
<b class="nc">&nbsp;        isSuggestionSuppressMisspelled = YES.equals(attrs.getValue(&quot;suppress_misspelled&quot;));</b>
<b class="nc">&nbsp;        if (isSuggestionSuppressMisspelled || isRuleSuppressMisspelled) {</b>
<b class="nc">&nbsp;          strToAppend = strToAppend + PLEASE_SPELL_ME;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (inMessage) {</b>
<b class="nc">&nbsp;          message.append(strToAppend);</b>
&nbsp;        } else { // suggestions outside message
<b class="nc">&nbsp;          suggestionsOutMsg.append(strToAppend);</b>
&nbsp;        }
<b class="nc">&nbsp;        inSuggestion = true;</b>
&nbsp;        break;
&nbsp;      case &quot;short&quot;:
<b class="nc">&nbsp;        if (inRule) {</b>
<b class="nc">&nbsp;          inShortMessage = true;</b>
<b class="nc">&nbsp;          shortMessage = new StringBuilder();</b>
&nbsp;        } else {
<b class="nc">&nbsp;          inShortMessageForRuleGroup = true;</b>
<b class="nc">&nbsp;          shortMessageForRuleGroup = new StringBuilder();</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case &quot;url&quot;:
<b class="nc">&nbsp;        if (inRule) {</b>
<b class="nc">&nbsp;          inUrl = true;</b>
<b class="nc">&nbsp;          url = new StringBuilder();</b>
&nbsp;        } else {
<b class="nc">&nbsp;          inUrlForRuleGroup = true;</b>
<b class="nc">&nbsp;          urlForRuleGroup = new StringBuilder();</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case RULEGROUP:
<b class="nc">&nbsp;        ruleGroupId = attrs.getValue(ID);</b>
<b class="nc">&nbsp;        premiumRuleGroupAttribute = attrs.getValue(PREMIUM);</b>
<b class="nc">&nbsp;        ruleGroupDescription = attrs.getValue(NAME);</b>
<b class="nc">&nbsp;        ruleGroupDefaultOff = OFF.equals(attrs.getValue(DEFAULT));</b>
<b class="nc">&nbsp;        ruleGroupDefaultTempOff = TEMP_OFF.equals(attrs.getValue(DEFAULT));</b>
<b class="nc">&nbsp;        urlForRuleGroup = new StringBuilder();</b>
<b class="nc">&nbsp;        shortMessageForRuleGroup = new StringBuilder();</b>
<b class="nc">&nbsp;        inRuleGroup = true;</b>
<b class="nc">&nbsp;        subId = 0;</b>
<b class="nc">&nbsp;        if (attrs.getValue(TYPE) != null) {</b>
<b class="nc">&nbsp;          ruleGroupIssueType = attrs.getValue(TYPE);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (attrs.getValue(&quot;tags&quot;) != null) {</b>
<b class="nc">&nbsp;          ruleGroupTags.addAll(Arrays.asList(attrs.getValue(&quot;tags&quot;).split(&quot; &quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (attrs.getValue(&quot;tone_tags&quot;) != null) {</b>
<b class="nc">&nbsp;          ruleGroupToneTags.addAll(Arrays.asList(attrs.getValue(&quot;tone_tags&quot;).split(&quot; &quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        isGoalSpecificRuleGroupAttribute = attrs.getValue(GOAL_SPECIFIC);</b>
<b class="nc">&nbsp;        String minPrevMatchesStr2 = attrs.getValue(MINPREVMATCHES);</b>
<b class="nc">&nbsp;        if (minPrevMatchesStr2 != null) {</b>
<b class="nc">&nbsp;          ruleGroupMinPrevMatches = Integer.parseInt(minPrevMatchesStr2);  </b>
&nbsp;        }
<b class="nc">&nbsp;        String distanceTokensStr2 = attrs.getValue(DISTANCETOKENS);</b>
<b class="nc">&nbsp;        if (distanceTokensStr2 != null) {</b>
<b class="nc">&nbsp;          ruleGroupDistanceTokens = Integer.parseInt(distanceTokensStr2);  </b>
&nbsp;        }
<b class="nc">&nbsp;        antipatternForRuleGroupsExamples = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        String prioRuleGroupAttributeValue = attrs.getValue(PRIO);</b>
<b class="nc">&nbsp;        if (prioRuleGroupAttributeValue != null) {</b>
<b class="nc">&nbsp;          prioRuleGroupAttribute = Integer.parseInt(prioRuleGroupAttributeValue);</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case MATCH:
<b class="nc">&nbsp;        setMatchElement(attrs, inSuggestion &amp;&amp; (isSuggestionSuppressMisspelled || isRuleSuppressMisspelled));</b>
&nbsp;        break;
&nbsp;      case MARKER:
<b class="nc">&nbsp;        if (inMarker) {</b>
<b class="nc">&nbsp;          throw new IllegalStateException(&quot;&#39;&lt;marker&gt;&#39; may not be nested in rule &#39;&quot; + id + &quot;&#39;&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (inIncorrectExample) {</b>
<b class="nc">&nbsp;          incorrectExample.append(MARKER_TAG);</b>
<b class="nc">&nbsp;        } else if (inCorrectExample) {</b>
<b class="nc">&nbsp;          correctExample.append(MARKER_TAG);</b>
<b class="nc">&nbsp;        } else if (inErrorTriggerExample) {</b>
<b class="nc">&nbsp;          errorTriggerExample.append(MARKER_TAG);</b>
<b class="nc">&nbsp;        } else if (inPattern || inAntiPattern) {</b>
<b class="nc">&nbsp;          startPos = tokenCounter;</b>
<b class="nc">&nbsp;          inMarker = true;</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case UNIFICATION:
<b class="nc">&nbsp;        uFeature = attrs.getValue(&quot;feature&quot;);</b>
<b class="nc">&nbsp;        inUnificationDef = true;</b>
&nbsp;        break;
&nbsp;      case &quot;equivalence&quot;:
<b class="nc">&nbsp;        uType = attrs.getValue(TYPE);</b>
&nbsp;        break;
&nbsp;      case PHRASES:
<b class="nc">&nbsp;        inPhrases = true;</b>
&nbsp;        break;
&nbsp;      case &quot;includephrases&quot;:
&nbsp;        break;
&nbsp;      case &quot;phrase&quot;:
<b class="nc">&nbsp;        if (inPhrases) {</b>
<b class="nc">&nbsp;          phraseId = attrs.getValue(ID);</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case &quot;phraseref&quot;:
<b class="nc">&nbsp;        if (attrs.getValue(&quot;idref&quot;) != null) {</b>
<b class="nc">&nbsp;          preparePhrase(attrs);</b>
<b class="nc">&nbsp;          tokenCountForMarker++;</b>
&nbsp;        }
&nbsp;        break;
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public void endElement(String namespaceURI, String sName,
&nbsp;      String qName) throws SAXException {
<b class="nc">&nbsp;    switch (qName) {</b>
&nbsp;      case &quot;category&quot;:
<b class="nc">&nbsp;        categoryIssueType = null;</b>
<b class="nc">&nbsp;        categoryTags.clear();</b>
<b class="nc">&nbsp;        categoryToneTags.clear();</b>
<b class="nc">&nbsp;        isGoalSpecific = false;</b>
<b class="nc">&nbsp;        premiumCategoryAttribute = null;</b>
<b class="nc">&nbsp;        isGoalSpecificCategoryAttribute = null;</b>
<b class="nc">&nbsp;        prioCategoryAttribute = 0;</b>
&nbsp;        break;
&nbsp;      case &quot;regexp&quot;:
<b class="nc">&nbsp;        inRegex = false;</b>
&nbsp;        break;
&nbsp;      case RULE:
<b class="nc">&nbsp;        suggestionMatchesOutMsg = addLegacyMatches(suggestionMatchesOutMsg, suggestionsOutMsg.toString(), false);</b>
<b class="nc">&nbsp;        if (relaxedMode &amp;&amp; id == null) {</b>
<b class="nc">&nbsp;          id = &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (relaxedMode &amp;&amp; name == null) {</b>
<b class="nc">&nbsp;          name = &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (phrasePatternTokens.isEmpty()) {</b>
&nbsp;          // Elements contain information whether they are inside a &lt;marker&gt;...&lt;/marker&gt;,
&nbsp;          // but for phraserefs this depends on the position where the phraseref is used
&nbsp;          // not where it&#39;s defined. Thus we have to copy the elements so each use of
&nbsp;          // the phraseref can carry their own information:
<b class="nc">&nbsp;          List&lt;PatternToken&gt; tmpPatternTokens = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;          createRules(new ArrayList&lt;&gt;(patternTokens), tmpPatternTokens, 0);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          if (!patternTokens.isEmpty()) {</b>
<b class="nc">&nbsp;            for (List&lt;PatternToken&gt; ph : phrasePatternTokens) {</b>
<b class="nc">&nbsp;              ph.addAll(new ArrayList&lt;&gt;(patternTokens));</b>
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;          for (List&lt;PatternToken&gt; phrasePatternToken : phrasePatternTokens) {</b>
<b class="nc">&nbsp;            processElement(phrasePatternToken);</b>
<b class="nc">&nbsp;            List&lt;PatternToken&gt; tmpPatternTokens = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            createRules(phrasePatternToken, tmpPatternTokens, 0);</b>
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        patternTokens.clear();</b>
<b class="nc">&nbsp;        if (phrasePatternTokens != null) {</b>
<b class="nc">&nbsp;          phrasePatternTokens.clear();</b>
&nbsp;        }
<b class="nc">&nbsp;        ruleIssueType = null;</b>
<b class="nc">&nbsp;        inRule = false;</b>
<b class="nc">&nbsp;        filterClassName = null;</b>
<b class="nc">&nbsp;        filterArgs = null;</b>
<b class="nc">&nbsp;        minPrevMatches = 0;</b>
<b class="nc">&nbsp;        distanceTokens = 0;</b>
<b class="nc">&nbsp;        ruleTags.clear();</b>
<b class="nc">&nbsp;        ruleToneTags.clear();</b>
<b class="nc">&nbsp;        isPremiumRule = false;</b>
<b class="nc">&nbsp;        isGoalSpecific = false;</b>
<b class="nc">&nbsp;        prioRuleAttribute = 0;</b>
&nbsp;        break;
&nbsp;      case EXCEPTION:
<b class="nc">&nbsp;        finalizeExceptions();</b>
&nbsp;        break;
&nbsp;      case AND:
<b class="nc">&nbsp;        inAndGroup = false;</b>
<b class="nc">&nbsp;        andGroupCounter = 0;</b>
<b class="nc">&nbsp;        tokenCounter++;</b>
&nbsp;        break;
&nbsp;      case OR:
<b class="nc">&nbsp;        inOrGroup = false;</b>
<b class="nc">&nbsp;        orGroupCounter = 0;</b>
<b class="nc">&nbsp;        tokenCounter++;</b>
&nbsp;        break;
&nbsp;      case TOKEN:
<b class="nc">&nbsp;        finalizeTokens(language.getUnifierConfiguration());</b>
&nbsp;        break;
&nbsp;      case PATTERN:
<b class="nc">&nbsp;        inPattern = false;</b>
<b class="nc">&nbsp;        if (lastPhrase) {</b>
<b class="nc">&nbsp;          patternTokens.clear();</b>
&nbsp;        }
<b class="nc">&nbsp;        tokenCounter = 0;</b>
&nbsp;        break;
&nbsp;      case ANTIPATTERN:
<b class="nc">&nbsp;        String antiId = id;</b>
<b class="nc">&nbsp;        if (inRuleGroup) {</b>
<b class="nc">&nbsp;          if (subId &gt; 0) {</b>
<b class="nc">&nbsp;            antiId = ruleGroupId + &quot;[&quot; + subId + &quot;]&quot;;</b>
&nbsp;          } else {
<b class="nc">&nbsp;            antiId = ruleGroupId;</b>
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        DisambiguationPatternRule rule = new DisambiguationPatternRule(</b>
&nbsp;            antiId + &quot;_antipattern:&quot; + antiPatternCounter,
&nbsp;            &quot;antipattern&quot;, language, patternTokens, null, null,
&nbsp;            DisambiguationPatternRule.DisambiguatorAction.IMMUNIZE);
<b class="nc">&nbsp;        rule.setXmlLineNumber(xmlLineNumberAntiPattern);</b>
<b class="nc">&nbsp;        if (startPos != -1 &amp;&amp; endPos != -1) {</b>
<b class="nc">&nbsp;          rule.setStartPositionCorrection(startPos);</b>
<b class="nc">&nbsp;          rule.setEndPositionCorrection(endPos - tokenCountForMarker);</b>
&nbsp;        } else {
&nbsp;          // No &#39;&lt;marker&gt;&#39;? Then add artificial &lt;marker&gt;s around all tokens to work
&nbsp;          // around issue https://github.com/languagetool-org/languagetool/issues/189:
<b class="nc">&nbsp;          for (PatternToken patternToken : patternTokens) {</b>
<b class="nc">&nbsp;            patternToken.setInsideMarker(true);</b>
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        patternTokens.clear();</b>
<b class="nc">&nbsp;        if (inRule) {</b>
<b class="nc">&nbsp;          ruleAntiPatterns.add(rule);</b>
&nbsp;        } else { // a rulegroup shares all antipatterns not included in a single rule
<b class="nc">&nbsp;          rulegroupAntiPatterns.add(rule);</b>
&nbsp;        }
<b class="nc">&nbsp;        tokenCounter = 0;</b>
<b class="nc">&nbsp;        inAntiPattern = false;</b>
<b class="nc">&nbsp;        endPos = -1;</b>
<b class="nc">&nbsp;        startPos = -1;</b>
<b class="nc">&nbsp;        inAntiPatternExample = false;</b>
<b class="nc">&nbsp;        xmlLineNumberAntiPattern = -1;</b>
&nbsp;        break;
&nbsp;      case EXAMPLE:
<b class="nc">&nbsp;        if (inAntiPatternExample) {</b>
<b class="nc">&nbsp;          antipatternExamples.add(new CorrectExample(antiPatternExample.toString()));</b>
<b class="nc">&nbsp;        } else if (inAntiPatternForRuleGroupExample) {</b>
<b class="nc">&nbsp;          antipatternForRuleGroupsExamples.add(new CorrectExample(antiPatternForRuleGroupExample.toString()));</b>
<b class="nc">&nbsp;        } else if (inCorrectExample) {</b>
<b class="nc">&nbsp;          correctExamples.add(new CorrectExample(correctExample.toString()));</b>
<b class="nc">&nbsp;        } else if (inIncorrectExample) {</b>
<b class="nc">&nbsp;          if (inAntiPattern) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;&lt;antipattern&gt;s can only contain &lt;example&gt;s without errors (i.e. no &#39;correction=...&#39;). &quot; +</b>
&nbsp;              &quot;Rule id: &quot; + id + &quot;[&quot; + subId + &quot;], antipattern no &quot; + antiPatternCounter);
&nbsp;          }
&nbsp;          IncorrectExample example;
<b class="nc">&nbsp;          if (exampleCorrection == null) {</b>
<b class="nc">&nbsp;            example = new IncorrectExample(incorrectExample.toString());</b>
&nbsp;          } else {
<b class="nc">&nbsp;            List&lt;String&gt; corrections = new ArrayList&lt;&gt;(Arrays.asList(exampleCorrection.toString().split(&quot;\\|&quot;)));</b>
<b class="nc">&nbsp;            if (exampleCorrection.toString().endsWith(&quot;|&quot;)) {  // suggestions plus an empty suggestion (split() will ignore trailing empty items)</b>
<b class="nc">&nbsp;              corrections.add(&quot;&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            example = new IncorrectExample(incorrectExample.toString(), corrections);</b>
&nbsp;          }
<b class="nc">&nbsp;          incorrectExamples.add(example);</b>
<b class="nc">&nbsp;        } else if (inErrorTriggerExample) {</b>
<b class="nc">&nbsp;          errorTriggeringExamples.add(new ErrorTriggeringExample(errorTriggerExample.toString()));</b>
&nbsp;        }
<b class="nc">&nbsp;        inCorrectExample = false;</b>
<b class="nc">&nbsp;        inIncorrectExample = false;</b>
<b class="nc">&nbsp;        inErrorTriggerExample = false;</b>
<b class="nc">&nbsp;        correctExample = new StringBuilder();</b>
<b class="nc">&nbsp;        incorrectExample = new StringBuilder();</b>
<b class="nc">&nbsp;        errorTriggerExample = new StringBuilder();</b>
<b class="nc">&nbsp;        exampleCorrection = null;</b>
<b class="nc">&nbsp;        antiPatternExample = new StringBuilder();</b>
<b class="nc">&nbsp;        antiPatternForRuleGroupExample = new StringBuilder();</b>
<b class="nc">&nbsp;        inAntiPatternExample = false;</b>
<b class="nc">&nbsp;        inAntiPatternForRuleGroupExample = false;</b>
&nbsp;        break;
&nbsp;      case MESSAGE:
<b class="nc">&nbsp;        suggestionMatches = addLegacyMatches(suggestionMatches, message.toString(), true);</b>
<b class="nc">&nbsp;        inMessage = false;</b>
&nbsp;        break;
&nbsp;      case SUGGESTION:
<b class="nc">&nbsp;        if (inMessage) {</b>
<b class="nc">&nbsp;          message.append(&quot;&lt;/suggestion&gt;&quot;);</b>
&nbsp;        } else { //suggestion outside message
<b class="nc">&nbsp;          suggestionsOutMsg.append(&quot;&lt;/suggestion&gt;&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        inSuggestion = false;</b>
&nbsp;        break;
&nbsp;      case &quot;short&quot;:
<b class="nc">&nbsp;        inShortMessage = false;</b>
<b class="nc">&nbsp;        inShortMessageForRuleGroup = false;</b>
&nbsp;        break;
&nbsp;      case &quot;url&quot;:
<b class="nc">&nbsp;        inUrl = false;</b>
<b class="nc">&nbsp;        inUrlForRuleGroup = false;</b>
&nbsp;        break;
&nbsp;      case MATCH:
<b class="nc">&nbsp;        if (inMessage) {</b>
<b class="nc">&nbsp;          suggestionMatches.get(suggestionMatches.size() - 1).</b>
<b class="nc">&nbsp;              setLemmaString(match.toString());</b>
<b class="nc">&nbsp;        } else if (inSuggestion) {</b>
<b class="nc">&nbsp;          suggestionMatchesOutMsg.get(suggestionMatchesOutMsg.size() - 1).</b>
<b class="nc">&nbsp;              setLemmaString(match.toString());</b>
<b class="nc">&nbsp;        } else if (inToken) {</b>
<b class="nc">&nbsp;          tokenReference.setLemmaString(match.toString());</b>
&nbsp;        }
<b class="nc">&nbsp;        inMatch = false;</b>
&nbsp;        break;
&nbsp;      case RULEGROUP:
<b class="nc">&nbsp;        urlForRuleGroup = new StringBuilder();</b>
<b class="nc">&nbsp;        shortMessageForRuleGroup = new StringBuilder();</b>
<b class="nc">&nbsp;        inRuleGroup = false;</b>
<b class="nc">&nbsp;        ruleGroupIssueType = null;</b>
<b class="nc">&nbsp;        rulegroupAntiPatterns.clear();</b>
<b class="nc">&nbsp;        antiPatternCounter = 0;</b>
<b class="nc">&nbsp;        ruleGroupDefaultOff = false;</b>
<b class="nc">&nbsp;        ruleGroupDefaultTempOff = false;</b>
<b class="nc">&nbsp;        defaultOff = false;</b>
<b class="nc">&nbsp;        defaultTempOff = false;</b>
<b class="nc">&nbsp;        ruleGroupMinPrevMatches = 0;</b>
<b class="nc">&nbsp;        ruleGroupDistanceTokens = 0;</b>
<b class="nc">&nbsp;        ruleGroupTags.clear();</b>
<b class="nc">&nbsp;        ruleGroupToneTags.clear();</b>
<b class="nc">&nbsp;        premiumRuleGroupAttribute = null;</b>
<b class="nc">&nbsp;        isGoalSpecificRuleGroupAttribute = null;</b>
<b class="nc">&nbsp;        antipatternForRuleGroupsExamples.clear();</b>
<b class="nc">&nbsp;        prioRuleGroupAttribute = 0;</b>
&nbsp;        break;
&nbsp;      case MARKER:
<b class="nc">&nbsp;        if (inCorrectExample) {</b>
<b class="nc">&nbsp;          correctExample.append(&quot;&lt;/marker&gt;&quot;);</b>
<b class="nc">&nbsp;        } else if (inIncorrectExample) {</b>
<b class="nc">&nbsp;          incorrectExample.append(&quot;&lt;/marker&gt;&quot;);</b>
<b class="nc">&nbsp;        } else if (inErrorTriggerExample) {</b>
<b class="nc">&nbsp;          errorTriggerExample.append(&quot;&lt;/marker&gt;&quot;);</b>
<b class="nc">&nbsp;        } else if (inPattern || inAntiPattern) {</b>
<b class="nc">&nbsp;          endPos = tokenCountForMarker;</b>
<b class="nc">&nbsp;          inMarker = false;</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case &quot;phrase&quot;:
<b class="nc">&nbsp;        if (inPhrases) {</b>
<b class="nc">&nbsp;          finalizePhrase();</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case &quot;includephrases&quot;:
<b class="nc">&nbsp;        patternTokens.clear();</b>
&nbsp;        break;
&nbsp;      case PHRASES:
<b class="nc">&nbsp;        if (inPhrases) {</b>
<b class="nc">&nbsp;          inPhrases = false;</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case UNIFICATION:
<b class="nc">&nbsp;        inUnificationDef = false;</b>
&nbsp;        break;
&nbsp;      case FEATURE:
<b class="nc">&nbsp;        equivalenceFeatures.put(uFeature, uTypeList);</b>
<b class="nc">&nbsp;        uTypeList = new ArrayList&lt;&gt;();</b>
&nbsp;        break;
&nbsp;      case UNIFY:
<b class="nc">&nbsp;        inUnification = false;</b>
&nbsp;        //clear the features...
<b class="nc">&nbsp;        equivalenceFeatures = new HashMap&lt;&gt;();</b>
&nbsp;        //set negation on the last token only!
<b class="nc">&nbsp;        int lastElement = patternTokens.size() - 1;</b>
<b class="nc">&nbsp;        patternTokens.get(lastElement).setLastInUnification();</b>
<b class="nc">&nbsp;        if (uniNegation) {</b>
<b class="nc">&nbsp;          patternTokens.get(lastElement).setUniNegation();</b>
&nbsp;        }
&nbsp;        break;
&nbsp;      case UNIFY_IGNORE:
<b class="nc">&nbsp;        inUnificationNeutral = false;</b>
&nbsp;        break;
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Create rule from an Element list.
&nbsp;   * In case of OR groups, several rules are created recursively.
&nbsp;   * @since 2.3
&nbsp;   * 
&nbsp;   * @param elemList The complete original Element list
&nbsp;   * @param tmpPatternTokens Temporary list being created
&nbsp;   * @param numElement Index of elemList being analyzed
&nbsp;   */
&nbsp;  private void createRules(List&lt;PatternToken&gt; elemList,
&nbsp;    List&lt;PatternToken&gt; tmpPatternTokens, int numElement) {
<b class="nc">&nbsp;    String shortMessage = &quot;&quot;;</b>
<b class="nc">&nbsp;    if (this.shortMessage != null &amp;&amp; this.shortMessage.length() &gt; 0) {</b>
<b class="nc">&nbsp;      shortMessage = this.shortMessage.toString();</b>
<b class="nc">&nbsp;    } else if (shortMessageForRuleGroup != null &amp;&amp; shortMessageForRuleGroup.length() &gt; 0) {</b>
<b class="nc">&nbsp;      shortMessage = this.shortMessageForRuleGroup.toString();</b>
&nbsp;    }
<b class="nc">&nbsp;    if (minPrevMatches &gt; 0 &amp;&amp; shortMessage.isEmpty() &amp;&amp; messages != null) {</b>
&nbsp;      // it&#39;s a word repetition rule
<b class="nc">&nbsp;      shortMessage = messages.getString(&quot;desc_repetition_short&quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (numElement &gt;= elemList.size()) {</b>
&nbsp;      AbstractPatternRule rule;
<b class="nc">&nbsp;      if (tmpPatternTokens.size() &gt; 0) {</b>
<b class="nc">&nbsp;        rule = new PatternRule(id, language, tmpPatternTokens, name,</b>
<b class="nc">&nbsp;          StringInterner.intern(message.toString()), StringInterner.intern(shortMessage),</b>
<b class="nc">&nbsp;          StringInterner.intern(suggestionsOutMsg.toString()), phrasePatternTokens.size() &gt; 1, interpretPosTagsPreDisambiguation);</b>
<b class="nc">&nbsp;        rule.addTags(ruleTags);</b>
<b class="nc">&nbsp;        rule.addTags(ruleGroupTags);</b>
<b class="nc">&nbsp;        rule.addTags(categoryTags);</b>
<b class="nc">&nbsp;        rule.addToneTags(ruleToneTags);</b>
<b class="nc">&nbsp;        rule.addToneTags(ruleGroupToneTags);</b>
<b class="nc">&nbsp;        rule.setSourceFile(sourceFile);</b>
<b class="nc">&nbsp;        rule.setMinPrevMatches(minPrevMatches);</b>
<b class="nc">&nbsp;        rule.setDistanceTokens(distanceTokens);</b>
<b class="nc">&nbsp;        rule.setXmlLineNumber(xmlLineNumber);</b>
<b class="nc">&nbsp;      } else if (regex.length() &gt; 0) {</b>
<b class="nc">&nbsp;        int flags = regexCaseSensitive ? 0 : Pattern.CASE_INSENSITIVE|Pattern.UNICODE_CASE;</b>
<b class="nc">&nbsp;        String regexStr = regex.toString();</b>
<b class="nc">&nbsp;        if (regexMode == RegexpMode.SMART) {</b>
&nbsp;          // Note: it&#39;s not that easy to add \b because the regex might look like &#39;(foo)&#39; or &#39;\d&#39; so we cannot just look at the last character
<b class="nc">&nbsp;          regexStr = replaceSpacesInRegex(regexStr);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (ruleAntiPatterns.size() &gt; 0 || rulegroupAntiPatterns.size() &gt; 0) {</b>
<b class="nc">&nbsp;          throw new RuntimeException(&quot;&lt;regexp&gt; rules currently cannot be used together with &lt;antipattern&gt;. Rule id: &quot; + id + &quot;[&quot; + subId + &quot;]&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        rule = new RegexPatternRule(id, name, message.toString(), shortMessage, suggestionsOutMsg.toString(), language, Pattern.compile(regexStr, flags), regexpMark);</b>
<b class="nc">&nbsp;        rule.setSourceFile(sourceFile);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        throw new IllegalStateException(&quot;Neither &#39;&lt;pattern&gt;&#39; tokens nor &#39;&lt;regexp&gt;&#39; is set in rule &#39;&quot; + id + &quot;&#39;&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      setRuleFilter(filterClassName, filterArgs, rule);</b>
<b class="nc">&nbsp;      prepareRule(rule);</b>
<b class="nc">&nbsp;      rules.add(rule);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      PatternToken patternToken = elemList.get(numElement);</b>
<b class="nc">&nbsp;      if (patternToken.hasOrGroup()) {</b>
&nbsp;        // When creating a new rule, we finally clear the backed-up variables. All the elements in
&nbsp;        // the OR group should share the values of backed-up variables. That&#39;s why these variables
&nbsp;        // are backed-up.
<b class="nc">&nbsp;        List&lt;Match&gt; suggestionMatchesBackup = new ArrayList&lt;&gt;(suggestionMatches);</b>
<b class="nc">&nbsp;        List&lt;Match&gt; suggestionMatchesOutMsgBackup =  new ArrayList&lt;&gt;(suggestionMatchesOutMsg);</b>
<b class="nc">&nbsp;        int startPosBackup = startPos;</b>
<b class="nc">&nbsp;        int endPosBackup = endPos;</b>
<b class="nc">&nbsp;        List&lt;DisambiguationPatternRule&gt; ruleAntiPatternsBackup = new ArrayList&lt;&gt;(ruleAntiPatterns);</b>
<b class="nc">&nbsp;        for (PatternToken patternTokenOfOrGroup : patternToken.getOrGroup()) {</b>
<b class="nc">&nbsp;          List&lt;PatternToken&gt; tmpElements2 = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;          tmpElements2.addAll(tmpPatternTokens);</b>
<b class="nc">&nbsp;          tmpElements2.add(ObjectUtils.clone(patternTokenOfOrGroup));</b>
<b class="nc">&nbsp;          createRules(elemList, tmpElements2, numElement + 1);</b>
<b class="nc">&nbsp;          startPos = startPosBackup;</b>
<b class="nc">&nbsp;          endPos = endPosBackup;</b>
<b class="nc">&nbsp;          suggestionMatches = suggestionMatchesBackup;</b>
<b class="nc">&nbsp;          suggestionMatchesOutMsg = suggestionMatchesOutMsgBackup;</b>
<b class="nc">&nbsp;          ruleAntiPatterns.addAll(ruleAntiPatternsBackup);</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      tmpPatternTokens.add(ObjectUtils.clone(patternToken));</b>
<b class="nc">&nbsp;      createRules(elemList, tmpPatternTokens, numElement + 1);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  String replaceSpacesInRegex(String s) {
<b class="nc">&nbsp;    StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;    boolean inBracket = false;</b>
<b class="nc">&nbsp;    for (int i = 0; i &lt; s.length(); i++) {</b>
<b class="nc">&nbsp;      char c = s.charAt(i);</b>
<b class="nc">&nbsp;      if (c == &#39;[&#39;) {</b>
<b class="nc">&nbsp;        inBracket = true;</b>
<b class="nc">&nbsp;      } else if (c == &#39;]&#39;) {</b>
<b class="nc">&nbsp;        inBracket = false;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (c == &#39; &#39; &amp;&amp; !inBracket) {</b>
<b class="nc">&nbsp;        sb.append(&quot;(?:[\\s\u00A0\u202F]+)&quot;);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        sb.append(c);</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return sb.toString();</b>
&nbsp;  }
&nbsp;
&nbsp;  protected void prepareRule(AbstractPatternRule rule) {
<b class="nc">&nbsp;    rule.setPremium(isPremiumRule);</b>
<b class="nc">&nbsp;    rule.setSourceFile(sourceFile);</b>
<b class="nc">&nbsp;    if (startPos != -1 &amp;&amp; endPos != -1) {</b>
<b class="nc">&nbsp;      rule.setStartPositionCorrection(startPos);</b>
<b class="nc">&nbsp;      rule.setEndPositionCorrection(endPos - tokenCountForMarker);</b>
&nbsp;    }
<b class="nc">&nbsp;    startPos = -1;</b>
<b class="nc">&nbsp;    endPos = -1;</b>
<b class="nc">&nbsp;    List&lt;CorrectExample&gt; allCorrectExamples = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    allCorrectExamples.addAll(correctExamples);</b>
<b class="nc">&nbsp;    allCorrectExamples.addAll(antipatternExamples);</b>
<b class="nc">&nbsp;    allCorrectExamples.addAll(antipatternForRuleGroupsExamples);</b>
<b class="nc">&nbsp;    if (!allCorrectExamples.isEmpty()) {</b>
<b class="nc">&nbsp;      rule.setCorrectExamples(allCorrectExamples);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (!incorrectExamples.isEmpty()) {</b>
<b class="nc">&nbsp;      rule.setIncorrectExamples(incorrectExamples);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (!errorTriggeringExamples.isEmpty()) {</b>
<b class="nc">&nbsp;      rule.setErrorTriggeringExamples(errorTriggeringExamples);</b>
&nbsp;    }
<b class="nc">&nbsp;    rule.setCategory(category);</b>
<b class="nc">&nbsp;    if (!rulegroupAntiPatterns.isEmpty()) {</b>
<b class="nc">&nbsp;      rule.setAntiPatterns(rulegroupAntiPatterns);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (!ruleAntiPatterns.isEmpty()) {</b>
<b class="nc">&nbsp;      rule.setAntiPatterns(ruleAntiPatterns);</b>
<b class="nc">&nbsp;      ruleAntiPatterns.clear();</b>
&nbsp;    }
<b class="nc">&nbsp;    rule.addTags(ruleTags);</b>
<b class="nc">&nbsp;    rule.addTags(ruleGroupTags);</b>
<b class="nc">&nbsp;    rule.addTags(categoryTags);</b>
<b class="nc">&nbsp;    rule.addToneTags(ruleToneTags);</b>
<b class="nc">&nbsp;    rule.addToneTags(ruleGroupToneTags);</b>
<b class="nc">&nbsp;    rule.addToneTags(categoryToneTags);</b>
<b class="nc">&nbsp;    rule.setGoalSpecific(isGoalSpecific);</b>
<b class="nc">&nbsp;    if (inRuleGroup) {</b>
<b class="nc">&nbsp;      rule.setSubId(StringInterner.intern(Integer.toString(subId)));</b>
&nbsp;    } else {
<b class="nc">&nbsp;      rule.setSubId(&quot;1&quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    caseSensitive = false;</b>
<b class="nc">&nbsp;    for (Match m : suggestionMatches) {</b>
<b class="nc">&nbsp;      rule.addSuggestionMatch(m);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (phrasePatternTokens.size() &lt;= 1) {</b>
<b class="nc">&nbsp;      suggestionMatches.clear();</b>
&nbsp;    }
<b class="nc">&nbsp;    for (Match m : suggestionMatchesOutMsg) {</b>
<b class="nc">&nbsp;      rule.addSuggestionMatchOutMsg(m);</b>
&nbsp;    }
<b class="nc">&nbsp;    suggestionMatchesOutMsg.clear();</b>
<b class="nc">&nbsp;    if (category == null) {</b>
<b class="nc">&nbsp;      throw new RuntimeException(&quot;Cannot activate rule &#39;&quot; + id + &quot;&#39;, it is outside of a &lt;category&gt;...&lt;/category&gt;&quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (defaultOff) {</b>
<b class="nc">&nbsp;      rule.setDefaultOff();</b>
&nbsp;    }
<b class="nc">&nbsp;    if (defaultTempOff) {</b>
<b class="nc">&nbsp;      rule.setDefaultTempOff();</b>
&nbsp;    }
<b class="nc">&nbsp;    if (url != null &amp;&amp; url.length() &gt; 0) {</b>
&nbsp;      try {
<b class="nc">&nbsp;        String s = url.toString();</b>
<b class="nc">&nbsp;        rule.setUrl(internUrl(s));</b>
&nbsp;      } catch (MalformedURLException e) {
<b class="nc">&nbsp;        throw new RuntimeException(&quot;Could not parse URL for rule: &quot; + rule + &quot;: &#39;&quot; + url + &quot;&#39;&quot;, e);</b>
&nbsp;      }
<b class="nc">&nbsp;    } else if (urlForRuleGroup != null &amp;&amp; urlForRuleGroup.length() &gt; 0) {</b>
&nbsp;      try {
<b class="nc">&nbsp;        rule.setUrl(internUrl(urlForRuleGroup.toString()));</b>
&nbsp;      } catch (MalformedURLException e) {
<b class="nc">&nbsp;        throw new RuntimeException(&quot;Could not parse URL for rule: &quot; + rule + &quot;: &#39;&quot; + urlForRuleGroup + &quot;&#39;&quot;, e);</b>
&nbsp;      }
&nbsp;    }
&nbsp;    // inheritance of values - if no type value is defined for a rule, take the rule group&#39;s value etc:
<b class="nc">&nbsp;    if (ruleIssueType != null) {</b>
<b class="nc">&nbsp;      rule.setLocQualityIssueType(ITSIssueType.getIssueType(ruleIssueType));</b>
<b class="nc">&nbsp;    } else if (ruleGroupIssueType != null) {</b>
<b class="nc">&nbsp;      rule.setLocQualityIssueType(ITSIssueType.getIssueType(ruleGroupIssueType));</b>
<b class="nc">&nbsp;    } else if (categoryIssueType != null) {</b>
<b class="nc">&nbsp;      rule.setLocQualityIssueType(ITSIssueType.getIssueType(categoryIssueType));</b>
&nbsp;    }
<b class="nc">&nbsp;    int prio = 0;</b>
<b class="nc">&nbsp;    if (prioCategoryAttribute != 0) {</b>
<b class="nc">&nbsp;      prio = prioCategoryAttribute;</b>
&nbsp;    }
<b class="nc">&nbsp;    if (prioRuleGroupAttribute != 0) {</b>
<b class="nc">&nbsp;      prio = prioRuleGroupAttribute;</b>
&nbsp;    }
<b class="nc">&nbsp;    if (prioRuleAttribute != 0) {</b>
<b class="nc">&nbsp;      prio = prioRuleAttribute;</b>
&nbsp;    }
<b class="nc">&nbsp;    rule.setPriority(prio);</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private final Map&lt;String, URL&gt; internedUrls = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;  private URL internUrl(String s) throws MalformedURLException {
<b class="nc">&nbsp;    URL url = internedUrls.get(s);</b>
<b class="nc">&nbsp;    if (url == null) {</b>
<b class="nc">&nbsp;      url = new URL(s);</b>
<b class="nc">&nbsp;      internedUrls.put(s, url);</b>
&nbsp;    }
<b class="nc">&nbsp;    return url;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public void characters(char[] buf, int offset, int len) {
<b class="nc">&nbsp;    String s = new String(buf, offset, len);</b>
<b class="nc">&nbsp;    if (inException) {</b>
<b class="nc">&nbsp;      exceptions.append(s);</b>
<b class="nc">&nbsp;    } else if (inToken) {</b>
<b class="nc">&nbsp;      elements.append(s);</b>
<b class="nc">&nbsp;    } else if (inCorrectExample) {</b>
<b class="nc">&nbsp;      correctExample.append(s);</b>
<b class="nc">&nbsp;    } else if (inAntiPatternExample) {</b>
<b class="nc">&nbsp;      antiPatternExample.append(s);</b>
<b class="nc">&nbsp;    } else if (inAntiPatternForRuleGroupExample) {</b>
<b class="nc">&nbsp;      antiPatternForRuleGroupExample.append(s);</b>
<b class="nc">&nbsp;    } else if (inIncorrectExample) {</b>
<b class="nc">&nbsp;      incorrectExample.append(s);</b>
<b class="nc">&nbsp;    } else if (inErrorTriggerExample) {</b>
<b class="nc">&nbsp;      errorTriggerExample.append(s);</b>
<b class="nc">&nbsp;    } else if (inMatch) {</b>
<b class="nc">&nbsp;      match.append(s);</b>
<b class="nc">&nbsp;    } else if (inMessage) {</b>
<b class="nc">&nbsp;      message.append(s);</b>
<b class="nc">&nbsp;    } else if (inSuggestion) {  //Suggestion outside message</b>
<b class="nc">&nbsp;      suggestionsOutMsg.append(s);</b>
<b class="nc">&nbsp;    } else if (inShortMessage) {</b>
<b class="nc">&nbsp;      shortMessage.append(s);</b>
<b class="nc">&nbsp;    } else if (inShortMessageForRuleGroup) {</b>
<b class="nc">&nbsp;      shortMessageForRuleGroup.append(s);</b>
<b class="nc">&nbsp;    } else if (inUrl) {</b>
<b class="nc">&nbsp;      url.append(s);</b>
<b class="nc">&nbsp;    } else if (inUrlForRuleGroup) {</b>
<b class="nc">&nbsp;      urlForRuleGroup.append(s);</b>
<b class="nc">&nbsp;    } else if (inRegex) {</b>
<b class="nc">&nbsp;      regex.append(s);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-02-17 23:47</div>
</div>
</body>
</html>
